<!doctype html><html lang=en><head><title>M365 Business Premium Part 7: Intune Autopilot Deployment Walkthrough :: HalfOnCloud</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="An end-to-end walkthrough of Windows Autopilot deployment with Intune, highlighting real world configuration decisions, troubleshooting insights and field-tested best practices."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://halfoncloud.com/posts/m365-business-premium-part-7-intune-autopilot/><link rel=stylesheet href=https://halfoncloud.com/css/buttons.min.86f6b4c106b6c6eb690ae5203d36b442c1f66f718ff4e8164fa86cf6c61ad641.css><link rel=stylesheet href=https://halfoncloud.com/css/code.min.d529ea4b2fb8d34328d7d31afc5466d5f7bc2f0bc9abdd98b69385335d7baee4.css><link rel=stylesheet href=https://halfoncloud.com/css/fonts.min.5bb7ed13e1d00d8ff39ea84af26737007eb5051b157b86fc24487c94f3dc8bbe.css><link rel=stylesheet href=https://halfoncloud.com/css/footer.min.eb8dfc2c6a7eafa36cd3ba92d63e69e849e2200e0002a228d137f236b09ecd75.css><link rel=stylesheet href=https://halfoncloud.com/css/gist.min.a751e8b0abe1ba8bc53ced52a38b19d8950fe78ca29454ea8c2595cf26aad5c0.css><link rel=stylesheet href=https://halfoncloud.com/css/header.min.75c7eb0e2872d95ff48109c6647d0223a38db52e2561dd87966eb5fc7c6bdac6.css><link rel=stylesheet href=https://halfoncloud.com/css/main.min.36833afd348409fc6c3d09d0897c5833d9d5bf1ff31f5e60ea3ee42ce2b1268c.css><link rel=stylesheet href=https://halfoncloud.com/css/menu.min.3c17467ebeb3d38663dce68f71f519901124fa5cbb4519b2fb0667a21e9aca39.css><link rel=stylesheet href=https://halfoncloud.com/css/pagination.min.bbb986dbce00a5ce5aca0504b7925fc1c581992a4bf57f163e5d69cc1db7d836.css><link rel=stylesheet href=https://halfoncloud.com/css/post.min.e6dddd258e64c83e05cec0cd49c05216742d42fc8ecbfbe6b67083412b609bd3.css><link rel=stylesheet href=https://halfoncloud.com/css/syntax.min.a0773cce9310cb6d8ed23e50f005448facf29a53001b57e038828daa466b25c0.css><link rel=stylesheet href=https://halfoncloud.com/css/terminal.min.e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855.css><link rel=stylesheet href=https://halfoncloud.com/css/terms.min.b81791663c3790e738e571cdbf802312390d30e4b1d8dc9d814a5b5454d0ac11.css><link rel=stylesheet href=https://halfoncloud.com/style.css><link rel="shortcut icon" href=https://halfoncloud.com/favicon.png><link rel=apple-touch-icon href=https://halfoncloud.com/apple-touch-icon.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="M365 Business Premium Part 7: Intune Autopilot Deployment Walkthrough"><meta property="og:description" content="An end-to-end walkthrough of Windows Autopilot deployment with Intune, highlighting real world configuration decisions, troubleshooting insights and field-tested best practices."><meta property="og:url" content="https://halfoncloud.com/posts/m365-business-premium-part-7-intune-autopilot/"><meta property="og:site_name" content="HalfOnCloud"><meta property="og:image" content="https://halfoncloud.com/og-image.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:section" content="Cloud"><meta property="article:published_time" content="2026-02-04 00:00:00 +0000 UTC"><script async src="https://www.googletagmanager.com/gtag/js?id=G-9NQJGGWW9C"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-9NQJGGWW9C")</script><link rel=alternate type=application/rss+xml title=HalfOnCloud href=/index.xml><script type=application/ld+json>{"@context":"https://schema.org","@type":"TechArticle","headline":"M365 Business Premium Part 7: Intune Autopilot Deployment Walkthrough","description":"An end-to-end walkthrough of Windows Autopilot deployment with Intune, highlighting real world configuration decisions, troubleshooting insights and field-tested best practices.","author":{"@type":"Person","name":"Radu Bogdan"},"datePublished":"2026-02-04","dateModified":"2026-02-04","url":"https://halfoncloud.com/posts/m365-business-premium-part-7-intune-autopilot/","publisher":{"@type":"Organization","name":"HalfOnCloud"},"keywords":["MSIntune","EntraID","Autopilot"],"wordCount":6142,"timeRequired":"PT29M"}</script><style>body{font-family:-apple-system,BlinkMacSystemFont,segoe ui,Roboto,helvetica neue,Arial,sans-serif!important;font-size:1.05rem!important}h1,h2,h3,h4,h5,h6{font-family:-apple-system,BlinkMacSystemFont,segoe ui,Roboto,helvetica neue,Arial,sans-serif!important;font-weight:700!important}article h1,article h2,article h3,article.post h1,article.post h2,article.post h3,.content h1,.content h2,.content h3{color:#4a9eff!important;border-bottom:none!important}article.post .post-title{color:#4a9eff!important;border-bottom:none!important}article.post .post-title a{color:#4a9eff!important}.logo{background:0 0!important;padding-left:0!important;margin-left:0!important}.header__logo::after{margin-left:10px;background:repeating-linear-gradient(90deg,#4a9eff,#4a9eff 2px,transparent 0,transparent 10px)!important}img{border:none!important}article a,.post-content a{color:#4a9eff!important}article a:hover,.post-content a:hover{color:#6bb3ff!important}body,html{background-color:#1a1d2e!important}.header{margin-bottom:30px!important}.post.on-list{background:#363636;padding:20px;margin-bottom:20px;border-radius:8px}.post-title a{font-size:1.4rem!important;color:#4a9eff!important}.post-title{border-bottom:none!important;padding-bottom:0!important}.post-title::after,h1::after,h2::after,h3::after{display:none!important}.post-tags{color:#4a9eff!important}.post-tags a{color:#4a9eff!important}.post-tags a:hover{color:#6bb0ff!important}.navigation-menu a{color:#4a9eff!important}.navigation-menu a:hover{color:#6bb0ff!important}.menu__trigger{color:#4a9eff!important;border:2px solid #4a9eff!important;background-color:transparent!important}.menu__dropdown{background-color:#363636!important;border:2px solid #4a9eff!important}.menu__dropdown a{color:#4a9eff!important}.menu__dropdown a:hover{color:#6bb0ff!important;background-color:#404040!important}.read-more.button{display:inline-block!important;background-color:#4a9eff!important;color:#fff!important;padding:8px 18px!important;border-radius:28px!important;text-decoration:none!important;font-weight:600!important;transition:all .3s ease!important;border:none!important;font-size:0!important}.read-more.button::after{content:"Read More →"!important;font-size:.99rem!important;display:inline-block}.read-more.button:hover{background-color:#6bb0ff!important;transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,.2)}article ul,.post-content ul{list-style:none!important}article ul li,.post-content ul li{position:relative!important;padding-left:1.2em!important}article ul li::before,.post-content ul li::before{content:"●"!important;position:absolute!important;left:0!important;color:#4a9eff!important;font-weight:700!important}article ul ul li::before,.post-content ul ul li::before{content:"○"!important;color:#4a9eff!important}.sidebar-left ul li::before,.sidebar-right ul li::before,.sidebar-nav ul li::before,.widget-list li::before{content:none!important;display:none!important}.sidebar-left ul li,.sidebar-right ul li,.sidebar-nav ul li,.widget-list li{padding-left:0!important}.heading-link,.anchor,.zola-anchor,h1 a.anchor,h2 a.anchor,h3 a.anchor,h1>a[href^="#"],h2>a[href^="#"],h3>a[href^="#"]{display:none!important;visibility:hidden!important}.sidebar-nav a{font-weight:700!important}.sidebar-title{font-size:1.8rem!important}body.three-column-layout{display:flex;min-height:100vh;margin:0;padding:0}.sidebar-left{width:250px;min-width:250px;background-color:#13151f;border-right:1px solid #2a2d3e;position:fixed;left:0;top:0;height:100vh;overflow-y:auto;z-index:100}.sidebar-left__inner{padding:30px 20px;display:flex;flex-direction:column;align-items:center}.sidebar-avatar{margin-bottom:15px}.avatar-img{width:120px;height:120px;border-radius:50%;object-fit:cover;border:3px solid #4a9eff}.avatar-placeholder{width:120px;height:120px;border-radius:50%;background:linear-gradient(135deg,#4a9eff 0%,#6bb0ff 100%);display:flex;align-items:center;justify-content:center;font-size:3rem;font-weight:700;color:#fff}.sidebar-title{font-size:1.5rem;margin:10px 0 5px;text-align:center}.sidebar-title a{color:#fff;text-decoration:none}.sidebar-title .red{color:#f44}.sidebar-tagline{font-size:.85rem;color:#888;text-align:center;margin:0 0 25px;line-height:1.4}.sidebar-nav ul{list-style:none;padding:0;margin:0;width:100%}.sidebar-nav li{margin:5px 0}.sidebar-nav a{display:flex;align-items:center;gap:12px;padding:12px 20px;color:#ccc;text-decoration:none;border-radius:8px;transition:all .2s ease;font-size:.95rem}.sidebar-nav a:hover{background-color:#2a2d3e;color:#4a9eff}.sidebar-nav li.active a{background-color:#4a9eff;color:#fff}.sidebar-nav svg{flex-shrink:0}.main-wrapper{flex:1;margin-left:250px;margin-right:280px;min-height:100vh;padding:30px 40px;max-width:950px}.sidebar-right{width:280px;min-width:280px;background-color:#151822;border-left:1px solid #2a2d3e;position:fixed;right:0;top:0;height:100vh;overflow-y:auto;z-index:100}.sidebar-right__inner{padding:30px 20px}.widget{margin-bottom:30px}.widget-title{font-size:1rem;color:#fff;margin:0 0 15px;padding-bottom:10px;border-bottom:1px solid #2a2d3e}.widget-list{list-style:none;padding:0;margin:0}.widget-list li{margin:8px 0}.widget-list a{color:#ccc;text-decoration:none;font-size:.9rem;display:block;padding:5px 0;transition:color .2s ease}.widget-list a:hover{color:#4a9eff}.widget-tags{display:flex;flex-wrap:wrap;gap:8px}.widget-tag{display:inline-block;padding:5px 12px;background-color:#2a2d3e;color:#ccc;text-decoration:none;border-radius:15px;font-size:.8rem;transition:all .2s ease}.widget-tag:hover{background-color:#4a9eff;color:#fff}.widget-tag .count{margin-left:5px;opacity:.7}.archives h1{color:#4a9eff;margin-bottom:30px}.archive-year h2{color:#4a9eff;font-size:1.3rem;margin:25px 0 15px;padding-left:10px;border-left:3px solid #4a9eff}.archive-posts{list-style:none;padding:0;margin:0}.archive-posts li{padding:8px 0;display:flex;align-items:center;gap:15px}.archive-date{color:#888;font-size:.85rem;min-width:60px}.archive-posts a{color:#ccc;text-decoration:none}.archive-posts a:hover{color:#4a9eff}body.three-column-layout .header{display:none}@media(max-width:1200px){.sidebar-right{display:none}.main-wrapper{margin-right:0}}@media(max-width:768px){body.three-column-layout{flex-direction:column}.sidebar-left{width:100%;min-width:100%;position:relative;height:auto;border-right:none;border-bottom:1px solid #2a2d3e}.sidebar-left__inner{padding:20px;height:auto}.sidebar-nav ul{display:flex;flex-wrap:wrap;justify-content:center;gap:5px}.sidebar-nav a{padding:8px 15px}.avatar-img,.avatar-placeholder{width:80px;height:80px;font-size:2rem}.main-wrapper{margin-left:0;padding:20px}.sidebar-right{display:none}.sidebar-social{position:relative;bottom:auto;margin-top:15px}}@media(max-width:768px){.sidebar-social{position:relative!important;bottom:auto!important;width:100%!important;margin-top:20px!important;padding-top:15px!important;border-top:1px solid #2a2d3e}.sidebar-nav ul{width:100%}}@media(max-width:768px){.main-wrapper{overflow-x:hidden!important;max-width:100vw!important}article img,.post-content img,.content img{max-width:100%!important;height:auto!important}pre,code{max-width:100%!important;overflow-x:auto!important;white-space:pre-wrap!important;word-wrap:break-word!important}.post-title,article h1,article h2{word-wrap:break-word!important;overflow-wrap:break-word!important}}.search-widget{margin-bottom:25px}.search-box{position:relative;display:flex;align-items:center}.search-icon{position:absolute;left:12px;color:#888;pointer-events:none}#search-input{width:100%;padding:12px 15px 12px 40px;background-color:#2a2d3e;border:1px solid #3a3d4e;border-radius:8px;color:#fff;font-size:.9rem;outline:none;transition:all .2s ease}#search-input:focus{border-color:#4a9eff;box-shadow:0 0 0 3px rgba(74,158,255,.2)}#search-input::placeholder{color:#666}#search-results{margin-top:10px;max-height:400px;overflow-y:auto}#search-results:empty{display:none}.search-result-item{padding:10px;margin:5px 0;background-color:#2a2d3e;border-radius:6px;transition:background-color .2s ease}.search-result-item:hover{background-color:#3a3d4e}.search-result-item a{color:#4a9eff;text-decoration:none;font-size:.9rem;display:block}.search-result-item .search-date{font-size:.75rem;color:#888;margin-top:3px}.search-result-item .search-snippet{font-size:.8rem;color:#aaa;margin-top:5px;line-height:1.4}.search-no-results{color:#888;font-size:.85rem;padding:10px;text-align:center}.post-featured-image{margin:20px 0 30px;border-radius:8px;overflow:hidden}.post-featured-image img{width:100%;height:auto;display:block}.terms h1{color:#4a9eff!important;margin-bottom:20px}.terms ul{list-style:none!important;padding:0;margin:0}.terms li{margin:12px 0;display:flex;align-items:center;gap:10px}.terms li::before{display:none!important;content:none!important}.terms li svg{color:#4a9eff!important;flex-shrink:0}.terms a,.terms li a,.terms ul li a{color:#4a9eff!important;text-decoration:none!important;font-size:1.1rem;transition:color .2s ease}.terms a:hover,.terms li a:hover,.terms ul li a:hover{color:#6bb0ff!important}.main-wrapper{margin:0 auto!important}.avatar-img{width:300px!important;height:auto!important;border-radius:20px!important;object-fit:contain!important}.sidebar-social{display:flex;gap:15px;justify-content:center;position:absolute;bottom:30px;left:0;right:0}.sidebar-social a{color:#888;transition:color .2s ease}.sidebar-social a:hover{color:#4a9eff}blockquote{border-left:4px solid red!important;background-color:rgba(255,107,107,3%)!important;background-color:transparent!important;margin:1.5em 0!important;padding:15px 20px!important;border-radius:0 8px 8px 0!important;color:#ccc!important;border-top:none!important;border-right:none!important;border-bottom:none!important}blockquote p{margin:0!important}blockquote::before{content:none!important;display:none!important}pre{white-space:pre-wrap!important;word-wrap:break-word!important;overflow-x:hidden!important}pre code{white-space:pre-wrap!important;word-wrap:break-word!important}table,th,td{border-width:2px!important;border-color:#2a2d3e!important}</style></head><body class=three-column-layout><aside class=sidebar-left><div class=sidebar-left__inner><div class=sidebar-avatar><a href=https://halfoncloud.com/><img src=/images/avatar.png alt=HalfOnCloud class=avatar-img></a></div><h2 class=sidebar-title><a href=https://halfoncloud.com/>Half<span class=red>On</span>Cloud</a></h2><p class=sidebar-tagline>IT tutorials, automation scripts, and real-world solutions</p><nav class=sidebar-nav><ul><li><a href=https://halfoncloud.com/><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
Home</a></li><li><a href=https://halfoncloud.com/categories/><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>
Categories</a></li><li><a href=https://halfoncloud.com/tags/><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
Tags</a></li><li><a href=https://halfoncloud.com/archives/><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
Archives</a></li><li><a href=https://halfoncloud.com/about/><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
About</a></li></ul></nav><div class=sidebar-social><a href=https://x.com/HeyRadu target=_blank rel=noopener title=X/Twitter><svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
</a><a href=https://linkedin.com/in/radu-bogdan target=_blank rel=noopener title=LinkedIn><svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853.0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601.0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144.0-2.063-.926-2.063-2.065.0-1.138.92-2.063 2.063-2.063 1.14.0 2.064.925 2.064 2.063.0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225.0H1.771C.792.0.0.774.0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2.0 22.222.0h.003z"/></svg></a></div></div></aside><aside class=sidebar-right><div class=sidebar-right__inner><div class="widget search-widget"><div class=search-box><svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
<input type=text id=search-input placeholder=Search... autocomplete=off></div><div id=search-results></div></div><div class=widget><h3 class=widget-title>Recent Posts</h3><ul class=widget-list><li><a href=https://halfoncloud.com/posts/m365-business-premium-part-8-anatomy-of-a-failed-enrollment-tracing-an-esp-error-from-screen-to-root-cause/>M365 Business Premium Part 8: Anatomy of a Failed Enrollment - Tracing an ESP Error from Screen to Root Cause</a></li><li><a href=https://halfoncloud.com/posts/m365-business-premium-part-7-intune-autopilot/>M365 Business Premium Part 7: Intune Autopilot Deployment Walkthrough</a></li><li><a href=https://halfoncloud.com/posts/m365-business-premium-part-6-intune-best-practices-device-management-foundations/>M365 Business Premium Part 6: Building the Intune Foundation for Autopilot</a></li><li><a href=https://halfoncloud.com/posts/powershell-script-installer-for-win32-part2-m365-apps-and-delivery-optimization/>M365 Apps Deployment with PowerShell Installer & Delivery Optimization Gotchas</a></li><li><a href=https://halfoncloud.com/posts/m365-business-premium-part-5-intune-conditional-access-policies/>M365 Business Premium Part 5: Conditional Access Policies</a></li></ul></div><div class=widget><h3 class=widget-title>Categories</h3><div class=widget-tags><a href=https://halfoncloud.com/categories/%23deliveryoptimization/ class=widget-tag>#DeliveryOptimization <span class=count>1</span>
</a><a href=https://halfoncloud.com/categories/%23m365apps/ class=widget-tag>#M365Apps <span class=count>1</span>
</a><a href=https://halfoncloud.com/categories/%23msintune/ class=widget-tag>#MSIntune  <span class=count>1</span>
</a><a href=https://halfoncloud.com/categories/%23powershell/ class=widget-tag>#PowerShell <span class=count>1</span>
</a><a href=https://halfoncloud.com/categories/%23win32/ class=widget-tag>#Win32  <span class=count>1</span>
</a><a href=https://halfoncloud.com/categories/cloud/ class=widget-tag>Cloud <span class=count>11</span>
</a><a href=https://halfoncloud.com/categories/general/ class=widget-tag>General <span class=count>1</span></a></div></div><div class=widget><h3 class=widget-title>Tags</h3><div class=widget-tags><a href=https://halfoncloud.com/tags/about/ class=widget-tag>About <span class=count>1</span>
</a><a href=https://halfoncloud.com/tags/autopilot/ class=widget-tag>Autopilot <span class=count>2</span>
</a><a href=https://halfoncloud.com/tags/compliancepolicies/ class=widget-tag>CompliancePolicies <span class=count>1</span>
</a><a href=https://halfoncloud.com/tags/configurationprofiles/ class=widget-tag>ConfigurationProfiles <span class=count>1</span>
</a><a href=https://halfoncloud.com/tags/ddm/ class=widget-tag>DDM <span class=count>1</span>
</a><a href=https://halfoncloud.com/tags/devicemanagement/ class=widget-tag>DeviceManagement <span class=count>1</span>
</a><a href=https://halfoncloud.com/tags/entraid/ class=widget-tag>EntraID <span class=count>6</span>
</a><a href=https://halfoncloud.com/tags/esp/ class=widget-tag>ESP <span class=count>1</span>
</a><a href=https://halfoncloud.com/tags/licensing/ class=widget-tag>Licensing <span class=count>3</span>
</a><a href=https://halfoncloud.com/tags/m365/ class=widget-tag>M365 <span class=count>5</span>
</a><a href=https://halfoncloud.com/tags/mmp-c/ class=widget-tag>MMP-C <span class=count>1</span>
</a><a href=https://halfoncloud.com/tags/msintune/ class=widget-tag>MSIntune <span class=count>12</span>
</a><a href=https://halfoncloud.com/tags/powershell/ class=widget-tag>PowerShell <span class=count>2</span>
</a><a href=https://halfoncloud.com/tags/security/ class=widget-tag>Security <span class=count>1</span>
</a><a href=https://halfoncloud.com/tags/win32/ class=widget-tag>Win32 <span class=count>2</span>
</a><a href=https://halfoncloud.com/tags/win32apps/ class=widget-tag>Win32Apps <span class=count>1</span>
</a><a href=https://halfoncloud.com/tags/windc/ class=widget-tag>WinDC <span class=count>1</span></a></div></div></div></aside><div class=main-wrapper><div class=content><article class=post><header class=post-header><h1 class=post-title>M365 Business Premium Part 7: Intune Autopilot Deployment Walkthrough</h1><div class=post-meta><time class=post-date>2026-02-04 · 29 min read</time>
<span class=post-author>Radu Bogdan</span></div><span class=post-tags>#<a href=https://halfoncloud.com/tags/msintune/>MSIntune</a>&nbsp;
#<a href=https://halfoncloud.com/tags/entraid/>EntraID</a>&nbsp;
#<a href=https://halfoncloud.com/tags/autopilot/>Autopilot</a>&nbsp;</span></header><div class=post-content><h2 id=what-is-windows-autopilot>What is Windows Autopilot?</h2><p>This walkthrough assumes the tenant foundation is already in place. If you&rsquo;re starting fresh <a href=https://halfoncloud.com/posts/m365-business-premium-part-6-intune-best-practices-device-management-foundations/>Part 6</a> covers the enrollment controls, compliance baseline and ESP configuration that make this deployment easy to follow-up.</p><p>Windows Autopilot is Microsoft&rsquo;s cloud-based provisioning service that simplifies how organizations deploy Windows devices. Instead of manually imaging each endpoint, Autopilot leverages the factory installed Windows image and orchestrates device setup through Microsoft Intune and Microsoft Entra ID.</p><p>When a user powers on a new device and connects to the internet, Autopilot takes over the Out-of-Box Experience, the device automatically joins Microsoft Entra ID, enrolls in Intune, receives assigned policies and applications and lands on a fully configured desktop, all without IT ever touching the hardware. OEMs and resellers can also register hardware hashes directly to an organization&rsquo;s tenant, enabling true ship-to-user deployment scenarios.</p><p>This article covers <em>two</em> valid ways to register a device for Windows Autopilot.<br>The first is the traditional post-install method where the hardware hash is captured from a fully installed Windows desktop, the second is an alternative pre-OOBE approach that captures and uploads the hash earlier in the process.</p><p>Both methods work, the difference is where in the deployment lifecycle the registration happens and what trade-offs you’re willing to make.</p><h2 id=credits-and-references>Credits and References</h2><p>The method I use in this article didn&rsquo;t come from nowhere, it&rsquo;s built on the work of several community members who documented their findings and shared them openly:</p><p><strong>Michael Niehaus</strong> - <a href=https://oofhours.com/2022/08/02/connecting-the-dots-reverse-engineering-an-autopilot-hash/>Connect the dots: Reverse-engineering an Autopilot hash</a> (August 2022) Took apart the hardware hash structure byte by byte, explaining what&rsquo;s actually inside that 4000-character Base64 string. Essential reading for understanding why certain capture methods work and others don&rsquo;t.</p><p><strong>Michael Mardahl</strong> - <a href=https://mikemdm.de/2023/01/29/can-you-create-a-autopilot-hash-from-winpe-yes/>Can you create a Autopilot Hash from WinPE? Yes!</a> (January 2023) First showed that WinPE hash capture was possible using OA3Tool from the Windows ADK and documented the PCPKsp.dll requirement for TPM access.</p><p><strong>Johannes Bedrech</strong> - <a href=https://epm-blog.com/2024/03/22/how-to-silently-create-an-autopilot-hardware-hash-in-winpe-and-upload-the-hash-unattended-using-symantec-itms/>How to silently create an Autopilot Hardware Hash in WinPE and upload the Hash unattended</a> (March 2024) Demonstrated unattended hash upload using Graph API with app registration, proving that the entire process could be automated without interactive login.</p><p>Their collective work gave me the foundation to develop an approach that fits my lab environment, if you&rsquo;re interested in the deeper technical details or want to build something more advanced, start with their articles too.</p><h3 id=two-versions-one-goal>Two Versions, One Goal</h3><p>With the introduction of <strong>Windows Autopilot Device Preparation</strong> (commonly called Autopilot v2) in mid-2024, there are now two different provisioning architectures available. This environment uses <strong>Autopilot v1</strong> and here&rsquo;s why.</p><p>Autopilot v2 brings genuine improvements: better reporting with direct client telemetry, enrollment time grouping that speeds up device registration and intelligent app sequencing that installs non-blocking apps in the background. The architecture is modern and the reporting is noticeably more accurate. Microsoft has recently increased the OOBE app limit from 10 to 25 (January 30, 2026), addressing one of the original deployment constraints.</p><p>As of early 2026, several promised features are still not available. Pre-provisioning (White Glove), self-deploying mode, hybrid Azure AD join, OOBE customization and device naming control are still missing, Microsoft&rsquo;s FAQ says these will be supported &ldquo;in the future&rdquo; the same language used at launch.</p><p>The original 10-app blocking limit during OOBE was a deliberate design choice. Microsoft&rsquo;s telemetry showed 90% of deployments use 10 or fewer apps and the limit improved stability. The philosophy made sense: install essential apps during provisioning, deliver everything else once the user reaches the desktop. The new <em>25 app</em> limit acknowledges that enterprise environments often need more flexibility, though Microsoft still recommends reviewing timeout settings when deploying larger app payloads.</p><p>What&rsquo;s harder to work around is local troubleshooting, in <em>v1</em> pressing <strong>Ctrl+Shift+D</strong> during the Enrollment Status Page opens a diagnostics view showing exactly what&rsquo;s happening: which policies are applying, which apps are installing, where things are stuck but in <em>v2</em> that doesn&rsquo;t exist. The community diagnostic scripts don&rsquo;t work with the new architecture either. Troubleshooting means checking the Intune portal remotely, which isn&rsquo;t always practical when a technician is standing in front of a stuck device.</p><h3 id=the-decision-for-this-environment>The Decision for This Environment</h3><p>This environment is intentionally scoped as a lab and learning platform. The goal here is speed, repeatability and understanding how Autopilot behaves, not fully unattended factory-scale automation. In large enterprise deployments different trade-offs are often justified due to scale and operational complexity. However for learning scenarios and smaller lab environments like mine, prioritizing simplicity typically leads to faster troubleshooting and an overall smoother deployment experience.</p><p>In my Intune tenant I&rsquo;m using Autopilot <em>v1</em> with user-driven Microsoft Entra join, device naming templates and an ESP configuration. The requirements here include device naming control, reliable local troubleshooting during pilot testing and the flexibility that comes with a mature, well-documented provisioning method.</p><p>The door remains open to revisit v2 once Microsoft delivers the promised features, until then v1 remains the practical choice for production workloads.</p><p>Microsoft&rsquo;s documentation makes Autopilot sound simple: register a hardware hash, assign a profile and ship the device but what they don&rsquo;t emphasize enough is how that hash gets there in the first place.</p><p>Large enterprises have it easy: Dell, HP and Lenovo will pre-register hashes at the factory for a fee (or included in enterprise contracts) then devices arrive in Intune before they leave the warehouse, zero IT effort zero hassle.</p><p>The rest of us? We&rsquo;re left with the &ldquo;traditional&rdquo; method: install Windows, complete OOBE, run PowerShell scripts, upload a CSV, wait for sync, then reset the entire device just to trigger Autopilot. For a single laptop that&rsquo;s 30-45 minutes of work. For a fleet of 50? Well&mldr;</p><h3 id=five-ways-to-get-a-hash-into-intune>Five Ways to Get a Hash Into Intune</h3><table><thead><tr><th>Method</th><th>Best For</th><th>Trade-off</th></tr></thead><tbody><tr><td><strong>OEM Pre-Registration</strong></td><td>Enterprises with vendor contracts</td><td>Per-device fees, must order through specific channels</td></tr><tr><td><strong>SCCM Built-in Report</strong></td><td>Organizations migrating from ConfigMgr</td><td>Devices must already be SCCM-managed</td></tr><tr><td><strong>Post-Install PowerShell</strong></td><td>One-off devices, quick testing</td><td>Requires device reset after registration</td></tr><tr><td><strong>WinPE/Custom ISO</strong></td><td>SMBs, consultants, labs, refurbished devices</td><td>Unofficial method (but proven at scale)</td></tr><tr><td><strong>Autopilot Device Preparation (v2)</strong></td><td>Future-forward Windows 11 environments</td><td>No Hybrid Join, limited features (for now)</td></tr></tbody></table><p>There&rsquo;s yet another option that sits in the gap between &ldquo;pay Dell to do it&rdquo; and &ldquo;waste an hour per device.&rdquo;</p><p>It’s important to be clear about support boundaries, this approach uses supported Microsoft tools and APIs but combines them in a way that isn’t explicitly documented by Microsoft for Autopilot registration. While not officially endorsed, it has been used reliably by the community at scale for several years.</p><p>The practical impact of this is simple: Autopilot is ready before OOBE starts. There’s no need to complete setup, upload a CSV, wait for sync and then reset the device, the deployment happens in a single pass.</p><p>Mike Terrill from MDM Tech Space put it best: <em>&ldquo;We are using this method now for more than 4 years and more than 15,000 devices without any issues.&rdquo;</em> Microsoft may not officially endorse it, but 15,000 successful deployments speaks for itself.</p><h3 id=who-actually-needs-this>Who Actually Needs This?</h3><p>Not everyone! If you&rsquo;re ordering 500 laptops from Dell with an enterprise agreement, let them handle registration. If you&rsquo;re running SCCM, the built-in Autopilot report already has your hashes.</p><p>But if you&rsquo;re:</p><ul><li>A consultant deploying across multiple client tenants</li><li>An SMB buying devices from Best Buy or Amazon</li><li>Running a lab environment with VMs that get rebuilt weekly</li><li>Handling refurbished or donated hardware</li><li>Supporting remote offices where shipping devices to HQ isn&rsquo;t practical</li></ul><p>&mldr;then the OEM path doesn&rsquo;t exist for you and the post-install-then-reset dance gets old fast.</p><h2 id=how-my-approach-differs>How My Approach Differs</h2><p>This method is simpler built for a lab environment where speed and repeatability matter more than automation at scale.</p><table><thead><tr><th>Aspect</th><th>Community Methods</th><th>My Approach</th></tr></thead><tbody><tr><td><strong>Environment</strong></td><td>Custom WinPE, SCCM Task Sequences, Symantec ITMS</td><td>VMware Workstation with standard Windows 11 ISO</td></tr><tr><td><strong>Hash Capture</strong></td><td>OA3Tool in WinPE before OS install</td><td><em>Get-WindowsAutoPilotInfo</em> after OS install</td></tr><tr><td><strong>Authentication</strong></td><td>App Registration with client secret (unattended)</td><td>Interactive sign-in with <em>-Online</em> parameter</td></tr><tr><td><strong>Upload Method</strong></td><td>Custom PowerShell scripts calling Graph API</td><td>Built-in script handles everything</td></tr><tr><td><strong>Infrastructure</strong></td><td>Requires ADK, custom ISO builds or deployment tools</td><td>No extra tools beyond the VM and PowerShell</td></tr><tr><td><strong>Target Use Case</strong></td><td>Enterprise deployment at scale</td><td>Lab testing, learning, small environments</td></tr></tbody></table><h3 id=selecting-the-right-level-of-complexity>Selecting the Right Level of Complexity</h3><p>The community approaches highlighted earlier solve real enterprise challenges: zero-touch deployment, deep tooling integration and fully unattended authentication workflows designed for scale.</p><p>My environment has different priorities, it’s a controlled lab focused on testing configurations, validating behavior and building operational understanding rather than provisioning hundreds of devices.</p><p>In this context simplicity is an advantage, three PowerShell commands and an interactive sign-in are enough to register the device in minutes, allowing the focus to remain on Autopilot behavior instead of deployment infrastructure.</p><h2 id=registering-the-device-for-autopilot>Registering the Device for Autopilot</h2><h3 id=the-traditional-method>The Traditional Method</h3><p>This is the approach I&rsquo;ve used most of the time: install Windows 11 first, create a local admin account, then capture the hardware hash from the desktop. It&rsquo;s not the fastest method available but it&rsquo;s reliable and doesn&rsquo;t require any additional infrastructure.</p><p>After quickly walking through this method, I&rsquo;ll share a newer approach I&rsquo;ve been exploring that simplifies the process further, for now here&rsquo;s the straightforward path.</p><p>Open PowerShell as Administrator and run these three commands:</p><p><em>Install-Script -Name Get-WindowsAutoPilotInfo -Force</em>
<em>Set-ExecutionPolicy RemoteSigned -Scope CurrentUser -Force</em>
<em>Get-WindowsAutoPilotInfo -Online -GroupTag &ldquo;A-RO-U-D-V&rdquo;</em></p><p>First-time authentication on a fresh device shows the &ldquo;Let&rsquo;s get you signed in&rdquo; dialog asking you to choose between Microsoft account or Work/school account. On devices where you&rsquo;ve previously authenticated, WAM remembers your account and shows &ldquo;Pick an account&rdquo; instead.</p><p><img src=/images/Blog_P16_183.jpg alt></p><blockquote><p>Note: As of December 2025 (Microsoft Graph PowerShell SDK v2.34) the authentication experience changed from browser-based to Windows Account Manager (WAM). You&rsquo;ll see a native Windows dialog asking to select &ldquo;Work or school account&rdquo; instead of a browser popup.</p></blockquote><p><img src=/images/Blog_P16_187.jpg alt></p><p>Once authenticated the script connects to Microsoft Graph, gathers the hardware details and uploads the hash to the Intune tenant. The process typically takes 2-4 minutes ending with a confirmation that the device was imported successfully:</p><p><img src=/images/Blog_P16_289.jpg alt></p><p>The device is now registered in Intune with Autopilot profile assigned:</p><p><img src=/images/Blog_P16_191.jpg alt></p><p>After the import completes reset the device (Reset this PC). On the next boot, Autopilot will recognize the hardware hash and apply the assigned deployment profile.</p><p>But you know that road, you know exactly where it ends and I know that is not where you want to be.</p><h3 id=the-alternative-method>The Alternative method</h3><p>Some guides recommend creating an App Registration with a client secret for unattended uploads, however this stores credentials in plain text, a security risk also flagged by <em>Michael Niehaus</em> in his article so instead I use <strong>Device Code Flow</strong> which authenticates via my phone each time, requiring no stored secrets.</p><p>This is a conscious trade-off, I’m choosing interactive authentication over full automation to avoid embedding long-lived credentials in scripts or media. In a lab environment requiring a human approval step is acceptable and significantly reduces risk.</p><p>Device Code Flow allows a script to authenticate to Microsoft Graph without storing any credentials. Instead of embedding a client secret, the script displays a one-time code and pauses until the admin signs in on another trusted device with MFA. A short-lived access token is issued only after approval, leaving no secrets embedded in the ISO or stored on the device.</p><p>These are the files originally created into my location &ldquo;<em>C:\AutopilotUSB</em>&rdquo; that get copied to the ISO:</p><table><thead><tr><th>File</th><th>Size</th><th>Purpose</th></tr></thead><tbody><tr><td>oa3tool.exe</td><td>454 KB</td><td>Microsoft OEM Activation tool (extracts hardware hash)</td></tr><tr><td>OA3.cfg</td><td>1 KB</td><td>Configuration file for oa3tool</td></tr><tr><td>PCPKsp.dll</td><td>1,148 KB</td><td>TPM Key Storage Provider for attestation</td></tr><tr><td>Create_4kHash_using_OA3_Tool.ps1</td><td>2 KB</td><td>Converts OA3.xml to Autopilot CSV format</td></tr><tr><td>Upload_AutopilotHash.ps1</td><td>5 KB</td><td>Uploads hash to Intune via Device Code Flow</td></tr><tr><td>CaptureHash.cmd</td><td>1 KB</td><td>Orchestrates the entire capture and upload process</td></tr></tbody></table><p><img src=/images/Blog_P15_001.jpg alt></p><h3 id=creating-the-staging-folder>Creating the staging folder:</h3><p>With these commands I&rsquo;ve created a staging folder called &ldquo;<em>C:\AutopilotUSB</em>&rdquo; to collect all the files needed for the custom ISO, then I&rsquo;ve copied <em>oa3tool.exe</em> from the Microsoft Windows Assessment and Deployment Kit (ADK) installation, this is Microsoft&rsquo;s OEM Activation 3.0 tool that extracts hardware identifiers from the device&rsquo;s SMBIOS and TPM to generate the Autopilot hash:</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-PowerShell data-lang=PowerShell><span style=display:flex><span>New-Item -Path <span style=color:#48b685>&#34;C:\AutopilotUSB&#34;</span> -ItemType Directory -Force
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Copy-Item <span style=color:#48b685>&#34;C:\Program Files (x86)\Windows Kits\10\Assessment and Deployment Kit\Deployment Tools\amd64\Licensing\OA30\oa3tool.exe&#34;</span> -Destination <span style=color:#48b685>&#34;C:\AutopilotUSB\&#34;</span>
</span></span></code></pre></div><p><img src=/images/Blog_P15_002.jpg alt></p><h3 id=creating-the-custom-oa3cfg-file>Creating the custom OA3.cfg file</h3><p>This configuration file tells <em>oa3tool.exe</em> where to write its output. The tool generates two files: <em>OA3.bin</em> (binary format used by OEMs for factory injection) and <em>OA3.xml</em> (XML containing the hardware hash). We only care about the XML file since that&rsquo;s what our PowerShell script will parse to extract the hash:</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cfg data-lang=cfg><span style=display:flex><span><span style=color:#06b6ef>&lt;OA3&gt;</span>
</span></span><span style=display:flex><span>   <span style=color:#06b6ef>&lt;FileBased&gt;</span>
</span></span><span style=display:flex><span>       <span style=color:#06b6ef>&lt;InputKeyXMLFile&gt;&#34;.\input.XML&#34;&lt;/InputKeyXMLFile&gt;</span>
</span></span><span style=display:flex><span>   <span style=color:#06b6ef>&lt;/FileBased&gt;</span>
</span></span><span style=display:flex><span>   <span style=color:#06b6ef>&lt;OutputData&gt;</span>
</span></span><span style=display:flex><span>       <span style=color:#06b6ef>&lt;AssembledBinaryFile&gt;.\OA3.bin&lt;/AssembledBinaryFile&gt;</span>
</span></span><span style=display:flex><span>       <span style=color:#06b6ef>&lt;ReportedXMLFile&gt;.\OA3.xml&lt;/ReportedXMLFile&gt;</span>
</span></span><span style=display:flex><span>   <span style=color:#06b6ef>&lt;/OutputData&gt;</span>
</span></span><span style=display:flex><span><span style=color:#06b6ef>&lt;/OA3&gt;</span>
</span></span></code></pre></div><h3 id=copying-pcpkspdll-from-system32>Copying PCPKsp.dll from System32</h3><p>With these commands I&rsquo;ve first verified that <em>PCPKsp.dll</em> exists in the System32 folder then copied it to my staging folder. This DLL is the Platform Crypto Provider Key Storage Provider, a dependency that oa3tool.exe needs to communicate with the TPM and extract attestation data. Without this file registered in WinPE the hardware hash generation fails silently.</p><p>At this point the staging folder contains three files: oa3tool.exe, OA3.cfg (which I created manually) and PCPKsp.dll. The remaining three files are PowerShell scripts that handle the CSV conversion and upload to Intune.</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-PowerShell data-lang=PowerShell><span style=display:flex><span>Test-Path <span style=color:#48b685>&#34;C:\Windows\System32\PCPKsp.dll&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Copy-Item <span style=color:#48b685>&#34;C:\Windows\System32\PCPKsp.dll&#34;</span> -Destination <span style=color:#48b685>&#34;C:\AutopilotUSB\&#34;</span> -Force
</span></span></code></pre></div><p><img src=/images/Blog_P15_005.jpg alt></p><h3 id=creating-the-custom-ps-script-create_4khash_using_oa3_toolps1>Creating the custom PS script &ldquo;Create_4kHash_using_OA3_Tool.ps1&rdquo;</h3><p>This new custom PS script bridges the gap between oa3tool.exe output and what Intune expects. The OA3 tool generates an XML file with the hardware hash buried inside XML nodes. This script extracts the hash and serial number, then formats them into the exact CSV structure that Intune&rsquo;s Autopilot import API requires: three columns with Device Serial Number, Windows Product ID (left empty) and Hardware Hash. Without this conversion step, you&rsquo;d be manually copy-pasting Base64 strings.</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-PowerShell data-lang=PowerShell><span style=display:flex><span><span style=color:#815ba4>param</span>(
</span></span><span style=display:flex><span>    [Parameter(<span style=color:#06b6ef>Mandatory</span>=<span style=color:#ef6155>$false</span>)]
</span></span><span style=display:flex><span>    [<span style=color:#ef6155>string</span>]<span style=color:#ef6155>$OutputFile</span> = <span style=color:#48b685>&#34;.\AutopilotHash.csv&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ef6155>$ScriptDir</span> = Split-Path -Parent <span style=color:#ef6155>$MyInvocation</span>.MyCommand.Path
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#776e71># Check if OA3.xml exists (generated by oa3tool.exe)</span>
</span></span><span style=display:flex><span><span style=color:#ef6155>$OA3XML</span> = Join-Path <span style=color:#ef6155>$ScriptDir</span> <span style=color:#48b685>&#34;OA3.xml&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#815ba4>if</span> (<span style=color:#5bc4bf>-not</span> (Test-Path <span style=color:#ef6155>$OA3XML</span>)) {
</span></span><span style=display:flex><span>    Write-Error <span style=color:#48b685>&#34;OA3.xml not found. Run oa3tool.exe first!&#34;</span>
</span></span><span style=display:flex><span>    exit <span style=color:#f99b15>1</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#776e71># Parse the XML</span>
</span></span><span style=display:flex><span>[<span style=color:#ef6155>xml</span>]<span style=color:#ef6155>$xml</span> = Get-Content <span style=color:#ef6155>$OA3XML</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#776e71># Extract values</span>
</span></span><span style=display:flex><span><span style=color:#ef6155>$HardwareHash</span> = <span style=color:#ef6155>$xml</span>.Key.HardwareHash
</span></span><span style=display:flex><span><span style=color:#ef6155>$SerialNumber</span> = <span style=color:#ef6155>$xml</span>.Key.ProductKeyInfo.SmbiosSystemSerialNumber
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#815ba4>if</span> ([<span style=color:#ef6155>string</span>]::IsNullOrEmpty(<span style=color:#ef6155>$HardwareHash</span>)) {
</span></span><span style=display:flex><span>    Write-Error <span style=color:#48b685>&#34;Hardware hash not found in OA3.xml&#34;</span>
</span></span><span style=display:flex><span>    exit <span style=color:#f99b15>1</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#776e71># Create CSV content</span>
</span></span><span style=display:flex><span><span style=color:#ef6155>$csvContent</span> = <span style=color:#48b685>@&#34;
</span></span></span><span style=display:flex><span><span style=color:#48b685>Device Serial Number,Windows Product ID,Hardware Hash
</span></span></span><span style=display:flex><span><span style=color:#48b685></span><span style=color:#ef6155>$SerialNumber</span><span style=color:#48b685>,,</span><span style=color:#ef6155>$HardwareHash</span><span style=color:#48b685>
</span></span></span><span style=display:flex><span><span style=color:#48b685>&#34;@</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#776e71># Write to file</span>
</span></span><span style=display:flex><span><span style=color:#ef6155>$csvContent</span> | Out-File -FilePath <span style=color:#ef6155>$OutputFile</span> -Encoding ASCII -Force
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Write-Host <span style=color:#48b685>&#34;SUCCESS: Hash exported to </span><span style=color:#ef6155>$OutputFile</span><span style=color:#48b685>&#34;</span> -ForegroundColor Green
</span></span><span style=display:flex><span>Write-Host <span style=color:#48b685>&#34;Serial Number: </span><span style=color:#ef6155>$SerialNumber</span><span style=color:#48b685>&#34;</span> -ForegroundColor Cyan
</span></span></code></pre></div><h3 id=creating-the-custom-ps-script-upload_autopilothashps1>Creating the custom PS script &ldquo;Upload_AutopilotHash.ps1&rdquo;</h3><p>This is where the magic happens, instead of manually uploading the CSV through the Intune portal (Devices -> Enroll devices -> Import), this script uses Microsoft Graph API to register the device directly. It uses device code flow for authentication which is perfect for WinPE where you can&rsquo;t open a browser.</p><p>You can authenticate on your phone or another PC, manually entering the code shown on screen and the script handles the rest: uploading the hash, applying your GroupTag and triggering an Autopilot sync. The device is ready for Autopilot before Windows even finishes installing:</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-PowerShell data-lang=PowerShell><span style=display:flex><span><span style=color:#815ba4>param</span>(
</span></span><span style=display:flex><span>    [Parameter(<span style=color:#06b6ef>Mandatory</span>=<span style=color:#ef6155>$false</span>)]
</span></span><span style=display:flex><span>    [<span style=color:#ef6155>string</span>]<span style=color:#ef6155>$CsvFile</span> = <span style=color:#48b685>&#34;X:\Autopilot\AutopilotHash.csv&#34;</span>,
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    [Parameter(<span style=color:#06b6ef>Mandatory</span>=<span style=color:#ef6155>$false</span>)]
</span></span><span style=display:flex><span>    [<span style=color:#ef6155>string</span>]<span style=color:#ef6155>$GroupTag</span> = <span style=color:#48b685>&#34;A-RO-U-D-V&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#776e71># Microsoft Graph PowerShell App ID (public, safe to use)</span>
</span></span><span style=display:flex><span><span style=color:#ef6155>$ClientID</span> = <span style=color:#48b685>&#34;14d82eec-204b-4c2f-b7e8-296a70dab67e&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Write-Host <span style=color:#48b685>&#34;&#34;</span>
</span></span><span style=display:flex><span>Write-Host <span style=color:#48b685>&#34;==========================================&#34;</span> -ForegroundColor Cyan
</span></span><span style=display:flex><span>Write-Host <span style=color:#48b685>&#34;  Autopilot Hash Upload - Secure Edition&#34;</span> -ForegroundColor Cyan
</span></span><span style=display:flex><span>Write-Host <span style=color:#48b685>&#34;==========================================&#34;</span> -ForegroundColor Cyan
</span></span><span style=display:flex><span>Write-Host <span style=color:#48b685>&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#776e71># Check CSV exists</span>
</span></span><span style=display:flex><span><span style=color:#815ba4>if</span> (<span style=color:#5bc4bf>-not</span> (Test-Path <span style=color:#ef6155>$CsvFile</span>)) {
</span></span><span style=display:flex><span>    Write-Error <span style=color:#48b685>&#34;CSV file not found: </span><span style=color:#ef6155>$CsvFile</span><span style=color:#48b685>&#34;</span>
</span></span><span style=display:flex><span>    exit <span style=color:#f99b15>1</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#776e71># Read CSV</span>
</span></span><span style=display:flex><span><span style=color:#ef6155>$csv</span> = Import-Csv <span style=color:#ef6155>$CsvFile</span>
</span></span><span style=display:flex><span><span style=color:#ef6155>$SerialNumber</span> = <span style=color:#ef6155>$csv</span>.<span style=color:#48b685>&#39;Device Serial Number&#39;</span>
</span></span><span style=display:flex><span><span style=color:#ef6155>$HardwareHash</span> = <span style=color:#ef6155>$csv</span>.<span style=color:#48b685>&#39;Hardware Hash&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Write-Host <span style=color:#48b685>&#34;Device Serial: </span><span style=color:#ef6155>$SerialNumber</span><span style=color:#48b685>&#34;</span> -ForegroundColor Yellow
</span></span><span style=display:flex><span>Write-Host <span style=color:#48b685>&#34;Group Tag: </span><span style=color:#ef6155>$GroupTag</span><span style=color:#48b685>&#34;</span> -ForegroundColor Yellow
</span></span><span style=display:flex><span>Write-Host <span style=color:#48b685>&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#776e71># === DEVICE CODE FLOW ===</span>
</span></span><span style=display:flex><span>Write-Host <span style=color:#48b685>&#34;[1/4] Requesting device code...&#34;</span> -ForegroundColor Green
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ef6155>$deviceCodeRequest</span> = <span style=color:#ef6155>@</span>{
</span></span><span style=display:flex><span>    client_id = <span style=color:#ef6155>$ClientID</span>
</span></span><span style=display:flex><span>    scope     = <span style=color:#48b685>&#34;https://graph.microsoft.com/DeviceManagementServiceConfig.ReadWrite.All offline_access&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ef6155>$deviceCodeResponse</span> = Invoke-RestMethod -Method Post `
</span></span><span style=display:flex><span>    -Uri <span style=color:#48b685>&#34;https://login.microsoftonline.com/organizations/oauth2/v2.0/devicecode&#34;</span> `
</span></span><span style=display:flex><span>    -Body <span style=color:#ef6155>$deviceCodeRequest</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#776e71># Display code to user</span>
</span></span><span style=display:flex><span>Write-Host <span style=color:#48b685>&#34;&#34;</span>
</span></span><span style=display:flex><span>Write-Host <span style=color:#48b685>&#34;==========================================&#34;</span> -ForegroundColor Yellow
</span></span><span style=display:flex><span>Write-Host <span style=color:#48b685>&#34;  ACTION REQUIRED:&#34;</span> -ForegroundColor Yellow
</span></span><span style=display:flex><span>Write-Host <span style=color:#48b685>&#34;&#34;</span>
</span></span><span style=display:flex><span>Write-Host <span style=color:#48b685>&#34;  1. On your phone or PC, open:&#34;</span> -ForegroundColor White
</span></span><span style=display:flex><span>Write-Host <span style=color:#48b685>&#34;     https://microsoft.com/devicelogin&#34;</span> -ForegroundColor Cyan
</span></span><span style=display:flex><span>Write-Host <span style=color:#48b685>&#34;&#34;</span>
</span></span><span style=display:flex><span>Write-Host <span style=color:#48b685>&#34;  2. Enter code: </span>$(<span style=color:#ef6155>$deviceCodeResponse</span>.user_code)<span style=color:#48b685>&#34;</span> -ForegroundColor White -BackgroundColor DarkBlue
</span></span><span style=display:flex><span>Write-Host <span style=color:#48b685>&#34;&#34;</span>
</span></span><span style=display:flex><span>Write-Host <span style=color:#48b685>&#34;  3. Sign in and approve&#34;</span> -ForegroundColor White
</span></span><span style=display:flex><span>Write-Host <span style=color:#48b685>&#34;==========================================&#34;</span> -ForegroundColor Yellow
</span></span><span style=display:flex><span>Write-Host <span style=color:#48b685>&#34;&#34;</span>
</span></span><span style=display:flex><span>Write-Host <span style=color:#48b685>&#34;Waiting for authentication...&#34;</span> -ForegroundColor Gray
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#776e71># Poll for token</span>
</span></span><span style=display:flex><span><span style=color:#ef6155>$tokenRequest</span> = <span style=color:#ef6155>@</span>{
</span></span><span style=display:flex><span>    grant_type  = <span style=color:#48b685>&#34;urn:ietf:params:oauth:grant-type:device_code&#34;</span>
</span></span><span style=display:flex><span>    client_id   = <span style=color:#ef6155>$ClientID</span>
</span></span><span style=display:flex><span>    device_code = <span style=color:#ef6155>$deviceCodeResponse</span>.device_code
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ef6155>$timeout</span> = [<span style=color:#ef6155>DateTime</span>]::Now.AddSeconds(<span style=color:#ef6155>$deviceCodeResponse</span>.expires_in)
</span></span><span style=display:flex><span><span style=color:#ef6155>$token</span> = <span style=color:#ef6155>$null</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#815ba4>while</span> ([<span style=color:#ef6155>DateTime</span>]::Now <span style=color:#5bc4bf>-lt</span> <span style=color:#ef6155>$timeout</span> <span style=color:#5bc4bf>-and</span> <span style=color:#5bc4bf>-not</span> <span style=color:#ef6155>$token</span>) {
</span></span><span style=display:flex><span>    Start-Sleep -Seconds <span style=color:#f99b15>5</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#ef6155>$tokenResponse</span> = Invoke-RestMethod -Method Post `
</span></span><span style=display:flex><span>            -Uri <span style=color:#48b685>&#34;https://login.microsoftonline.com/organizations/oauth2/v2.0/token&#34;</span> `
</span></span><span style=display:flex><span>            -Body <span style=color:#ef6155>$tokenRequest</span>
</span></span><span style=display:flex><span>        <span style=color:#ef6155>$token</span> = <span style=color:#ef6155>$tokenResponse</span>.access_token
</span></span><span style=display:flex><span>    } <span style=color:#815ba4>catch</span> {
</span></span><span style=display:flex><span>        <span style=color:#776e71># Still waiting for user to authenticate</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#815ba4>if</span> (<span style=color:#5bc4bf>-not</span> <span style=color:#ef6155>$token</span>) {
</span></span><span style=display:flex><span>    Write-Error <span style=color:#48b685>&#34;Authentication timed out!&#34;</span>
</span></span><span style=display:flex><span>    exit <span style=color:#f99b15>1</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Write-Host <span style=color:#48b685>&#34;[2/4] Authentication successful!&#34;</span> -ForegroundColor Green
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#776e71># Prepare headers</span>
</span></span><span style=display:flex><span><span style=color:#ef6155>$headers</span> = <span style=color:#ef6155>@</span>{
</span></span><span style=display:flex><span>    <span style=color:#48b685>&#34;Authorization&#34;</span> = <span style=color:#48b685>&#34;Bearer </span><span style=color:#ef6155>$token</span><span style=color:#48b685>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#48b685>&#34;Content-Type&#34;</span>  = <span style=color:#48b685>&#34;application/json&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#776e71># Prepare device data</span>
</span></span><span style=display:flex><span><span style=color:#ef6155>$deviceData</span> = <span style=color:#ef6155>@</span>{
</span></span><span style=display:flex><span>    <span style=color:#48b685>&#34;@odata.type&#34;</span>        = <span style=color:#48b685>&#34;#microsoft.graph.importedWindowsAutopilotDeviceIdentity&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#48b685>&#34;groupTag&#34;</span>           = <span style=color:#ef6155>$GroupTag</span>
</span></span><span style=display:flex><span>    <span style=color:#48b685>&#34;serialNumber&#34;</span>       = <span style=color:#ef6155>$SerialNumber</span>
</span></span><span style=display:flex><span>    <span style=color:#48b685>&#34;hardwareIdentifier&#34;</span> = <span style=color:#ef6155>$HardwareHash</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ef6155>$jsonBody</span> = <span style=color:#ef6155>$deviceData</span> | ConvertTo-Json
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#776e71># Upload to Intune</span>
</span></span><span style=display:flex><span>Write-Host <span style=color:#48b685>&#34;[3/4] Uploading to Intune...&#34;</span> -ForegroundColor Green
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#815ba4>try</span> {
</span></span><span style=display:flex><span>    <span style=color:#ef6155>$uploadResponse</span> = Invoke-RestMethod -Method Post `
</span></span><span style=display:flex><span>        -Uri <span style=color:#48b685>&#34;https://graph.microsoft.com/v1.0/deviceManagement/importedWindowsAutopilotDeviceIdentities&#34;</span> `
</span></span><span style=display:flex><span>        -Headers <span style=color:#ef6155>$headers</span> -Body <span style=color:#ef6155>$jsonBody</span>
</span></span><span style=display:flex><span>    Write-Host <span style=color:#48b685>&#34;      Upload successful!&#34;</span> -ForegroundColor Green
</span></span><span style=display:flex><span>} <span style=color:#815ba4>catch</span> {
</span></span><span style=display:flex><span>    Write-Error <span style=color:#48b685>&#34;Upload failed: </span><span style=color:#ef6155>$_</span><span style=color:#48b685>&#34;</span>
</span></span><span style=display:flex><span>    exit <span style=color:#f99b15>1</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#776e71># Trigger sync</span>
</span></span><span style=display:flex><span>Write-Host <span style=color:#48b685>&#34;[4/4] Triggering Autopilot sync...&#34;</span> -ForegroundColor Green
</span></span><span style=display:flex><span><span style=color:#815ba4>try</span> {
</span></span><span style=display:flex><span>    Invoke-RestMethod -Method Post `
</span></span><span style=display:flex><span>        -Uri <span style=color:#48b685>&#34;https://graph.microsoft.com/v1.0/deviceManagement/windowsAutopilotSettings/sync&#34;</span> `
</span></span><span style=display:flex><span>        -Headers <span style=color:#ef6155>$headers</span> | Out-Null
</span></span><span style=display:flex><span>    Write-Host <span style=color:#48b685>&#34;      Sync triggered!&#34;</span> -ForegroundColor Green
</span></span><span style=display:flex><span>} <span style=color:#815ba4>catch</span> {
</span></span><span style=display:flex><span>    Write-Host <span style=color:#48b685>&#34;      Sync skipped (non-critical)&#34;</span> -ForegroundColor Yellow
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Write-Host <span style=color:#48b685>&#34;&#34;</span>
</span></span><span style=display:flex><span>Write-Host <span style=color:#48b685>&#34;==========================================&#34;</span> -ForegroundColor Cyan
</span></span><span style=display:flex><span>Write-Host <span style=color:#48b685>&#34;  SUCCESS! Device uploaded to Autopilot&#34;</span> -ForegroundColor Green
</span></span><span style=display:flex><span>Write-Host <span style=color:#48b685>&#34;  Serial: </span><span style=color:#ef6155>$SerialNumber</span><span style=color:#48b685>&#34;</span> -ForegroundColor White
</span></span><span style=display:flex><span>Write-Host <span style=color:#48b685>&#34;  GroupTag: </span><span style=color:#ef6155>$GroupTag</span><span style=color:#48b685>&#34;</span> -ForegroundColor White
</span></span><span style=display:flex><span>Write-Host <span style=color:#48b685>&#34;==========================================&#34;</span> -ForegroundColor Cyan
</span></span><span style=display:flex><span>Write-Host <span style=color:#48b685>&#34;&#34;</span>
</span></span></code></pre></div><h2 id=creating-a-custom-windows-11-iso-with-embedded-autopilot-scripts>Creating a Custom Windows 11 ISO with Embedded Autopilot Scripts</h2><p>The standard approach to Autopilot device registration involves booting a fully installed Windows system, running PowerShell scripts to capture the hardware hash, then uploading it to Intune. This works but it means you&rsquo;re either re-imaging the device afterward or manually running scripts on every new machine.</p><p>Instead I&rsquo;ve wanted something cleaner: capture the hardware hash during Windows Setup, before the OS even touches the disk, then continue straight into installation. The device registers with Autopilot while I&rsquo;m still at the first setup screen and by the time OOBE loads Intune already knows about it.</p><p>To make this work I&rsquo;ve needed to customize the Windows 11 installer&rsquo;s boot image (boot.wim). The default boot.wim is intentionally minimal and it doesn&rsquo;t include PowerShell and network initialization only happens when Setup.exe needs it and there&rsquo;s no way to run custom scripts. So by injecting the optional WinPE components along with my Autopilot custom PS scripts directly into the boot image, I&rsquo;ve created a self-contained ISO that handles everything automatically.</p><p>The process involves mounting the boot.wim, adding PowerShell support and network drivers, copying the six Autopilot files we prepared earlier, then rebuilding the ISO. The result is a Windows 11 installer that doubles as an Autopilot registration tool, press Shift+F10 at the first screen, run one command, authenticate on your phone and you&rsquo;re done.</p><h3 id=step-1-create-working-directories>Step 1: Create Working Directories</h3><p>Two folders keep things organized: Mount is where we&rsquo;ll temporarily extract the boot image for editing, and ISO_Files holds the complete Windows installation media we&rsquo;ll modify and repackage.</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-PowerShell data-lang=PowerShell><span style=display:flex><span>New-Item -Path <span style=color:#48b685>&#34;C:\ISO_Build\Mount&#34;</span> -ItemType Directory -Force
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>New-Item -Path <span style=color:#48b685>&#34;C:\ISO_Build\ISO_Files&#34;</span> -ItemType Directory -Force
</span></span></code></pre></div><p><img src=/images/Blog_P15_120.jpg alt></p><h3 id=step-2-mount-and-extract-windows-11-iso>Step 2: Mount and Extract Windows 11 ISO</h3><p>We mount the original Windows 11 ISO as a virtual drive, copy everything to the working directory, then dismount. Working with a copy means we can always start fresh if something goes wrong and the original media stays untouched.</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-PowerShell data-lang=PowerShell><span style=display:flex><span><span style=color:#776e71># Mount the Windows 11 ISO</span>
</span></span><span style=display:flex><span>Mount-DiskImage -ImagePath <span style=color:#48b685>&#34;C:\ISO\Windows11_v25H2.iso&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#776e71># Verify the mounted drive letter</span>
</span></span><span style=display:flex><span>Get-Volume | Where-Object { <span style=color:#ef6155>$_</span>.DriveType <span style=color:#5bc4bf>-eq</span> <span style=color:#48b685>&#39;CD-ROM&#39;</span> }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#776e71># Copy all ISO contents to working directory (adjust drive letter if needed)</span>
</span></span><span style=display:flex><span>Copy-Item -Path <span style=color:#48b685>&#34;J:\*&#34;</span> -Destination <span style=color:#48b685>&#34;C:\ISO_Build\ISO_Files&#34;</span> -Recurse -Force
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#776e71># Dismount the ISO</span>
</span></span><span style=display:flex><span>Dismount-DiskImage -ImagePath <span style=color:#48b685>&#34;C:\ISO\Windows11_v25H2.iso&#34;</span>
</span></span></code></pre></div><p><img src=/images/Blog_P15_122.jpg alt></p><h3 id=step-3-prepare-bootwim-for-editing>Step 3: Prepare boot.wim for Editing</h3><p>The boot.wim file contains Windows Setup (the environment you see during installation). Files extracted from an ISO inherit read-only attributes, so we clear that first.</p><p><em>Index 2</em> is Windows Setup itself, <em>Index 1</em> is Windows Recovery Environment which we don&rsquo;t need to modify.</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-PowerShell data-lang=PowerShell><span style=display:flex><span><span style=color:#776e71># Remove read-only attribute from boot.wim</span>
</span></span><span style=display:flex><span>Set-ItemProperty -Path <span style=color:#48b685>&#34;C:\ISO_Build\ISO_Files\sources\boot.wim&#34;</span> -Name IsReadOnly -Value <span style=color:#ef6155>$false</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#776e71># Mount boot.wim Index 2 (Windows Setup)</span>
</span></span><span style=display:flex><span>Mount-WindowsImage -ImagePath <span style=color:#48b685>&#34;C:\ISO_Build\ISO_Files\sources\boot.wim&#34;</span> -Index <span style=color:#f99b15>2</span> -Path <span style=color:#48b685>&#34;C:\ISO_Build\Mount&#34;</span>
</span></span></code></pre></div><h3 id=step-4-add-winpe-optional-components-powershell-support>Step 4: Add WinPE Optional Components (PowerShell Support)</h3><p>Here&rsquo;s where one might get stuck, the default Windows Setup environment doesn&rsquo;t include PowerShell, it&rsquo;s intentionally minimal. We need to inject the WinPE optional components from the Windows ADK, and order matters.</p><p>PowerShell depends on Scripting which depends on NetFX which depends on WMI. Skip a dependency or install out of order and PowerShell won&rsquo;t load. Each component also needs its language pack (en-us cab files) or you&rsquo;ll get cryptic errors:</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-PowerShell data-lang=PowerShell><span style=display:flex><span><span style=color:#776e71># Define paths</span>
</span></span><span style=display:flex><span><span style=color:#ef6155>$OCPath</span> = <span style=color:#48b685>&#34;C:\Program Files (x86)\Windows Kits\10\Assessment and Deployment Kit\Windows Preinstallation Environment\amd64\WinPE_OCs&#34;</span> 
</span></span><span style=display:flex><span><span style=color:#ef6155>$MountPath</span> = <span style=color:#48b685>&#34;C:\ISO_Build\Mount&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#776e71># Add components in dependency order </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#776e71>#1. WMI</span>
</span></span><span style=display:flex><span>Dism /Add-Package /Image<span style=color:#ef6155>:</span><span style=color:#48b685>&#34;</span><span style=color:#ef6155>$MountPath</span><span style=color:#48b685>&#34;</span> /PackagePath<span style=color:#ef6155>:</span><span style=color:#48b685>&#34;</span><span style=color:#ef6155>$OCPath</span><span style=color:#48b685>\WinPE-WMI.cab&#34;</span> 
</span></span><span style=display:flex><span>Dism /Add-Package /Image<span style=color:#ef6155>:</span><span style=color:#48b685>&#34;</span><span style=color:#ef6155>$MountPath</span><span style=color:#48b685>&#34;</span> /PackagePath<span style=color:#ef6155>:</span><span style=color:#48b685>&#34;</span><span style=color:#ef6155>$OCPath</span><span style=color:#48b685>\en-us\WinPE-WMI_en-us.cab&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#776e71>#2. NetFX </span>
</span></span><span style=display:flex><span>Dism /Add-Package /Image<span style=color:#ef6155>:</span><span style=color:#48b685>&#34;</span><span style=color:#ef6155>$MountPath</span><span style=color:#48b685>&#34;</span> /PackagePath<span style=color:#ef6155>:</span><span style=color:#48b685>&#34;</span><span style=color:#ef6155>$OCPath</span><span style=color:#48b685>\WinPE-NetFX.cab&#34;</span> Dism /Add-Package /Image<span style=color:#ef6155>:</span><span style=color:#48b685>&#34;</span><span style=color:#ef6155>$MountPath</span><span style=color:#48b685>&#34;</span> /PackagePath<span style=color:#ef6155>:</span><span style=color:#48b685>&#34;</span><span style=color:#ef6155>$OCPath</span><span style=color:#48b685>\en-us\WinPE-NetFX_en-us.cab&#34;</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#776e71>#3. Scripting </span>
</span></span><span style=display:flex><span>Dism /Add-Package /Image<span style=color:#ef6155>:</span><span style=color:#48b685>&#34;</span><span style=color:#ef6155>$MountPath</span><span style=color:#48b685>&#34;</span> /PackagePath<span style=color:#ef6155>:</span><span style=color:#48b685>&#34;</span><span style=color:#ef6155>$OCPath</span><span style=color:#48b685>\WinPE-Scripting.cab&#34;</span> 
</span></span><span style=display:flex><span>Dism /Add-Package /Image<span style=color:#ef6155>:</span><span style=color:#48b685>&#34;</span><span style=color:#ef6155>$MountPath</span><span style=color:#48b685>&#34;</span> /PackagePath<span style=color:#ef6155>:</span><span style=color:#48b685>&#34;</span><span style=color:#ef6155>$OCPath</span><span style=color:#48b685>\en-us\WinPE-Scripting_en-us.cab&#34;</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#776e71>#4. PowerShell </span>
</span></span><span style=display:flex><span>Dism /Add-Package /Image<span style=color:#ef6155>:</span><span style=color:#48b685>&#34;</span><span style=color:#ef6155>$MountPath</span><span style=color:#48b685>&#34;</span> /PackagePath<span style=color:#ef6155>:</span><span style=color:#48b685>&#34;</span><span style=color:#ef6155>$OCPath</span><span style=color:#48b685>\WinPE-PowerShell.cab&#34;</span> 
</span></span><span style=display:flex><span>Dism /Add-Package /Image<span style=color:#ef6155>:</span><span style=color:#48b685>&#34;</span><span style=color:#ef6155>$MountPath</span><span style=color:#48b685>&#34;</span> /PackagePath<span style=color:#ef6155>:</span><span style=color:#48b685>&#34;</span><span style=color:#ef6155>$OCPath</span><span style=color:#48b685>\en-us\WinPE-PowerShell_en-us.cab&#34;</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#776e71>#5. StorageWMI</span>
</span></span><span style=display:flex><span>Dism /Add-Package /Image<span style=color:#ef6155>:</span><span style=color:#48b685>&#34;</span><span style=color:#ef6155>$MountPath</span><span style=color:#48b685>&#34;</span> /PackagePath<span style=color:#ef6155>:</span><span style=color:#48b685>&#34;</span><span style=color:#ef6155>$OCPath</span><span style=color:#48b685>\WinPE-StorageWMI.cab&#34;</span> 
</span></span><span style=display:flex><span>Dism /Add-Package /Image<span style=color:#ef6155>:</span><span style=color:#48b685>&#34;</span><span style=color:#ef6155>$MountPath</span><span style=color:#48b685>&#34;</span> /PackagePath<span style=color:#ef6155>:</span><span style=color:#48b685>&#34;</span><span style=color:#ef6155>$OCPath</span><span style=color:#48b685>\en-us\WinPE-StorageWMI_en-us.cab&#34;</span>
</span></span></code></pre></div><h3 id=step-5-copy-autopilot-scripts-to-mounted-image>Step 5: Copy Autopilot Scripts to Mounted Image</h3><p>This places the six files (<em>CaptureHash.cmd</em>, <em>oa3tool.exe</em>, <em>PCPKsp.dll</em>, <em>OA3.cfg</em> and both PowerShell scripts) into the boot image at X:\Autopilot. When Windows Setup launches these files are immediately available without needing external media:</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-PowerShell data-lang=PowerShell><span style=display:flex><span><span style=color:#776e71># Create Autopilot folder in mounted image </span>
</span></span><span style=display:flex><span>New-Item -Path <span style=color:#48b685>&#34;C:\ISO_Build\Mount\Autopilot&#34;</span> -ItemType Directory -Force 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#776e71># Copy all 6 files from staging folder </span>
</span></span><span style=display:flex><span>Copy-Item -Path <span style=color:#48b685>&#34;C:\AutopilotUSB\*&#34;</span> -Destination <span style=color:#48b685>&#34;C:\ISO_Build\Mount\Autopilot\&#34;</span> -Force 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#776e71># Verify files copied </span>
</span></span><span style=display:flex><span>Get-ChildItem <span style=color:#48b685>&#34;C:\ISO_Build\Mount\Autopilot&#34;</span>
</span></span></code></pre></div><h3 id=step-6-add-vmware-network-drivers-optional---for-vmware-vms>Step 6: Add VMware Network Drivers (Optional - for VMware VMs)</h3><p>If you&rsquo;re testing in VMware Workstation like I am, the default boot.wim doesn&rsquo;t include vmxnet3 drivers. Without network connectivity the upload script can&rsquo;t reach Microsoft Graph. Physical hardware or Hyper-V users can skip this step their drivers are already included.</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-PowerShell data-lang=PowerShell><span style=display:flex><span>Dism /Add-Driver /Image<span style=color:#ef6155>:</span><span style=color:#48b685>&#34;C:\ISO_Build\Mount&#34;</span> /Driver<span style=color:#ef6155>:</span><span style=color:#48b685>&#34;C:\Program Files\Common Files\VMware\Drivers\vmxnet3\Win11_24H2&#34;</span> /Recurse
</span></span></code></pre></div><h3 id=step-7-unmount-and-save-changes>Step 7: Unmount and Save Changes</h3><p>The <em>-Save</em> parameter commits all our modifications back to boot.wim, without it dismounting would discard everything. This step can take a few minutes depending on how many components were added:</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-PowerShell data-lang=PowerShell><span style=display:flex><span>Dismount-WindowsImage -Path <span style=color:#48b685>&#34;C:\ISO_Build\Mount&#34;</span> -Save
</span></span></code></pre></div><h3 id=step-8-create-bootable-iso>Step 8: Create Bootable ISO</h3><p><em>oscdimg.exe from</em> the Windows ADK combines everything into a bootable ISO, the <em>-bootdata</em> parameter is the critical piece it configures both BIOS boot (etfsboot.com) and UEFI boot (efisys.bin) making the ISO work on any system regardless of firmware type. The result is a standard Windows 11 installer with our Autopilot automation baked in:</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-PowerShell data-lang=PowerShell><span style=display:flex><span><span style=color:#776e71># Remove old ISO if exists </span>
</span></span><span style=display:flex><span>Remove-Item <span style=color:#48b685>&#34;C:\ISO\Windows11_Autopilot_25H2.iso&#34;</span> -Force -ErrorAction SilentlyContinue
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#776e71># Create new bootable ISO using oscdimg </span>
</span></span><span style=display:flex><span><span style=color:#ef6155>$OscdimgPath</span> = <span style=color:#48b685>&#34;C:\Program Files (x86)\Windows Kits\10\Assessment and Deployment Kit\Deployment Tools\amd64\Oscdimg\oscdimg.exe&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&amp; <span style=color:#ef6155>$OscdimgPath</span> -m -o -u2 -udfver102 `
</span></span><span style=display:flex><span>	-bootdata:<span style=color:#f99b15>2</span><span style=color:#776e71>#p0,e,b&#34;C:\ISO_Build\ISO_Files\boot\etfsboot.com&#34;#pEF,e,b</span>
</span></span><span style=display:flex><span>	<span style=color:#48b685>&#34;C:\ISO_Build\ISO_Files\efi\microsoft\boot\efisys.bin&#34;</span> `
</span></span><span style=display:flex><span>	<span style=color:#48b685>&#34;C:\ISO_Build\ISO_Files&#34;</span> ` 
</span></span><span style=display:flex><span>	<span style=color:#48b685>&#34;C:\ISO\Windows11_Autopilot_25H2.iso&#34;</span>
</span></span></code></pre></div><h2 id=using-the-custom-iso-autopilot-registration-in-action>Using the Custom ISO: Autopilot Registration in Action</h2><h3 id=verifying-the-embedded-scripts>Verifying the Embedded Scripts</h3><p>After mounting and booting from the custom ISO and pressing <strong>Shift+F10</strong> at the Windows Setup screen, I&rsquo;ve navigated to the Autopilot folder to verify all six files were successfully embedded in the boot image:</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>X:\&gt;cd Autopilot 
</span></span><span style=display:flex><span>X:\Autopilot&gt;dir
</span></span></code></pre></div><p>All six files are present and accessible at X:\Autopilot exactly where I&rsquo;ve placed them while customizing the boot.wim. The X: drive is the WinPE RAM disk that loads from boot.wim during Windows Setup. With everything confirmed just launched the capture script by typing <em>CaptureHash.cmd</em>:</p><p><img src=/images/Blog_P16_194.jpg alt></p><h3 id=running-capturehashcmd---hash-generation-and-device-code-prompt>Running CaptureHash.cmd - Hash Generation and Device Code Prompt</h3><p>The script now displays a temporary device code <em>DVJ9C2UY6</em> and waits for me to authenticate. Notice the Device Serial field is empty, this is expected on VMware VMs where OA3Tool reads from SMBIOS Type 1 which contains no serial number. The GroupTag <em>A-RO-U-D-V</em> is automatically applied based on the parameter in CaptureHash.cmd:</p><blockquote><p>Note: This guide covers a single GroupTag scenario so if your organization uses multiple GroupTags for different device configurations, the approach here would need to be extended so that&rsquo;s outside the scope of this article for now.</p></blockquote><p><img src=/images/Blog_P16_195.jpg alt></p><h3 id=device-code-entry>Device Code Entry</h3><p>From your PC, laptop or phone open the URL <a href=https://microsoft.com/devicelogin>https://microsoft.com/devicelogin</a> and manually enter the code <em>DVJ9C2UY6</em> displayed on the WinPE screen above. Device Code Flow is ideal for this scenario, the device being registered has no browser and can&rsquo;t complete interactive authentication, but I can authenticate from any other device that can reach Microsoft&rsquo;s login endpoint:</p><p><img src=/images/Blog_P16_196.jpg alt></p><h3 id=account-selection>Account Selection</h3><p>Microsoft prompts me to select which account to use, the dialog confirms I&rsquo;m signing into Microsoft Graph Command Line Tools, this being the public Microsoft Graph PowerShell application (App ID 14d82eec-204b-4c2f-b7e8-296a70dab67e) that my upload script uses. It also shows the sign-in request is coming from Romania, matching my location:</p><p><img src=/images/Blog_P16_197.jpg alt></p><h3 id=mfa-challenge>MFA Challenge</h3><p>Because my tenant has MFA enforced via Conditional Access, I need to approve the sign-in through Microsoft Authenticator:</p><p><img src=/images/Blog_P16_199.jpg alt></p><h3 id=consent-confirmation>Consent Confirmation</h3><p>A final confirmation asking whether I trust <strong>Microsoft Graph Command Line Tools</strong>. This appears because the app is requesting the <em>DeviceManagementServiceConfig.ReadWrite.All</em> permission scope to upload the device hash, clicking <strong>Continue</strong> grants the token:</p><p><img src=/images/Blog_P16_200.jpg alt></p><h3 id=authentication-complete>Authentication Complete</h3><p>The browser confirms successful sign-in to Microsoft Graph Command Line Tools, I can now close this window since the token has been sent back to the WinPE script which is polling for it:</p><p><img src=/images/Blog_P16_201.jpg alt></p><h3 id=success---device-uploaded-to-autopilot>Success - Device Uploaded to Autopilot</h3><p>Device uploaded to Autopilot with GroupTag <em>A-RO-U-D-V</em> has applied successfully, the device is now registered in Intune and will receive its Autopilot profile when OOBE starts.</p><p>From here, I will simply close the command prompt, click Install now in Windows Setup and proceed with a normal Windows 11 OS installation. When the device reaches OOBE and connects to the internet, Autopilot recognizes it and applies the deployment profile, all without ever having to boot into Windows first.</p><p><img src=/images/Blog_P16_203.jpg alt></p><h3 id=device-appears-in-microsoft-entra-id>Device Appears in Microsoft Entra ID</h3><p>Within minutes of the upload completing the device appears in <strong>Entra ID -> Devices -> All devices</strong>. The device name is the VMware generated UUID (VMware-56 4d e0 98 bb 81 a2 ca-18 c9 ad fe 29 50 a9 78) since VMware VMs don&rsquo;t have traditional serial numbers in SMBIOS Type 1.</p><p>Key details :</p><ul><li><strong>Join type</strong>: Microsoft Entra joined (pending and will complete during OOBE)</li><li><strong>MDM</strong>: None (not yet enrolled since the device hasn&rsquo;t gone through OOBE yet)</li><li><strong>Registered</strong>: shows the exact time my script uploaded the hash</li></ul><p>The device exists in Entra ID but shows as <strong>Enabled: No</strong> because it hasn&rsquo;t completed enrollment yet. This is expected since I&rsquo;ve only registered the hardware hash, the actual device enrollment happens when Windows OOBE runs and Autopilot takes over:</p><p><img src=/images/Blog_P16_204.jpg alt></p><h3 id=device-registered-in-intune-with-autopilot-profile-assigned>Device Registered in Intune with Autopilot Profile Assigned</h3><p>The critical confirmation is Profile status: Assigned with the profile <em>GBL_WIN11_Autopilot_AAD_ALL</em>. Intune matched the device to my Autopilot profile based on the GroupTag <em>A-RO-U-D-V</em> and the dynamic device group targeting, the device will enroll and contact Intune when it boots into OOBE and completes the Autopilot flow.</p><p>At this point the device is fully staged, when I&rsquo;ll continue with Windows installation and reach OOBE the new device will automatically receive its Autopilot profile, join Entra ID, enroll in Intune and apply all assigned policies and applications, all because I&rsquo;ve registered the hash before the OS was even installed:</p><p><img src=/images/Blog_P16_207.jpg alt></p><h2 id=the-autopilot-deployment-process>The Autopilot deployment process</h2><p>I&rsquo;ve initiated a fresh Autopilot deployment in my test environment using a newly provisioned VMware Workstation VM. During OOBE I&rsquo;ve authenticated with my Azure AD work account following the standard user-driven Autopilot process:</p><p><img src=/images/Blog_P16_225.jpg alt></p><p>After entering credentials I&rsquo;ve received a number matching challenge, this confirmed that my Conditional Access policies are functioning as intended and enforcing MFA during device enrollment:</p><p><img src=/images/Blog_P16_226.jpg alt></p><h3 id=esp-success>ESP Success</h3><p>The Enrollment Status Page completed successfully displaying the “All set!” message. At this stage my ESP blocking apps were all installed during the Device Setup phase confirming that the configuration behaved as expected in my tenant:</p><p><img src=/images/Blog_P16_272.png alt></p><p>The device reached the lock screen fully provisioned and ready for sign-in. The presence of the work account sign-in option verified that the device was Azure AD joined and under Intune management.</p><p><img src=/images/Blog_P16_281.jpg alt></p><h3 id=windows-hello-for-business-pin-setup>Windows Hello for Business PIN Setup</h3><p>Immediately after the first sign-in I was prompted to configure a Windows Hello for Business PIN, this prompt was triggered by my Windows Hello policy and enabled passwordless authentication backed by the device vTPM:</p><p><img src=/images/Blog_P16_273.jpg alt></p><p>The completion message confirmed successful enrollment meaning the PIN is now cryptographically bound to the device and available for future authentication events:</p><p><img src=/images/Blog_P16_274.jpg alt></p><p>The Company Portal reported the device <strong>2025-2B3FCFB23B</strong> with a green <strong>“Can access company resources”</strong> status, this validated that the device passed all assigned compliance checks and is authorized to access corporate services:</p><p><img src=/images/Blog_P16_267.jpg alt></p><h3 id=dsregcmd-diagnostic-data>Dsregcmd Diagnostic Data</h3><p>Every critical indicator in this <em>dsregcmd</em> output shows healthy status, the device is properly joined to Entra ID, protected by TPM, enrolled in Intune, has a valid PRT for SSO and passed all diagnostic checks:</p><p><strong>AzureAdJoined: YES</strong> - This is the green light you want to see, confirms the device has successfully joined Microsoft Entra ID and is now a trusted member of your cloud environment. The device can authenticate to cloud services, receive policies from Intune and participate in Conditional Access evaluation.</p><p><strong>EnterpriseJoined: NO</strong> - For a pure cloud deployment this simply means we&rsquo;re not using an on-premises Device Registration Service with AD FS.</p><p><strong>DomainJoined: NO</strong> - The device isn&rsquo;t joined to a traditional on-premises Active Directory domain.</p><p><strong>TpmProtected: YES</strong> - It means the device&rsquo;s private key is stored in the hardware Trusted Platform Module not just in software. Even if malware compromises the operating system it cannot extract the device&rsquo;s identity.</p><p><strong>DeviceAuthStatus: SUCCESS</strong> - The device just performed a live authentication test against Entra ID and passed, this confirms the device exists, is enabled and can successfully prove its identity to the cloud. If this ever shows FAILED, your device has been disabled or deleted in Entra ID.</p><p><strong>DeviceCertificateValidity</strong> - The device certificate is valid for 10 years from enrollment, this certificate is the device&rsquo;s passport to the Microsoft cloud, renewed automatically as long as the device remains healthy.</p><p><strong>TenantName: HalfOnCloud</strong> - A quick confirmation that my device joined the correct organization.</p><p><strong>MdmUrl pointing to enrollment.manage.microsoft.com</strong> - This confirms Intune MDM enrollment is configured, the device knows where to check in for policies, apps and compliance requirements.</p><p><strong>NgcSet: YES</strong> - NGC stands for Next Generation Credential, Microsoft&rsquo;s internal name for Windows Hello for Business. This confirms the user has successfully enrolled passwordless credentials on this device and can now sign in with a PIN or biometrics instead of typing their password.</p><p><strong>WamDefaultSet: YES</strong> - The Web Account Manager has a default organizational account configured, enabling seamless single sign-on across Windows and applications.</p><p><strong>AzureAdPrt: YES</strong> - This is arguably the most important field in the entire output, PRT stands for Primary Refresh Token and it&rsquo;s the secret sauce behind single sign-on. When this shows YES the device has obtained a long-lived token that proves both the device and user identity, no password prompt, no MFA challenge, just seamless access.</p><p><strong>AzureAdPrtUpdateTime and ExpiryTime</strong> - The PRT refreshes automatically every four hours during normal device usage. The expiry time (14 days out) gives plenty of buffer as long as the device is used regularly the PRT stays fresh.</p><p><strong>CloudTgt: YES</strong> - Cloud Kerberos ticket is present, this enables seamless SSO to Azure resources that support Kerberos authentication, extending the SSO experience beyond just browser based access.</p><p><strong>KeySignTest: PASSED</strong> - The device just tested its ability to sign tokens using its private key and everything worked. This confirms the device certificate and TPM are functioning correctly, a FAILED result here would indicate serious issues requiring device re-registration.</p><p><strong>AadRecoveryEnabled: NO</strong> - The device is NOT in recovery mode, ff this ever shows YES the device keys have become unusable and the next sign-in will trigger a recovery flow to re-establish trust with Entra ID.</p><p><strong>DisplayNameUpdated: Managed by MDM</strong> - Even the device&rsquo;s display name is controlled by Intune demonstrating full MDM authority over the device configuration.</p><p><strong>Access Type: DIRECT</strong> - The device connects directly to the internet without any proxy interference. This clean network path ensures reliable communication with Microsoft cloud endpoints, misconfigured proxies are a notorious source of Autopilot and enrollment failures.</p><p><img src=/images/Blog_P16_275.jpg alt></p><p><img src=/images/Blog_P16_276.jpg alt></p><p>My custom <strong>GBL-WIN11-Compliance-Production</strong> policy reports the device as fully compliant across all configured controls, validating that encryption, Defender settings, password policies and platform security baselines were applied without conflict:</p><p><img src=/images/Blog_P16_277.jpg alt></p><p>From the Intune portal all required applications show <strong>Required install</strong> with an <strong>Installed</strong> status, confirming that application targeting and deployment executed successfully during provisioning:</p><p><img src=/images/Blog_P16_278.jpg alt></p><p>Finally the <strong>Access work or school</strong> settings page shows multiple management areas controlled by my tenant with device sync reporting as successful, a good hint that the MDM channel is healthy and policy refresh is operational:</p><p><img src=/images/Blog_P16_279.jpg alt></p><h2 id=troubleshooting-the-mysterious-sync-error>Troubleshooting: The Mysterious Sync Error</h2><h3 id=the-conditional-access-terms-of-use-gotchas>The Conditional Access &ldquo;Terms of Use&rdquo; Gotchas</h3><p>After what seemed like a successful Autopilot deployment I&rsquo;ve noticed an issues in the device settings, the Sync status showing a red error message: &ldquo;<em>Sync wasn&rsquo;t fully successful because we weren&rsquo;t able to verify your credentials</em>.&rdquo;</p><p><img src=/images/Blog_P16_282.jpg alt></p><p>At first glance this made no sense the device was Azure AD joined, the user was authenticated and everything else appeared to be working. To understand what was happening I&rsquo;ve queried the Azure AD sign-in logs using Microsoft Graph PowerShell finding repeated failures with error code &ldquo;<em>50158: External security challenge not satisfied</em>&rdquo;</p><p>Every single failure came from the &ldquo;Device Management Client&rdquo; application trying to authenticate to &ldquo;Microsoft Intune&rdquo;, the error message said the user would be redirected to satisfy additional authentication challenges but here&rsquo;s the catch: the Device Management Client is a background service which cannot be redirected, cannot click buttons and cannot accept terms. Something in my Conditional Access configuration was demanding an interactive response from a non-interactive process:</p><blockquote><p>Note: For readers who want deeper context around my Conditional Access design I&rsquo;ve covered the full policy architecture in <a href=https://halfoncloud.com/posts/m365-business-premium-part-5-intune-conditional-access-policies/>Part 5</a>. That article explains the rationale, targeting strategy and security strategy implemented, which directly influences how Autopilot authentication behaves as well.</p></blockquote><p><img src=/images/Blog_P16_283.jpg alt></p><p>The aha moment came when I&rsquo;ve expanded the sign-in log to show which Conditional Access policies were evaluated and there it was: <strong>CA-005-Require-ToU-All-Users</strong> with a result of <strong>failure</strong>.</p><p>Initially I&rsquo;ve suspected <em>CA-003</em> (MFA for all users) might be the problem since MFA also requires user interaction, but the logs told a different story CA-003 showed &ldquo;<em>notApplied</em>&rdquo; because MFA can be satisfied through existing token claims. The MFA requirement was already fulfilled by the user&rsquo;s authenticated session.</p><p>But Terms of Use? Well that&rsquo;s a different beast entirely, ToU requires someone to physically click &ldquo;Accept&rdquo; on a legal document, no token, claim or background process can do that for you.</p><p><img src=/images/Blog_P16_284.jpg alt></p><h3 id=the-fix-excluding-intune-service-principals>The Fix: Excluding Intune Service Principals</h3><p>The fix was quite simple once I&rsquo;ve understood the problem, I needed to exclude the Intune service principals from the Terms of Use policy, specifically these two:</p><ul><li><strong>Microsoft Intune</strong> (<em>0000000a-0000-0000-c000-000000000000</em>) - The core Intune service that handles device management operations.</li><li><strong>Microsoft Intune Enrollment</strong> (<em>d4ebce55-015a-49b5-a083-c84d1797ae8c</em>) - The service principal that handles device registration and enrollment. This is the critical one that was being blocked!</li></ul><p>But wait there&rsquo;s more ! Apparently in newer Microsoft 365 tenants the &ldquo;<em>Microsoft Intune Enrollment</em>&rdquo; service principal simply doesn&rsquo;t exist so you can&rsquo;t exclude something from a Conditional Access policy if it doesn&rsquo;t exist in your tenant&rsquo;s Enterprise Applications, therefore I&rsquo;ve used the following PowerShell script to create it manually:</p><blockquote><p>Note: If you&rsquo;re setting up a new tenant and plan to use Conditional Access policies that target &ldquo;All cloud apps,&rdquo; run this script first, it only takes 30 seconds and prevents hours of troubleshooting mysterious device sync failures later.</p></blockquote><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-PowerShell data-lang=PowerShell><span style=display:flex><span>Connect-MgGraph -Scopes <span style=color:#48b685>&#39;Application.ReadWrite.All&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ef6155>$AppId</span> = <span style=color:#48b685>&#39;d4ebce55-015a-49b5-a083-c84d1797ae8c&#39;</span>
</span></span><span style=display:flex><span><span style=color:#ef6155>$ExistingSP</span> = Get-MgServicePrincipal -Filter <span style=color:#48b685>&#34;appId eq &#39;</span><span style=color:#ef6155>$AppId</span><span style=color:#48b685>&#39;&#34;</span> -ErrorAction SilentlyContinue
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#815ba4>if</span> (<span style=color:#ef6155>$ExistingSP</span>) {
</span></span><span style=display:flex><span>    Write-Host <span style=color:#48b685>&#34;Microsoft Intune Enrollment already exists (ObjectId: </span>$(<span style=color:#ef6155>$ExistingSP</span>.Id)<span style=color:#48b685>)&#34;</span> -ForegroundColor Green
</span></span><span style=display:flex><span>} <span style=color:#815ba4>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#ef6155>$NewSP</span> = New-MgServicePrincipal -AppId <span style=color:#ef6155>$AppId</span>
</span></span><span style=display:flex><span>    Write-Host <span style=color:#48b685>&#34;Microsoft Intune Enrollment created (ObjectId: </span>$(<span style=color:#ef6155>$NewSP</span>.Id)<span style=color:#48b685>)&#34;</span> -ForegroundColor Green
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The output confirms successful creation for &ldquo;Microsoft Intune Enrollment&rdquo;:</p><p><img src=/images/Blog_P16_288.jpg alt></p><p>With this new service principal now existing in the tenant, I could finally select it into the Conditional Access policy exclusions. Without this step the exclusion list simply won&rsquo;t show &ldquo;Microsoft Intune Enrollment&rdquo; as an option and my ToU or MFA policies would have continue blocking device sync silently:</p><p><img src=/images/Blog_P16_285.jpg alt></p><p>After adding these exclusions to CA-005 the device sync started working immediately, the background service could now communicate with Intune without being challenged to accept a Terms of Use document it could never click.</p><h3 id=final-notes>Final Notes</h3><p>I&rsquo;ve implemented the Terms of Use policy following security best practices and MS-102 guidance. It seemed like a straightforward way to ensure users acknowledge company policies before accessing resources but what the documentation didn&rsquo;t mention and what I had to discover through hours of troubleshooting was that this seemingly innocent policy would silently break device management.</p><p>This is exactly why testing Conditional Access policies in Report-Only mode before enforcement is so critical and why understanding the difference between interactive and non-interactive authentication flows can save you from sync failures that have nothing to do with sync at all.</p><hr><h2 id=whats-next>What&rsquo;s next</h2><p>The next article answers those questions with real troubleshooting scenarios, diagnostic commands and the lessons learned from getting Autopilot to actually work in production.</p></div><footer class=post-footer><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><a href=https://halfoncloud.com/posts/m365-business-premium-part-8-anatomy-of-a-failed-enrollment-tracing-an-esp-error-from-screen-to-root-cause/ class="button inline prev">&lt; [<span class=button__text>M365 Business Premium Part 8: Anatomy of a Failed Enrollment - Tracing an ESP Error from Screen to Root Cause</span>]
</a>::
<a href=https://halfoncloud.com/posts/m365-business-premium-part-6-intune-best-practices-device-management-foundations/ class="button inline next">[<span class=button__text>M365 Business Premium Part 6: Building the Intune Foundation for Autopilot</span>] ></a></div></div></footer></article></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user" style=text-align:center><span>&copy; 2026 Radu Bogdan :: HalfOnCloud</span></div></div></footer><script type=text/javascript src=/bundle.min.js></script><style>.image-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.9);z-index:9999;cursor:pointer;justify-content:center;align-items:center}.image-overlay.active{display:flex}.image-overlay img{max-width:95%;max-height:95%;border:2px solid #fff;object-fit:contain}article img{cursor:pointer}</style><div class=image-overlay id=imageOverlay><img src alt="Enlarged image" id=overlayImage></div><script>document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("imageOverlay"),t=document.getElementById("overlayImage");document.querySelectorAll("article img").forEach(function(n){n.addEventListener("click",function(){t.src=this.src,e.classList.add("active")})}),e.addEventListener("click",function(){e.classList.remove("active")}),document.addEventListener("keydown",function(t){t.key==="Escape"&&e.classList.remove("active")}),document.querySelectorAll("article pre").forEach(function(e){var t,n=document.createElement("div");n.style.position="relative",e.parentNode.insertBefore(n,e),n.appendChild(e),t=document.createElement("button"),t.textContent="Copy",t.style.cssText="position:absolute; top:5px; right:5px; background:rgba(74,158,255,0.15); color:#4a9eff; border:1px solid rgba(74,158,255,0.3); padding:2px 8px; border-radius:3px; cursor:pointer; font-size:0.7rem; opacity:0.5; transition:opacity 0.2s; z-index:10;",t.addEventListener("mouseenter",function(){t.style.opacity="1"}),t.addEventListener("mouseleave",function(){t.style.opacity="0.7"}),t.addEventListener("click",function(){var n=e.querySelector("code")?e.querySelector("code").textContent:e.textContent;navigator.clipboard.writeText(n).then(function(){t.textContent="Copied!",t.style.background="rgba(34,197,94,0.15)",t.style.color="#22c55e",t.style.borderColor="rgba(34,197,94,0.3)",setTimeout(function(){t.textContent="Copy",t.style.background="rgba(74,158,255,0.15)",t.style.color="#4a9eff",t.style.borderColor="rgba(74,158,255,0.3)"},2e3)})}),n.appendChild(t)})})</script><script>(function(){let n=null;const t=document.getElementById("search-input"),e=document.getElementById("search-results");if(!t||!e)return;fetch("/index.json").then(e=>e.json()).then(e=>{n=e}).catch(e=>console.log("Search index not found"));function o(e,t){let n;return function(...s){clearTimeout(n),n=setTimeout(()=>e.apply(this,s),t)}}function s(t){if(!n||t.length<2){e.innerHTML="";return}const s=n.filter(e=>{const n=(e.title+" "+e.contents+" "+(e.tags||[]).join(" ")).toLowerCase();return n.includes(t.toLowerCase())}).slice(0,8);if(s.length===0){e.innerHTML='<div class="search-no-results">No results found</div>';return}e.innerHTML=s.map(e=>{const o=e.contents.toLowerCase(),i=t.toLowerCase();let n="";const s=o.indexOf(i);if(s!==-1){const o=Math.max(0,s-40),i=Math.min(e.contents.length,s+t.length+60);n=(o>0?"...":"")+e.contents.substring(o,i)+(i<e.contents.length?"...":"")}else n=e.contents.substring(0,100)+"...";return`
                <div class="search-result-item">
                    <a href="${e.permalink}">${e.title}</a>
                    <div class="search-date">${e.date}</div>
                    <div class="search-snippet">${n}</div>
                </div>
            `}).join("")}t.addEventListener("input",o(function(e){s(e.target.value.trim())},300)),document.addEventListener("click",function(n){!t.contains(n.target)&&!e.contains(n.target)&&(e.innerHTML="")}),t.addEventListener("focus",function(){this.value.length>=2&&s(this.value.trim())})})()</script></div></body></html>