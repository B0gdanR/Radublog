[{"categories":["Cloud"],"contents":"What is Windows Autopilot? This walkthrough assumes the tenant foundation is already in place. If you\u0026rsquo;re starting fresh Part 6 covers the enrollment controls, compliance baseline and ESP configuration that make this deployment easy to follow-up.\nWindows Autopilot is Microsoft\u0026rsquo;s cloud-based provisioning service that simplifies how organizations deploy Windows devices. Instead of manually imaging each endpoint, Autopilot leverages the factory installed Windows image and orchestrates device setup through Microsoft Intune and Microsoft Entra ID.\nWhen a user powers on a new device and connects to the internet, Autopilot takes over the Out-of-Box Experience, the device automatically joins Microsoft Entra ID, enrolls in Intune, receives assigned policies and applications and lands on a fully configured desktop, all without IT ever touching the hardware. OEMs and resellers can also register hardware hashes directly to an organization\u0026rsquo;s tenant, enabling true ship-to-user deployment scenarios.\nThis article covers two valid ways to register a device for Windows Autopilot.\nThe first is the traditional post-install method where the hardware hash is captured from a fully installed Windows desktop, the second is an alternative pre-OOBE approach that captures and uploads the hash earlier in the process.\nBoth methods work, the difference is where in the deployment lifecycle the registration happens and what trade-offs you’re willing to make.\nCredits and References The method I use in this article didn\u0026rsquo;t come from nowhere, it\u0026rsquo;s built on the work of several community members who documented their findings and shared them openly:\nMichael Niehaus - Connect the dots: Reverse-engineering an Autopilot hash (August 2022) Took apart the hardware hash structure byte by byte, explaining what\u0026rsquo;s actually inside that 4000-character Base64 string. Essential reading for understanding why certain capture methods work and others don\u0026rsquo;t.\nMichael Mardahl - Can you create a Autopilot Hash from WinPE? Yes! (January 2023) First showed that WinPE hash capture was possible using OA3Tool from the Windows ADK and documented the PCPKsp.dll requirement for TPM access.\nJohannes Bedrech - How to silently create an Autopilot Hardware Hash in WinPE and upload the Hash unattended (March 2024) Demonstrated unattended hash upload using Graph API with app registration, proving that the entire process could be automated without interactive login.\nTheir collective work gave me the foundation to develop an approach that fits my lab environment, if you\u0026rsquo;re interested in the deeper technical details or want to build something more advanced, start with their articles too.\nTwo Versions, One Goal With the introduction of Windows Autopilot Device Preparation (commonly called Autopilot v2) in mid-2024, there are now two different provisioning architectures available. This environment uses Autopilot v1 and here\u0026rsquo;s why.\nAutopilot v2 brings genuine improvements: better reporting with direct client telemetry, enrollment time grouping that speeds up device registration and intelligent app sequencing that installs non-blocking apps in the background. The architecture is modern and the reporting is noticeably more accurate. Microsoft has recently increased the OOBE app limit from 10 to 25 (January 30, 2026), addressing one of the original deployment constraints.\nAs of early 2026, several promised features are still not available. Pre-provisioning (White Glove), self-deploying mode, hybrid Azure AD join, OOBE customization and device naming control are still missing, Microsoft\u0026rsquo;s FAQ says these will be supported \u0026ldquo;in the future\u0026rdquo; the same language used at launch.\nThe original 10-app blocking limit during OOBE was a deliberate design choice. Microsoft\u0026rsquo;s telemetry showed 90% of deployments use 10 or fewer apps and the limit improved stability. The philosophy made sense: install essential apps during provisioning, deliver everything else once the user reaches the desktop. The new 25 app limit acknowledges that enterprise environments often need more flexibility, though Microsoft still recommends reviewing timeout settings when deploying larger app payloads.\nWhat\u0026rsquo;s harder to work around is local troubleshooting, in v1 pressing Ctrl+Shift+D during the Enrollment Status Page opens a diagnostics view showing exactly what\u0026rsquo;s happening: which policies are applying, which apps are installing, where things are stuck but in v2 that doesn\u0026rsquo;t exist. The community diagnostic scripts don\u0026rsquo;t work with the new architecture either. Troubleshooting means checking the Intune portal remotely, which isn\u0026rsquo;t always practical when a technician is standing in front of a stuck device.\nThe Decision for This Environment This environment is intentionally scoped as a lab and learning platform. The goal here is speed, repeatability and understanding how Autopilot behaves, not fully unattended factory-scale automation. In large enterprise deployments different trade-offs are often justified due to scale and operational complexity. However for learning scenarios and smaller lab environments like mine, prioritizing simplicity typically leads to faster troubleshooting and an overall smoother deployment experience.\nIn my Intune tenant I\u0026rsquo;m using Autopilot v1 with user-driven Microsoft Entra join, device naming templates and an ESP configuration. The requirements here include device naming control, reliable local troubleshooting during pilot testing and the flexibility that comes with a mature, well-documented provisioning method.\nThe door remains open to revisit v2 once Microsoft delivers the promised features, until then v1 remains the practical choice for production workloads.\nMicrosoft\u0026rsquo;s documentation makes Autopilot sound simple: register a hardware hash, assign a profile and ship the device but what they don\u0026rsquo;t emphasize enough is how that hash gets there in the first place.\nLarge enterprises have it easy: Dell, HP and Lenovo will pre-register hashes at the factory for a fee (or included in enterprise contracts) then devices arrive in Intune before they leave the warehouse, zero IT effort zero hassle.\nThe rest of us? We\u0026rsquo;re left with the \u0026ldquo;traditional\u0026rdquo; method: install Windows, complete OOBE, run PowerShell scripts, upload a CSV, wait for sync, then reset the entire device just to trigger Autopilot. For a single laptop that\u0026rsquo;s 30-45 minutes of work. For a fleet of 50? Well\u0026hellip;\nFive Ways to Get a Hash Into Intune Method Best For Trade-off OEM Pre-Registration Enterprises with vendor contracts Per-device fees, must order through specific channels SCCM Built-in Report Organizations migrating from ConfigMgr Devices must already be SCCM-managed Post-Install PowerShell One-off devices, quick testing Requires device reset after registration WinPE/Custom ISO SMBs, consultants, labs, refurbished devices Unofficial method (but proven at scale) Autopilot Device Preparation (v2) Future-forward Windows 11 environments No Hybrid Join, limited features (for now) There\u0026rsquo;s yet another option that sits in the gap between \u0026ldquo;pay Dell to do it\u0026rdquo; and \u0026ldquo;waste an hour per device.\u0026rdquo;\nIt’s important to be clear about support boundaries, this approach uses supported Microsoft tools and APIs but combines them in a way that isn’t explicitly documented by Microsoft for Autopilot registration. While not officially endorsed, it has been used reliably by the community at scale for several years.\nThe practical impact of this is simple: Autopilot is ready before OOBE starts. There’s no need to complete setup, upload a CSV, wait for sync and then reset the device, the deployment happens in a single pass.\nMike Terrill from MDM Tech Space put it best: \u0026ldquo;We are using this method now for more than 4 years and more than 15,000 devices without any issues.\u0026rdquo; Microsoft may not officially endorse it, but 15,000 successful deployments speaks for itself.\nWho Actually Needs This? Not everyone! If you\u0026rsquo;re ordering 500 laptops from Dell with an enterprise agreement, let them handle registration. If you\u0026rsquo;re running SCCM, the built-in Autopilot report already has your hashes.\nBut if you\u0026rsquo;re:\nA consultant deploying across multiple client tenants An SMB buying devices from Best Buy or Amazon Running a lab environment with VMs that get rebuilt weekly Handling refurbished or donated hardware Supporting remote offices where shipping devices to HQ isn\u0026rsquo;t practical \u0026hellip;then the OEM path doesn\u0026rsquo;t exist for you and the post-install-then-reset dance gets old fast.\nHow My Approach Differs This method is simpler built for a lab environment where speed and repeatability matter more than automation at scale.\nAspect Community Methods My Approach Environment Custom WinPE, SCCM Task Sequences, Symantec ITMS VMware Workstation with standard Windows 11 ISO Hash Capture OA3Tool in WinPE before OS install Get-WindowsAutoPilotInfo after OS install Authentication App Registration with client secret (unattended) Interactive sign-in with -Online parameter Upload Method Custom PowerShell scripts calling Graph API Built-in script handles everything Infrastructure Requires ADK, custom ISO builds or deployment tools No extra tools beyond the VM and PowerShell Target Use Case Enterprise deployment at scale Lab testing, learning, small environments Selecting the Right Level of Complexity The community approaches highlighted earlier solve real enterprise challenges: zero-touch deployment, deep tooling integration and fully unattended authentication workflows designed for scale.\nMy environment has different priorities, it’s a controlled lab focused on testing configurations, validating behavior and building operational understanding rather than provisioning hundreds of devices.\nIn this context simplicity is an advantage, three PowerShell commands and an interactive sign-in are enough to register the device in minutes, allowing the focus to remain on Autopilot behavior instead of deployment infrastructure.\nRegistering the Device for Autopilot The Traditional Method This is the approach I\u0026rsquo;ve used most of the time: install Windows 11 first, create a local admin account, then capture the hardware hash from the desktop. It\u0026rsquo;s not the fastest method available but it\u0026rsquo;s reliable and doesn\u0026rsquo;t require any additional infrastructure.\nAfter quickly walking through this method, I\u0026rsquo;ll share a newer approach I\u0026rsquo;ve been exploring that simplifies the process further, for now here\u0026rsquo;s the straightforward path.\nOpen PowerShell as Administrator and run these three commands:\nInstall-Script -Name Get-WindowsAutoPilotInfo -Force Set-ExecutionPolicy RemoteSigned -Scope CurrentUser -Force Get-WindowsAutoPilotInfo -Online -GroupTag \u0026ldquo;A-RO-U-D-V\u0026rdquo;\nFirst-time authentication on a fresh device shows the \u0026ldquo;Let\u0026rsquo;s get you signed in\u0026rdquo; dialog asking you to choose between Microsoft account or Work/school account. On devices where you\u0026rsquo;ve previously authenticated, WAM remembers your account and shows \u0026ldquo;Pick an account\u0026rdquo; instead.\n[!Note] As of December 2025 (Microsoft Graph PowerShell SDK v2.34) the authentication experience changed from browser-based to Windows Account Manager (WAM). You\u0026rsquo;ll see a native Windows dialog asking to select \u0026ldquo;Work or school account\u0026rdquo; instead of a browser popup.\nOnce authenticated the script connects to Microsoft Graph, gathers the hardware details and uploads the hash to the Intune tenant. The process typically takes 2-4 minutes ending with a confirmation that the device was imported successfully:\nThe device is now registered in Intune with Autopilot profile assigned:\nAfter the import completes reset the device (Reset this PC). On the next boot, Autopilot will recognize the hardware hash and apply the assigned deployment profile.\nBut you know that road, you know exactly where it ends and I know that is not where you want to be.\nThe Alternative method Some guides recommend creating an App Registration with a client secret for unattended uploads, however this stores credentials in plain text, a security risk also flagged by Michael Niehaus in his article so instead I use Device Code Flow which authenticates via my phone each time, requiring no stored secrets.\nThis is a conscious trade-off, I’m choosing interactive authentication over full automation to avoid embedding long-lived credentials in scripts or media. In a lab environment requiring a human approval step is acceptable and significantly reduces risk.\nDevice Code Flow allows a script to authenticate to Microsoft Graph without storing any credentials. Instead of embedding a client secret, the script displays a one-time code and pauses until the admin signs in on another trusted device with MFA. A short-lived access token is issued only after approval, leaving no secrets embedded in the ISO or stored on the device.\nThese are the files originally created into my location \u0026ldquo;C:\\AutopilotUSB\u0026rdquo; that get copied to the ISO:\nFile Size Purpose oa3tool.exe 454 KB Microsoft OEM Activation tool (extracts hardware hash) OA3.cfg 1 KB Configuration file for oa3tool PCPKsp.dll 1,148 KB TPM Key Storage Provider for attestation Create_4kHash_using_OA3_Tool.ps1 2 KB Converts OA3.xml to Autopilot CSV format Upload_AutopilotHash.ps1 5 KB Uploads hash to Intune via Device Code Flow CaptureHash.cmd 1 KB Orchestrates the entire capture and upload process Creating the staging folder: With these commands I\u0026rsquo;ve created a staging folder called \u0026ldquo;C:\\AutopilotUSB\u0026rdquo; to collect all the files needed for the custom ISO, then I\u0026rsquo;ve copied oa3tool.exe from the Microsoft Windows Assessment and Deployment Kit (ADK) installation, this is Microsoft\u0026rsquo;s OEM Activation 3.0 tool that extracts hardware identifiers from the device\u0026rsquo;s SMBIOS and TPM to generate the Autopilot hash:\nNew-Item -Path \u0026#34;C:\\AutopilotUSB\u0026#34; -ItemType Directory -Force Copy-Item \u0026#34;C:\\Program Files (x86)\\Windows Kits\\10\\Assessment and Deployment Kit\\Deployment Tools\\amd64\\Licensing\\OA30\\oa3tool.exe\u0026#34; -Destination \u0026#34;C:\\AutopilotUSB\\\u0026#34; Creating the custom OA3.cfg file This configuration file tells oa3tool.exe where to write its output. The tool generates two files: OA3.bin (binary format used by OEMs for factory injection) and OA3.xml (XML containing the hardware hash). We only care about the XML file since that\u0026rsquo;s what our PowerShell script will parse to extract the hash:\n\u0026lt;OA3\u0026gt; \u0026lt;FileBased\u0026gt; \u0026lt;InputKeyXMLFile\u0026gt;\u0026#34;.\\input.XML\u0026#34;\u0026lt;/InputKeyXMLFile\u0026gt; \u0026lt;/FileBased\u0026gt; \u0026lt;OutputData\u0026gt; \u0026lt;AssembledBinaryFile\u0026gt;.\\OA3.bin\u0026lt;/AssembledBinaryFile\u0026gt; \u0026lt;ReportedXMLFile\u0026gt;.\\OA3.xml\u0026lt;/ReportedXMLFile\u0026gt; \u0026lt;/OutputData\u0026gt; \u0026lt;/OA3\u0026gt; Copying PCPKsp.dll from System32 With these commands I\u0026rsquo;ve first verified that PCPKsp.dll exists in the System32 folder then copied it to my staging folder. This DLL is the Platform Crypto Provider Key Storage Provider, a dependency that oa3tool.exe needs to communicate with the TPM and extract attestation data. Without this file registered in WinPE the hardware hash generation fails silently.\nAt this point the staging folder contains three files: oa3tool.exe, OA3.cfg (which I created manually) and PCPKsp.dll. The remaining three files are PowerShell scripts that handle the CSV conversion and upload to Intune.\nTest-Path \u0026#34;C:\\Windows\\System32\\PCPKsp.dll\u0026#34; Copy-Item \u0026#34;C:\\Windows\\System32\\PCPKsp.dll\u0026#34; -Destination \u0026#34;C:\\AutopilotUSB\\\u0026#34; -Force Creating the custom PS script \u0026ldquo;Create_4kHash_using_OA3_Tool.ps1\u0026rdquo; This new custom PS script bridges the gap between oa3tool.exe output and what Intune expects. The OA3 tool generates an XML file with the hardware hash buried inside XML nodes. This script extracts the hash and serial number, then formats them into the exact CSV structure that Intune\u0026rsquo;s Autopilot import API requires: three columns with Device Serial Number, Windows Product ID (left empty) and Hardware Hash. Without this conversion step, you\u0026rsquo;d be manually copy-pasting Base64 strings.\nparam( [Parameter(Mandatory=$false)] [string]$OutputFile = \u0026#34;.\\AutopilotHash.csv\u0026#34; ) $ScriptDir = Split-Path -Parent $MyInvocation.MyCommand.Path # Check if OA3.xml exists (generated by oa3tool.exe) $OA3XML = Join-Path $ScriptDir \u0026#34;OA3.xml\u0026#34; if (-not (Test-Path $OA3XML)) { Write-Error \u0026#34;OA3.xml not found. Run oa3tool.exe first!\u0026#34; exit 1 } # Parse the XML [xml]$xml = Get-Content $OA3XML # Extract values $HardwareHash = $xml.Key.HardwareHash $SerialNumber = $xml.Key.ProductKeyInfo.SmbiosSystemSerialNumber if ([string]::IsNullOrEmpty($HardwareHash)) { Write-Error \u0026#34;Hardware hash not found in OA3.xml\u0026#34; exit 1 } # Create CSV content $csvContent = @\u0026#34; Device Serial Number,Windows Product ID,Hardware Hash $SerialNumber,,$HardwareHash \u0026#34;@ # Write to file $csvContent | Out-File -FilePath $OutputFile -Encoding ASCII -Force Write-Host \u0026#34;SUCCESS: Hash exported to $OutputFile\u0026#34; -ForegroundColor Green Write-Host \u0026#34;Serial Number: $SerialNumber\u0026#34; -ForegroundColor Cyan Creating the custom PS script \u0026ldquo;Upload_AutopilotHash.ps1\u0026rdquo; This is where the magic happens, instead of manually uploading the CSV through the Intune portal (Devices -\u0026gt; Enroll devices -\u0026gt; Import), this script uses Microsoft Graph API to register the device directly. It uses device code flow for authentication which is perfect for WinPE where you can\u0026rsquo;t open a browser.\nYou can authenticate on your phone or another PC, manually entering the code shown on screen and the script handles the rest: uploading the hash, applying your GroupTag and triggering an Autopilot sync. The device is ready for Autopilot before Windows even finishes installing:\nparam( [Parameter(Mandatory=$false)] [string]$CsvFile = \u0026#34;X:\\Autopilot\\AutopilotHash.csv\u0026#34;, [Parameter(Mandatory=$false)] [string]$GroupTag = \u0026#34;A-RO-U-D-V\u0026#34; ) # Microsoft Graph PowerShell App ID (public, safe to use) $ClientID = \u0026#34;14d82eec-204b-4c2f-b7e8-296a70dab67e\u0026#34; Write-Host \u0026#34;\u0026#34; Write-Host \u0026#34;==========================================\u0026#34; -ForegroundColor Cyan Write-Host \u0026#34; Autopilot Hash Upload - Secure Edition\u0026#34; -ForegroundColor Cyan Write-Host \u0026#34;==========================================\u0026#34; -ForegroundColor Cyan Write-Host \u0026#34;\u0026#34; # Check CSV exists if (-not (Test-Path $CsvFile)) { Write-Error \u0026#34;CSV file not found: $CsvFile\u0026#34; exit 1 } # Read CSV $csv = Import-Csv $CsvFile $SerialNumber = $csv.\u0026#39;Device Serial Number\u0026#39; $HardwareHash = $csv.\u0026#39;Hardware Hash\u0026#39; Write-Host \u0026#34;Device Serial: $SerialNumber\u0026#34; -ForegroundColor Yellow Write-Host \u0026#34;Group Tag: $GroupTag\u0026#34; -ForegroundColor Yellow Write-Host \u0026#34;\u0026#34; # === DEVICE CODE FLOW === Write-Host \u0026#34;[1/4] Requesting device code...\u0026#34; -ForegroundColor Green $deviceCodeRequest = @{ client_id = $ClientID scope = \u0026#34;https://graph.microsoft.com/DeviceManagementServiceConfig.ReadWrite.All offline_access\u0026#34; } $deviceCodeResponse = Invoke-RestMethod -Method Post ` -Uri \u0026#34;https://login.microsoftonline.com/organizations/oauth2/v2.0/devicecode\u0026#34; ` -Body $deviceCodeRequest # Display code to user Write-Host \u0026#34;\u0026#34; Write-Host \u0026#34;==========================================\u0026#34; -ForegroundColor Yellow Write-Host \u0026#34; ACTION REQUIRED:\u0026#34; -ForegroundColor Yellow Write-Host \u0026#34;\u0026#34; Write-Host \u0026#34; 1. On your phone or PC, open:\u0026#34; -ForegroundColor White Write-Host \u0026#34; https://microsoft.com/devicelogin\u0026#34; -ForegroundColor Cyan Write-Host \u0026#34;\u0026#34; Write-Host \u0026#34; 2. Enter code: $($deviceCodeResponse.user_code)\u0026#34; -ForegroundColor White -BackgroundColor DarkBlue Write-Host \u0026#34;\u0026#34; Write-Host \u0026#34; 3. Sign in and approve\u0026#34; -ForegroundColor White Write-Host \u0026#34;==========================================\u0026#34; -ForegroundColor Yellow Write-Host \u0026#34;\u0026#34; Write-Host \u0026#34;Waiting for authentication...\u0026#34; -ForegroundColor Gray # Poll for token $tokenRequest = @{ grant_type = \u0026#34;urn:ietf:params:oauth:grant-type:device_code\u0026#34; client_id = $ClientID device_code = $deviceCodeResponse.device_code } $timeout = [DateTime]::Now.AddSeconds($deviceCodeResponse.expires_in) $token = $null while ([DateTime]::Now -lt $timeout -and -not $token) { Start-Sleep -Seconds 5 try { $tokenResponse = Invoke-RestMethod -Method Post ` -Uri \u0026#34;https://login.microsoftonline.com/organizations/oauth2/v2.0/token\u0026#34; ` -Body $tokenRequest $token = $tokenResponse.access_token } catch { # Still waiting for user to authenticate } } if (-not $token) { Write-Error \u0026#34;Authentication timed out!\u0026#34; exit 1 } Write-Host \u0026#34;[2/4] Authentication successful!\u0026#34; -ForegroundColor Green # Prepare headers $headers = @{ \u0026#34;Authorization\u0026#34; = \u0026#34;Bearer $token\u0026#34; \u0026#34;Content-Type\u0026#34; = \u0026#34;application/json\u0026#34; } # Prepare device data $deviceData = @{ \u0026#34;@odata.type\u0026#34; = \u0026#34;#microsoft.graph.importedWindowsAutopilotDeviceIdentity\u0026#34; \u0026#34;groupTag\u0026#34; = $GroupTag \u0026#34;serialNumber\u0026#34; = $SerialNumber \u0026#34;hardwareIdentifier\u0026#34; = $HardwareHash } $jsonBody = $deviceData | ConvertTo-Json # Upload to Intune Write-Host \u0026#34;[3/4] Uploading to Intune...\u0026#34; -ForegroundColor Green try { $uploadResponse = Invoke-RestMethod -Method Post ` -Uri \u0026#34;https://graph.microsoft.com/v1.0/deviceManagement/importedWindowsAutopilotDeviceIdentities\u0026#34; ` -Headers $headers -Body $jsonBody Write-Host \u0026#34; Upload successful!\u0026#34; -ForegroundColor Green } catch { Write-Error \u0026#34;Upload failed: $_\u0026#34; exit 1 } # Trigger sync Write-Host \u0026#34;[4/4] Triggering Autopilot sync...\u0026#34; -ForegroundColor Green try { Invoke-RestMethod -Method Post ` -Uri \u0026#34;https://graph.microsoft.com/v1.0/deviceManagement/windowsAutopilotSettings/sync\u0026#34; ` -Headers $headers | Out-Null Write-Host \u0026#34; Sync triggered!\u0026#34; -ForegroundColor Green } catch { Write-Host \u0026#34; Sync skipped (non-critical)\u0026#34; -ForegroundColor Yellow } Write-Host \u0026#34;\u0026#34; Write-Host \u0026#34;==========================================\u0026#34; -ForegroundColor Cyan Write-Host \u0026#34; SUCCESS! Device uploaded to Autopilot\u0026#34; -ForegroundColor Green Write-Host \u0026#34; Serial: $SerialNumber\u0026#34; -ForegroundColor White Write-Host \u0026#34; GroupTag: $GroupTag\u0026#34; -ForegroundColor White Write-Host \u0026#34;==========================================\u0026#34; -ForegroundColor Cyan Write-Host \u0026#34;\u0026#34; Creating a Custom Windows 11 ISO with Embedded Autopilot Scripts The standard approach to Autopilot device registration involves booting a fully installed Windows system, running PowerShell scripts to capture the hardware hash, then uploading it to Intune. This works but it means you\u0026rsquo;re either re-imaging the device afterward or manually running scripts on every new machine.\nInstead I\u0026rsquo;ve wanted something cleaner: capture the hardware hash during Windows Setup, before the OS even touches the disk, then continue straight into installation. The device registers with Autopilot while I\u0026rsquo;m still at the first setup screen and by the time OOBE loads Intune already knows about it.\nTo make this work I\u0026rsquo;ve needed to customize the Windows 11 installer\u0026rsquo;s boot image (boot.wim). The default boot.wim is intentionally minimal and it doesn\u0026rsquo;t include PowerShell and network initialization only happens when Setup.exe needs it and there\u0026rsquo;s no way to run custom scripts. So by injecting the optional WinPE components along with my Autopilot custom PS scripts directly into the boot image, I\u0026rsquo;ve created a self-contained ISO that handles everything automatically.\nThe process involves mounting the boot.wim, adding PowerShell support and network drivers, copying the six Autopilot files we prepared earlier, then rebuilding the ISO. The result is a Windows 11 installer that doubles as an Autopilot registration tool, press Shift+F10 at the first screen, run one command, authenticate on your phone and you\u0026rsquo;re done.\nStep 1: Create Working Directories Two folders keep things organized: Mount is where we\u0026rsquo;ll temporarily extract the boot image for editing, and ISO_Files holds the complete Windows installation media we\u0026rsquo;ll modify and repackage.\nNew-Item -Path \u0026#34;C:\\ISO_Build\\Mount\u0026#34; -ItemType Directory -Force New-Item -Path \u0026#34;C:\\ISO_Build\\ISO_Files\u0026#34; -ItemType Directory -Force Step 2: Mount and Extract Windows 11 ISO We mount the original Windows 11 ISO as a virtual drive, copy everything to the working directory, then dismount. Working with a copy means we can always start fresh if something goes wrong and the original media stays untouched.\n# Mount the Windows 11 ISO Mount-DiskImage -ImagePath \u0026#34;C:\\ISO\\Windows11_v25H2.iso\u0026#34; # Verify the mounted drive letter Get-Volume | Where-Object { $_.DriveType -eq \u0026#39;CD-ROM\u0026#39; } # Copy all ISO contents to working directory (adjust drive letter if needed) Copy-Item -Path \u0026#34;J:\\*\u0026#34; -Destination \u0026#34;C:\\ISO_Build\\ISO_Files\u0026#34; -Recurse -Force # Dismount the ISO Dismount-DiskImage -ImagePath \u0026#34;C:\\ISO\\Windows11_v25H2.iso\u0026#34; Step 3: Prepare boot.wim for Editing The boot.wim file contains Windows Setup (the environment you see during installation). Files extracted from an ISO inherit read-only attributes, so we clear that first.\nIndex 2 is Windows Setup itself, Index 1 is Windows Recovery Environment which we don\u0026rsquo;t need to modify.\n# Remove read-only attribute from boot.wim Set-ItemProperty -Path \u0026#34;C:\\ISO_Build\\ISO_Files\\sources\\boot.wim\u0026#34; -Name IsReadOnly -Value $false # Mount boot.wim Index 2 (Windows Setup) Mount-WindowsImage -ImagePath \u0026#34;C:\\ISO_Build\\ISO_Files\\sources\\boot.wim\u0026#34; -Index 2 -Path \u0026#34;C:\\ISO_Build\\Mount\u0026#34; Step 4: Add WinPE Optional Components (PowerShell Support) Here\u0026rsquo;s where one might get stuck, the default Windows Setup environment doesn\u0026rsquo;t include PowerShell, it\u0026rsquo;s intentionally minimal. We need to inject the WinPE optional components from the Windows ADK, and order matters.\nPowerShell depends on Scripting which depends on NetFX which depends on WMI. Skip a dependency or install out of order and PowerShell won\u0026rsquo;t load. Each component also needs its language pack (en-us cab files) or you\u0026rsquo;ll get cryptic errors:\n# Define paths $OCPath = \u0026#34;C:\\Program Files (x86)\\Windows Kits\\10\\Assessment and Deployment Kit\\Windows Preinstallation Environment\\amd64\\WinPE_OCs\u0026#34; $MountPath = \u0026#34;C:\\ISO_Build\\Mount\u0026#34; # Add components in dependency order #1. WMI Dism /Add-Package /Image:\u0026#34;$MountPath\u0026#34; /PackagePath:\u0026#34;$OCPath\\WinPE-WMI.cab\u0026#34; Dism /Add-Package /Image:\u0026#34;$MountPath\u0026#34; /PackagePath:\u0026#34;$OCPath\\en-us\\WinPE-WMI_en-us.cab\u0026#34; #2. NetFX Dism /Add-Package /Image:\u0026#34;$MountPath\u0026#34; /PackagePath:\u0026#34;$OCPath\\WinPE-NetFX.cab\u0026#34; Dism /Add-Package /Image:\u0026#34;$MountPath\u0026#34; /PackagePath:\u0026#34;$OCPath\\en-us\\WinPE-NetFX_en-us.cab\u0026#34; #3. Scripting Dism /Add-Package /Image:\u0026#34;$MountPath\u0026#34; /PackagePath:\u0026#34;$OCPath\\WinPE-Scripting.cab\u0026#34; Dism /Add-Package /Image:\u0026#34;$MountPath\u0026#34; /PackagePath:\u0026#34;$OCPath\\en-us\\WinPE-Scripting_en-us.cab\u0026#34; #4. PowerShell Dism /Add-Package /Image:\u0026#34;$MountPath\u0026#34; /PackagePath:\u0026#34;$OCPath\\WinPE-PowerShell.cab\u0026#34; Dism /Add-Package /Image:\u0026#34;$MountPath\u0026#34; /PackagePath:\u0026#34;$OCPath\\en-us\\WinPE-PowerShell_en-us.cab\u0026#34; #5. StorageWMI Dism /Add-Package /Image:\u0026#34;$MountPath\u0026#34; /PackagePath:\u0026#34;$OCPath\\WinPE-StorageWMI.cab\u0026#34; Dism /Add-Package /Image:\u0026#34;$MountPath\u0026#34; /PackagePath:\u0026#34;$OCPath\\en-us\\WinPE-StorageWMI_en-us.cab\u0026#34; Step 5: Copy Autopilot Scripts to Mounted Image This places the six files (CaptureHash.cmd, oa3tool.exe, PCPKsp.dll, OA3.cfg and both PowerShell scripts) into the boot image at X:\\Autopilot. When Windows Setup launches these files are immediately available without needing external media:\n# Create Autopilot folder in mounted image New-Item -Path \u0026#34;C:\\ISO_Build\\Mount\\Autopilot\u0026#34; -ItemType Directory -Force # Copy all 6 files from staging folder Copy-Item -Path \u0026#34;C:\\AutopilotUSB\\*\u0026#34; -Destination \u0026#34;C:\\ISO_Build\\Mount\\Autopilot\\\u0026#34; -Force # Verify files copied Get-ChildItem \u0026#34;C:\\ISO_Build\\Mount\\Autopilot\u0026#34; Step 6: Add VMware Network Drivers (Optional - for VMware VMs) If you\u0026rsquo;re testing in VMware Workstation like I am, the default boot.wim doesn\u0026rsquo;t include vmxnet3 drivers. Without network connectivity the upload script can\u0026rsquo;t reach Microsoft Graph. Physical hardware or Hyper-V users can skip this step their drivers are already included.\nDism /Add-Driver /Image:\u0026#34;C:\\ISO_Build\\Mount\u0026#34; /Driver:\u0026#34;C:\\Program Files\\Common Files\\VMware\\Drivers\\vmxnet3\\Win11_24H2\u0026#34; /Recurse Step 7: Unmount and Save Changes The -Save parameter commits all our modifications back to boot.wim, without it dismounting would discard everything. This step can take a few minutes depending on how many components were added:\nDismount-WindowsImage -Path \u0026#34;C:\\ISO_Build\\Mount\u0026#34; -Save Step 8: Create Bootable ISO oscdimg.exe from the Windows ADK combines everything into a bootable ISO, the -bootdata parameter is the critical piece it configures both BIOS boot (etfsboot.com) and UEFI boot (efisys.bin) making the ISO work on any system regardless of firmware type. The result is a standard Windows 11 installer with our Autopilot automation baked in:\n# Remove old ISO if exists Remove-Item \u0026#34;C:\\ISO\\Windows11_Autopilot_25H2.iso\u0026#34; -Force -ErrorAction SilentlyContinue # Create new bootable ISO using oscdimg $OscdimgPath = \u0026#34;C:\\Program Files (x86)\\Windows Kits\\10\\Assessment and Deployment Kit\\Deployment Tools\\amd64\\Oscdimg\\oscdimg.exe\u0026#34; \u0026amp; $OscdimgPath -m -o -u2 -udfver102 ` -bootdata:2#p0,e,b\u0026#34;C:\\ISO_Build\\ISO_Files\\boot\\etfsboot.com\u0026#34;#pEF,e,b \u0026#34;C:\\ISO_Build\\ISO_Files\\efi\\microsoft\\boot\\efisys.bin\u0026#34; ` \u0026#34;C:\\ISO_Build\\ISO_Files\u0026#34; ` \u0026#34;C:\\ISO\\Windows11_Autopilot_25H2.iso\u0026#34; Using the Custom ISO: Autopilot Registration in Action Verifying the Embedded Scripts After mounting and booting from the custom ISO and pressing Shift+F10 at the Windows Setup screen, I\u0026rsquo;ve navigated to the Autopilot folder to verify all six files were successfully embedded in the boot image:\nX:\\\u0026gt;cd Autopilot X:\\Autopilot\u0026gt;dir All six files are present and accessible at X:\\Autopilot exactly where I\u0026rsquo;ve placed them while customizing the boot.wim. The X: drive is the WinPE RAM disk that loads from boot.wim during Windows Setup. With everything confirmed just launched the capture script by typing CaptureHash.cmd:\nRunning CaptureHash.cmd - Hash Generation and Device Code Prompt The script now displays a temporary device code DVJ9C2UY6 and waits for me to authenticate. Notice the Device Serial field is empty, this is expected on VMware VMs where OA3Tool reads from SMBIOS Type 1 which contains no serial number. The GroupTag A-RO-U-D-V is automatically applied based on the parameter in CaptureHash.cmd:\n[!Note] This guide covers a single GroupTag scenario so if your organization uses multiple GroupTags for different device configurations, the approach here would need to be extended. That\u0026rsquo;s outside the scope of this article for now.\nDevice Code Entry From your PC, laptop or phone open the URL https://microsoft.com/devicelogin and manually enter the code DVJ9C2UY6 displayed on the WinPE screen above. Device Code Flow is ideal for this scenario, the device being registered has no browser and can\u0026rsquo;t complete interactive authentication, but I can authenticate from any other device that can reach Microsoft\u0026rsquo;s login endpoint:\nAccount Selection Microsoft prompts me to select which account to use, the dialog confirms I\u0026rsquo;m signing into Microsoft Graph Command Line Tools, this being the public Microsoft Graph PowerShell application (App ID 14d82eec-204b-4c2f-b7e8-296a70dab67e) that my upload script uses. It also shows the sign-in request is coming from Romania, matching my location:\nMFA Challenge Because my tenant has MFA enforced via Conditional Access, I need to approve the sign-in through Microsoft Authenticator:\nConsent Confirmation A final confirmation asking whether I trust Microsoft Graph Command Line Tools. This appears because the app is requesting the DeviceManagementServiceConfig.ReadWrite.All permission scope to upload the device hash, clicking Continue grants the token:\nAuthentication Complete The browser confirms successful sign-in to Microsoft Graph Command Line Tools, I can now close this window since the token has been sent back to the WinPE script which is polling for it:\nSuccess - Device Uploaded to Autopilot Device uploaded to Autopilot with GroupTag A-RO-U-D-V has applied successfully, the device is now registered in Intune and will receive its Autopilot profile when OOBE starts.\nFrom here, I will simply close the command prompt, click Install now in Windows Setup and proceed with a normal Windows 11 OS installation. When the device reaches OOBE and connects to the internet, Autopilot recognizes it and applies the deployment profile, all without ever having to boot into Windows first.\nDevice Appears in Microsoft Entra ID Within minutes of the upload completing the device appears in Entra ID -\u0026gt; Devices -\u0026gt; All devices. The device name is the VMware generated UUID (VMware-56 4d e0 98 bb 81 a2 ca-18 c9 ad fe 29 50 a9 78) since VMware VMs don\u0026rsquo;t have traditional serial numbers in SMBIOS Type 1.\nKey details :\nJoin type: Microsoft Entra joined (pending and will complete during OOBE) MDM: None (not yet enrolled since the device hasn\u0026rsquo;t gone through OOBE yet) Registered: shows the exact time my script uploaded the hash The device exists in Entra ID but shows as Enabled: No because it hasn\u0026rsquo;t completed enrollment yet. This is expected since I\u0026rsquo;ve only registered the hardware hash, the actual device enrollment happens when Windows OOBE runs and Autopilot takes over:\nDevice Registered in Intune with Autopilot Profile Assigned The critical confirmation is Profile status: Assigned with the profile GBL_WIN11_Autopilot_AAD_ALL. Intune matched the device to my Autopilot profile based on the GroupTag A-RO-U-D-V and the dynamic device group targeting, the device will enroll and contact Intune when it boots into OOBE and completes the Autopilot flow.\nAt this point the device is fully staged, when I\u0026rsquo;ll continue with Windows installation and reach OOBE the new device will automatically receive its Autopilot profile, join Entra ID, enroll in Intune and apply all assigned policies and applications, all because I\u0026rsquo;ve registered the hash before the OS was even installed:\nThe Autopilot deployment process I\u0026rsquo;ve initiated a fresh Autopilot deployment in my test environment using a newly provisioned VMware Workstation VM. During OOBE I\u0026rsquo;ve authenticated with my Azure AD work account following the standard user-driven Autopilot process:\nAfter entering credentials I\u0026rsquo;ve received a number matching challenge, this confirmed that my Conditional Access policies are functioning as intended and enforcing MFA during device enrollment:\nESP Success The Enrollment Status Page completed successfully displaying the “All set!” message. At this stage my ESP blocking apps were all installed during the Device Setup phase confirming that the configuration behaved as expected in my tenant:\nThe device reached the lock screen fully provisioned and ready for sign-in. The presence of the work account sign-in option verified that the device was Azure AD joined and under Intune management.\nWindows Hello for Business PIN Setup Immediately after the first sign-in I was prompted to configure a Windows Hello for Business PIN, this prompt was triggered by my Windows Hello policy and enabled passwordless authentication backed by the device vTPM:\nThe completion message confirmed successful enrollment meaning the PIN is now cryptographically bound to the device and available for future authentication events:\nThe Company Portal reported the device 2025-2B3FCFB23B with a green “Can access company resources” status, this validated that the device passed all assigned compliance checks and is authorized to access corporate services:\nDsregcmd Diagnostic Data Every critical indicator in this dsregcmd output shows healthy status, the device is properly joined to Entra ID, protected by TPM, enrolled in Intune, has a valid PRT for SSO and passed all diagnostic checks:\nAzureAdJoined: YES - This is the green light you want to see, confirms the device has successfully joined Microsoft Entra ID and is now a trusted member of your cloud environment. The device can authenticate to cloud services, receive policies from Intune and participate in Conditional Access evaluation.\nEnterpriseJoined: NO - For a pure cloud deployment this simply means we\u0026rsquo;re not using an on-premises Device Registration Service with AD FS.\nDomainJoined: NO - The device isn\u0026rsquo;t joined to a traditional on-premises Active Directory domain.\nTpmProtected: YES - It means the device\u0026rsquo;s private key is stored in the hardware Trusted Platform Module not just in software. Even if malware compromises the operating system it cannot extract the device\u0026rsquo;s identity.\nDeviceAuthStatus: SUCCESS - The device just performed a live authentication test against Entra ID and passed, this confirms the device exists, is enabled and can successfully prove its identity to the cloud. If this ever shows FAILED, your device has been disabled or deleted in Entra ID.\nDeviceCertificateValidity - The device certificate is valid for 10 years from enrollment, this certificate is the device\u0026rsquo;s passport to the Microsoft cloud, renewed automatically as long as the device remains healthy.\nTenantName: HalfOnCloud - A quick confirmation that my device joined the correct organization.\nMdmUrl pointing to enrollment.manage.microsoft.com - This confirms Intune MDM enrollment is configured, the device knows where to check in for policies, apps and compliance requirements.\nNgcSet: YES - NGC stands for Next Generation Credential, Microsoft\u0026rsquo;s internal name for Windows Hello for Business. This confirms the user has successfully enrolled passwordless credentials on this device and can now sign in with a PIN or biometrics instead of typing their password.\nWamDefaultSet: YES - The Web Account Manager has a default organizational account configured, enabling seamless single sign-on across Windows and applications.\nAzureAdPrt: YES - This is arguably the most important field in the entire output, PRT stands for Primary Refresh Token and it\u0026rsquo;s the secret sauce behind single sign-on. When this shows YES the device has obtained a long-lived token that proves both the device and user identity, no password prompt, no MFA challenge, just seamless access.\nAzureAdPrtUpdateTime and ExpiryTime - The PRT refreshes automatically every four hours during normal device usage. The expiry time (14 days out) gives plenty of buffer as long as the device is used regularly the PRT stays fresh.\nCloudTgt: YES - Cloud Kerberos ticket is present, this enables seamless SSO to Azure resources that support Kerberos authentication, extending the SSO experience beyond just browser based access.\nKeySignTest: PASSED - The device just tested its ability to sign tokens using its private key and everything worked. This confirms the device certificate and TPM are functioning correctly, a FAILED result here would indicate serious issues requiring device re-registration.\nAadRecoveryEnabled: NO - The device is NOT in recovery mode, ff this ever shows YES the device keys have become unusable and the next sign-in will trigger a recovery flow to re-establish trust with Entra ID.\nDisplayNameUpdated: Managed by MDM - Even the device\u0026rsquo;s display name is controlled by Intune demonstrating full MDM authority over the device configuration.\nAccess Type: DIRECT - The device connects directly to the internet without any proxy interference. This clean network path ensures reliable communication with Microsoft cloud endpoints, misconfigured proxies are a notorious source of Autopilot and enrollment failures.\nMy custom GBL-WIN11-Compliance-Production policy reports the device as fully compliant across all configured controls, validating that encryption, Defender settings, password policies and platform security baselines were applied without conflict:\nFrom the Intune portal all required applications show Required install with an Installed status, confirming that application targeting and deployment executed successfully during provisioning:\nFinally the Access work or school settings page shows multiple management areas controlled by my tenant with device sync reporting as successful, a good hint that the MDM channel is healthy and policy refresh is operational:\nTroubleshooting: The Mysterious Sync Error The Conditional Access \u0026ldquo;Terms of Use\u0026rdquo; Gotchas After what seemed like a successful Autopilot deployment I\u0026rsquo;ve noticed an issues in the device settings, the Sync status showing a red error message: \u0026ldquo;Sync wasn\u0026rsquo;t fully successful because we weren\u0026rsquo;t able to verify your credentials.\u0026rdquo;\nAt first glance this made no sense the device was Azure AD joined, the user was authenticated and everything else appeared to be working. To understand what was happening I\u0026rsquo;ve queried the Azure AD sign-in logs using Microsoft Graph PowerShell finding repeated failures with error code \u0026ldquo;50158: External security challenge not satisfied\u0026rdquo;\nEvery single failure came from the \u0026ldquo;Device Management Client\u0026rdquo; application trying to authenticate to \u0026ldquo;Microsoft Intune\u0026rdquo;, the error message said the user would be redirected to satisfy additional authentication challenges but here\u0026rsquo;s the catch: the Device Management Client is a background service which cannot be redirected, cannot click buttons and cannot accept terms. Something in my Conditional Access configuration was demanding an interactive response from a non-interactive process:\n[!Note] For readers who want deeper context around my Conditional Access design I\u0026rsquo;ve covered the full policy architecture in Part 5. That article explains the rationale, targeting strategy and security strategy implemented, which directly influences how Autopilot authentication behaves as well.\nThe aha moment came when I\u0026rsquo;ve expanded the sign-in log to show which Conditional Access policies were evaluated and there it was: CA-005-Require-ToU-All-Users with a result of failure.\nInitially I\u0026rsquo;ve suspected CA-003 (MFA for all users) might be the problem since MFA also requires user interaction, but the logs told a different story CA-003 showed \u0026ldquo;notApplied\u0026rdquo; because MFA can be satisfied through existing token claims. The MFA requirement was already fulfilled by the user\u0026rsquo;s authenticated session.\nBut Terms of Use? Well that\u0026rsquo;s a different beast entirely, ToU requires someone to physically click \u0026ldquo;Accept\u0026rdquo; on a legal document, no token, claim or background process can do that for you.\nThe Fix: Excluding Intune Service Principals The fix was quite simple once I\u0026rsquo;ve understood the problem, I needed to exclude the Intune service principals from the Terms of Use policy, specifically these two:\nMicrosoft Intune (0000000a-0000-0000-c000-000000000000) - The core Intune service that handles device management operations. Microsoft Intune Enrollment (d4ebce55-015a-49b5-a083-c84d1797ae8c) - The service principal that handles device registration and enrollment. This is the critical one that was being blocked! But wait there\u0026rsquo;s more ! Apparently in newer Microsoft 365 tenants the \u0026ldquo;Microsoft Intune Enrollment\u0026rdquo; service principal simply doesn\u0026rsquo;t exist so you can\u0026rsquo;t exclude something from a Conditional Access policy if it doesn\u0026rsquo;t exist in your tenant\u0026rsquo;s Enterprise Applications, therefore I\u0026rsquo;ve used the following PowerShell script to create it manually:\n[!NOTE] If you\u0026rsquo;re setting up a new tenant and plan to use Conditional Access policies that target \u0026ldquo;All cloud apps,\u0026rdquo; run this script first, it only takes 30 seconds and prevents hours of troubleshooting mysterious device sync failures later.\nConnect-MgGraph -Scopes \u0026#39;Application.ReadWrite.All\u0026#39; $AppId = \u0026#39;d4ebce55-015a-49b5-a083-c84d1797ae8c\u0026#39; $ExistingSP = Get-MgServicePrincipal -Filter \u0026#34;appId eq \u0026#39;$AppId\u0026#39;\u0026#34; -ErrorAction SilentlyContinue if ($ExistingSP) { Write-Host \u0026#34;Microsoft Intune Enrollment already exists (ObjectId: $($ExistingSP.Id))\u0026#34; -ForegroundColor Green } else { $NewSP = New-MgServicePrincipal -AppId $AppId Write-Host \u0026#34;Microsoft Intune Enrollment created (ObjectId: $($NewSP.Id))\u0026#34; -ForegroundColor Green } The output confirms successful creation for \u0026ldquo;Microsoft Intune Enrollment\u0026rdquo;:\nWith this new service principal now existing in the tenant, I could finally select it into the Conditional Access policy exclusions. Without this step the exclusion list simply won\u0026rsquo;t show \u0026ldquo;Microsoft Intune Enrollment\u0026rdquo; as an option and my ToU or MFA policies would have continue blocking device sync silently:\nAfter adding these exclusions to CA-005 the device sync started working immediately, the background service could now communicate with Intune without being challenged to accept a Terms of Use document it could never click.\nFinal Notes I\u0026rsquo;ve implemented the Terms of Use policy following security best practices and MS-102 guidance. It seemed like a straightforward way to ensure users acknowledge company policies before accessing resources but what the documentation didn\u0026rsquo;t mention and what I had to discover through hours of troubleshooting was that this seemingly innocent policy would silently break device management.\nThis is exactly why testing Conditional Access policies in Report-Only mode before enforcement is so critical and why understanding the difference between interactive and non-interactive authentication flows can save you from sync failures that have nothing to do with sync at all.\nWhat\u0026rsquo;s next The next article answers those questions with real troubleshooting scenarios, diagnostic commands and the lessons learned from getting Autopilot to actually work in production.\n","date":"2026-02-04","permalink":"https://halfoncloud.com/posts/m365-business-premium-part-7-intune-autopilot/","tags":["MSIntune","EntraID","Autopilot"],"title":"M365 Business Premium Part 7: Intune Autopilot Deployment Walkthrough"},{"categories":["Cloud"],"contents":"Building a Production-Ready Intune Environment This article walks through an Intune environment built in a small lab tenant. The focus is on the foundation that needs to be in place before Windows Autopilot can work reliably: tenant readiness, enrollment controls, device targeting, ESP behavior and a security baseline that holds up under real use. Everything shown reflects actual configuration, including what is enabled and how the pieces connect together.\nThe environment is Windows-only and centered on User Driven Autopilot with Microsoft Entra join. The screenshots walk through tenant health, service connectors, dynamic device groups and Enrollment Status Page behavior along with a few optimizations.\nThis includes a deliberate ESP blocking app strategy where Company Portal, VMware Tools and Microsoft 365 Apps are required during Autopilot installation. Because this is a small environment made up entirely of VMware Workstation Pro VMs, including VMware Tools was easier and efficient ensuring full driver support especially for the display adapter, while the Skip User ESP configuration helps reduce delays right after enrollment.\nOn the security side this article focuses on establishing a clean and enforceable baseline before Autopilot comes into play. This includes Windows Hello for Business configured through the Settings Catalog, TPM backed credential protection suitable for virtual machines and a production style compliance policy that validates BitLocker, Secure Boot, Defender health, OS version, Firewall state and Defender for Endpoint risk level. Non compliance actions and user notifications are configured so policy enforcement is visible from both the admin and user perspectives.\nThink of this setup as the foundation along with a set of decisions that make the Autopilot experience in the next article stable, repeatable and easier to understand when something does not behave as expected.\nTenant Administration Overview Before looking at device policies and configurations, it helps to start with the health of the Intune tenant itself. The Tenant Admin | Tenant Status blade in the Intune admin center provides a quick snapshot of the foundation the rest of the configuration depends on.\nTenant Details The first tab shows basic tenant information such as tenant name, datacenter location, service release version, MDM authority, account status, total enrolled devices and available Intune licenses. This view makes it easy to confirm that the tenant is active, properly licensed and running on the expected service release.\nConnector Status The second tab shows the health of various connectors that integrate Intune with other services. For Windows-focused environments, the key connectors to watch are Windows Autopilot last sync date and Microsoft Defender for Endpoint Connector. A healthy status with recent sync timestamps means the tenant is communicating properly with these services.\nConnectors marked as not enabled are not an issue here. They simply reflect services that are not in scope for this environment. APNS and DEP apply to Apple devices, Google Play connectors apply to Android and JAMF is used for macOS management through a third party MDM.\nAutomatic Enrollment Configuration The Automatic Enrollment settings determine which users can enroll Windows devices into Intune MDM management, the MDM user scope being set to \u0026ldquo;All\u0026rdquo; which means any user in the tenant can enroll devices.\nThe three URLs from the screenshot below are the endpoints that Windows uses during enrollment, Microsoft\u0026rsquo;s default URLs and rarely need modification. The MDM terms of use URL points to a generic terms page, the discovery URL is how devices find the enrollment server and the compliance URL is where devices check their compliance status.\nNote: The Windows Information Protection (WIP) section at the bottom shows the deprecation notice, WIP is no longer supported for new deployments so the scope is set to \u0026ldquo;None\u0026rdquo;. Organizations still using WIP should plan their migration to Microsoft Purview Information Protection.\nWindows Data and Diagnostic Configuration Under Tenant Administration -\u0026gt; Connectors and tokens -\u0026gt; Windows data, two settings control diagnostic data collection for the tenant:\nWindows data enables features that require Windows diagnostic data in processor configuration. This unlocks detailed reporting capabilities for Windows Updates, including installation stages, error codes and failure reasons. Without this enabled only basic service-side data is available, not enough for a valuable troubleshooting.\nWindows license verification confirms the tenant has appropriate licensing for advanced features like Windows 11 Upgrade Readiness reports and Proactive Remediations, Microsoft 365 Business Premium includes the required licensing.\nThe Auto-Created Policy Here\u0026rsquo;s something that might catch some administrators off guard: when these settings are enabled and Endpoint Analytics is accessed for the first time, Intune automatically creates a configuration profile called \u0026ldquo;Intune data collection policy.\u0026rdquo; This isn\u0026rsquo;t something that needs to be manually configured since Intune generates it as part of the onboarding process.\nThis auto-created policy is a Windows health monitoring profile that deploys to all devices and enables the telemetry collection required for Endpoint Analytics. It configures devices to send startup performance metrics, application reliability scores and device health signals back to the Intune service.\nThe relationship works like this: the tenant-level toggle in Windows data enables the infrastructure, while the auto-created policy deploys the configuration to devices that actually collects and sends the data.\nNote: The policy can be safely renamed to match organizational naming conventions despite being auto-created, it\u0026rsquo;s a standard configuration profile under full administrative control.\nEndpoint Analytics Settings The Endpoint Analytics Settings page shows the data collection status for the tenant. The Intune data collection policy is listed as \u0026ldquo;Connected\u0026rdquo; which means devices are actively sending user experience data back to Intune. This telemetry powers the reports visible in the left navigation: Startup performance, Application reliability, Work from anywhere, Resource performance and Battery health.\nBelow that is the Configuration Manager data collection option which remains \u0026ldquo;Not connected\u0026rdquo; at least in my environment for the time being. This would only be relevant for organizations running a hybrid setup with on-premises Microsoft Configuration Manager (SCCM) and tenant attach configured.\nWindows Health Monitoring Profile This is the configuration profile that actually deploys to devices to enable health monitoring. The profile itself is straightforward with just two settings: Health monitoring set to Enable and Scope set to Endpoint analytics. This profile was auto-created when Endpoint Analytics was first accessed which I\u0026rsquo;ve also manually renamed to GBL-WIN11-EndpointAnalytics-(ALL) to align with my naming standards convention:\nWindows Enrollment Overview The Devices | Enrollment blade is the central hub for everything related to getting devices into Intune with various enrollment options available.\nOn the right side, the CNAME Validation panel confirms that the DNS records for the custom domain are configured properly. The green checkmark next to \u0026ldquo;CNAME for devworkplace.cloud is configured correctly\u0026rdquo; means users can enroll devices using their email addresses without needing to manually specify the MDM server address.\nBoth records can also be verified from the command line, the enterpriseenrollment record points to the Intune MDM enrollment endpoint while enterpriseregistration handles Azure AD device registration:\nThe page is organized into three sections:\nEnrollment options covers the day-to-day settings like automatic enrollment scope and device restrictions. Windows Autopilot device preparation is the newer v2 provisioning method. Windows Autopilot at the bottom contains the traditional v1 Autopilot components including device registration, deployment profiles and the Enrollment Status Page (ESP). Device Platform Restrictions Platform restrictions act as a gatekeeper for enrollment, determining which device types are allowed to enroll in the first place. This is different from compliance policies which evaluate devices after they are already enrolled.\nEach platform can be set to Allow or Block, the versions column lets you restrict enrollment to specific OS versions using the major.minor.build format. The Personally owned column controls whether users can enroll their personal devices or only corporate-owned devices.\nIn this environment the focus is currently on Windows virtual machines running in VMware Workstation for lab testing and learning purposes. The plan is to eventually bring mobile devices into management as well, likely starting with Android and then iOS down the road.\nVersion restrictions only apply to Company Portal enrollments not Autopilot. Devices are considered personally owned by default unless explicitly marked otherwise. Manufacturer restrictions are not supported for Windows since hardware comes from a wide range of vendors.\nDevice Limit Restrictions Device limit restrictions control how many devices each user can enroll in Intune. The default policy \u0026ldquo;All users and all devices\u0026rdquo; allows up to 10 devices per user which is usually sufficient for most scenarios.\nThis limit applies across all device types combined, if a user has enrolled 10 devices and tries to add another, the enrollment will be blocked until they remove an existing device. For organizations with users who legitimately need more devices, additional restriction policies can be created and assigned to specific groups with higher limits.\nNote: The priority system mentioned at the top means that if a user is targeted by multiple restriction policies, the one with the highest priority wins.\nAutopilot Deployment Profile My custom GBL_WIN11_Autopilot_AAD_ALL deployment profile defines how Windows devices behave during the Out of Box Experience when they are provisioned through Autopilot.\nThis profile is configured for User-Driven deployment with devices joining Microsoft Entra ID. That means the end user signs in during OOBE and the device is directly joined to Entra ID without any hybrid dependency. This keeps the flow simple and efficient for cloud-only environments.\nSeveral OOBE screens are intentionally hidden including Microsoft Software License Terms, Privacy settings and the option to change the account type. Hiding these screens shortens the setup flow and avoids unnecessary prompts that do not add value in a managed environment. The user account type is set to Standard which aligns with least-privilege practices and avoids handing out local admin rights by default.\nThe device naming strategy uses a template based on the hardware serial number. This ensures every device receives a predictable and unique name at enrollment time, without relying on manual input or post-deployment renaming.\nPre-provisioned deployment is disabled as this environment focuses on user-driven scenarios rather than technician-led staging. The profile is assigned to the GRP-Devices-Autopilot dynamic group, ensuring that any device matching the Autopilot targeting logic automatically receives the same deployment experience.\nEnrollment Status Page The GBL_WIN11_ESP_Standard_ALL Enrollment Status Page controls what happens after the Autopilot process starts and before the user is allowed to access the desktop.\nThe ESP is configured to show app and profile installation progress giving visibility into what is happening during setup. A time limit of 90 minutes is defined after which a clear and user-friendly error message is displayed if installation takes too long. Log collection and diagnostics are enabled which makes troubleshooting much easier when a deployment fails or stalls.\nDevice use is blocked until all required apps and profiles are installed, this is a deliberate choice to ensure the device reaches a known good state before it is handed over to the user. Users are not allowed to bypass errors or reset the device from the ESP, keeping the process controlled and predictable.\nWindows Updates during ESP are disabled in this setup, avoiding extending enrollment time and keeping update management under separate policies after the device is fully provisioned.\nA key part of this configuration is the blocking app list, in my environment three apps are required to complete before ESP finishes:\nCompany Portal Microsoft 365 Apps VMware Tools These apps were selected because they are foundational for usability and management. Company Portal enables user interaction with Intune, Microsoft 365 Apps provides immediate productivity and VMware Tools ensures proper driver support for the virtual machines used in the lab, especially for display and input performance.\nThe ESP is assigned to the same GRP-Devices-Autopilot group as the deployment profile, ensuring consistent behavior across all Autopilot enrolled devices. Devices are not released to users until the essentials are in place, while still providing visibility and diagnostics when something goes wrong.\nDynamic Group Configuration The GRP-Devices-Autopilot group is a dynamic security group used to automatically target devices that belong to this Autopilot deployment flow. Instead of assigning devices manually, membership is calculated based on metadata that is already present on Autopilot registered devices.\nThis group relies on an Autopilot GroupTag strategy, when a device is registered in Autopilot it is assigned a GroupTag value. That value is stored in Microsoft Entra ID as part of the device physical identifiers exposed through the devicePhysicalIds attribute.\nThe dynamic membership rule I\u0026rsquo;m using into my Intune tenant is this:\n(device.devicePhysicalIds -any (_ -contains \u0026ldquo;[OrderId]:A-RO-U-D-\u0026rdquo;))\nChecks whether any of the device physical identifiers contain the specified OrderId prefix. Devices that match the A-RO-U-D- pattern are automatically added to the group as soon as they appear in the tenant.\nUsing this approach provides a clean separation between different device types, environments, or deployment scenarios. GroupTags can be used to distinguish labs from production, regions, ownership models or enrollment flows without changing group logic later. New devices only need the correct GroupTag during registration and everything else follows automatically.\nIn my environment the dynamic group acts as the single entry point for Autopilot targeting. The Autopilot deployment profile, Enrollment Status Page, Skip User ESP configuration and related policies are all assigned to this group. This ensures that any device matching the GroupTag receives a consistent and predictable configuration from the moment enrollment begins.\nThe main advantage of this model is scalability and control. As the environment grows new devices can be onboarded simply by assigning the correct GroupTag with no need to touch group assignments or policy scope again.\nSkip User ESP Configuration The GBL-WIN11-Autopilot-SkipUserESP-(ALL) policy exists to solve a very specific Autopilot annoyance: the User ESP phase often adds time and unpredictability without providing much value once the device side of provisioning is already complete.\nIn a user driven Autopilot flow ESP normally runs in two stages, the device phase installs device targeted apps and policies followed by the user phase, which waits for user targeted assignments to complete before allowing access to the desktop. In practice this second phase is frequently where delays occur especially when user scoped apps like Company Portal are involved.\nThis policy uses a custom OMA-URI setting to explicitly skip the User ESP phase. The configuration sets SkipUserStatusPage to True:\n./Device/Vendor/MSFT/DMClient/Provider/MS DM Server/FirstSyncStatus/SkipUserStatusPage\nWith this setting applied Autopilot completes immediately after the device ESP phase finishes and does not block completion while waiting for user targeted policies during ESP. User scoped apps and policies are not skipped, they continue processing after the user signs in.\nThis approach works well in environments where device scoped configuration and required applications are already enforced during device ESP. By removing the User ESP blocking behavior, the setup time is reduced while management, compliance and post enrollment processing remain intact.\nIn my environment the policy is assigned to the same GRP-Devices-Autopilot dynamic group used by the Autopilot profile and ESP configuration. This keeps the enrollment flow consistent and ensures that every device following this Autopilot path benefits from the same optimization, with user-targeted workloads shifting to post-login processing.\nWindows Hello for Business Configuration The GBL-WIN11-WindowsHello-(ALL) policy configures Windows Hello for Business using the Settings Catalog. This reflects the current Microsoft recommended approach and makes the policy easier to maintain and extend over time.\nOnly 10 (out of 36) available settings are configured which keeps the policy focused instead of overly restrictive. Biometrics are enabled and security key sign-in is allowed providing flexibility beyond PIN-only authentication.\nThe PIN configuration is intentionally strict but reasonable, PINs are numeric-only with uppercase letters, lowercase letters and special characters explicitly blocked. The minimum PIN length is 6 digits with a maximum of 127 and the system remembers the last 24 PINs to prevent reuse.\nA security device is required which in this lab translates to the virtual TPM (vTPM) provided by VMware rather than a physical TPM. This still enables Windows Hello for Business to use hardware-backed protection from the guest OS perspective with no external security keys (for example YubiKeys) are used at this stage.\nPIN expiration is set to 365 days which is reasonable for a controlled lab environment and helps avoid unnecessary user friction while still exercising lifecycle behavior.\nOverall this configuration enforces strong, hardware-backed authentication while remaining practical for day-to-day use in a lab and development environment.\nNon-Compliance Actions and Notification Non-compliance handling is intentionally simple and visible as soon as a device falls out of compliance, it is marked non-compliant immediately. End user notification is delayed by one day, avoiding spamming users for short-lived conditions such as a pending reboot, a Defender definition update or Windows Updates still finishing in the background. If the device remains non-compliant after 24 hours the user receives a clear and actionable email.\nThe notification template is explicit about what typically causes non-compliance in my environment: BitLocker not enabled, Defender or Firewall not running or missing security updates. It also gives concrete steps the user can take on their own before escalating to IT, such as restarting the device and completing Windows Update.\nThe message sets expectations clearly, users are informed that they have seven days to remediate the issue before access to company resources may be restricted. This ties compliance enforcement to a real timeline rather than a silent policy that only administrators see.\nThese settings control how long Intune trusts a device’s last known compliance state. The compliance status validity period is set to seven days, meaning devices that stop reporting to Intune remain compliant for up to a week before being marked non-compliant due to stale status. This is independent of the non-compliance actions above which apply immediately once a device actively fails a compliance check.\nCompliance Policy Configuration The GBL-WIN11-Compliance-Production policy defines the baseline compliance requirements for Windows 11 devices. It is created as a Windows 10/11 compliance policy and targets Windows devices consistently across the environment.\nAt a high level the policy focuses on device health, platform security and credential management ensuring that only devices meeting a minimum security standard are considered compliant. Overall this compliance policy is intentionally strict enough to exercise real world security controls, while remaining practical for a small VM based lab environment where the goal is to validate Intune behavior, reporting and enforcement rather than to simulate physical endpoint security in full.\nFrom a device health perspective, BitLocker, Secure Boot and Code Integrity are all required. In my environment these controls rely on VMware’s virtual TPM and virtual Secure Boot which are sufficient for testing compliance behavior, reporting, even though they do not provide the same assurance as physical hardware.\nThe minimum OS version is set to Windows 11 24H2 (10.0.26100) preventing older builds from being marked compliant and keeping the test environment aligned with current Windows 11 baselines.\nUnder System Security the policy enforces full disk encryption, firewall availability, TPM presence and active antimalware protection. Microsoft Defender Antivirus, antispyware, real-time protection and up-to-date security intelligence are all required. This ensures the device is actively protected rather than simply having security components installed.\nThe Device Security section defines local credential requirements, a password is required to unlock the device, with a numeric-only minimum length of 6, a 365-day expiration and 24 previous passwords blocked from reuse. The device must prompt for credentials after 15 minutes of inactivity and immediately when returning from idle state. These settings align with the Windows Hello for Business PIN configuration used elsewhere in the environment, keeping authentication behavior consistent.\nFinally the policy integrates with Microsoft Defender for Endpoint, requiring the device to be at or below a Low machine risk score to remain compliant.\nDevices are marked noncompliant immediately when any of the required conditions are no longer met. This ensures that compliance status reflects the current security posture without delay and can be acted on by Conditional Access policies in near real time.\nAn email notification is sent to the end user after one day of continued noncompliance. This short delay avoids false positives caused by transient conditions, such as pending restarts or security updates still in progress, while still prompting timely remediation.\nWhat\u0026rsquo;s next With tenant readiness confirmed, enrollment controls in place, ESP behavior tuned and a compliance baseline that covers BitLocker, Defender, Secure Boot and credential management, the foundation is set.\nThe next article moves from configuration to execution, walking through an actual Intune Autopilot deployment and showing how these settings behave during real device provisioning.\n","date":"2026-02-01","permalink":"https://halfoncloud.com/posts/m365-business-premium-part-6-intune-best-practices-device-management-foundations/","tags":["MSIntune","EntraID","DeviceManagement","CompliancePolicies","ConfigurationProfiles"],"title":"M365 Business Premium Part 6: Building the Intune Foundation for Autopilot"},{"categories":["#MSIntune ","#PowerShell","#Win32 ","#M365Apps","#DeliveryOptimization"],"contents":"Building on the Foundation In my previous article, PowerShell script installer for Win32 apps Guide I\u0026rsquo;ve demonstrated Microsoft’s new native PowerShell installer type for Win32 apps using a simple 7-Zip MSI deployment. That approach removed the need to repackage applications just to adjust install logic, a meaningful improvement to the Win32 app workflow in Intune.\nHowever, 7-Zip is a small self-contained installer, the real test comes when applying this same approach to a much more complex scenario: an application that downloads several gigabytes of content from a CDN during installation.\nThis article takes the PowerShell installer model to the next level with Microsoft 365 Apps, an evergreen deployment that pulls the latest Monthly Enterprise Channel build directly from Microsoft’s CDN. Along the way I\u0026rsquo;ve discovered that my existing Delivery Optimization (DO) policy was also actively interfering with the install, silently throttling download speed and turning what should have been a ~15–20 minute deployment into a multi-hour experience.\nWhat This Article Covers This deployment combines several moving parts: the Office Deployment Tool with a CDN-based configuration, a couple PowerShell scripts for install \u0026amp; uninstall as well as a separate custom detection logic with detailed logging and critically the Delivery Optimization settings that can make or break large app deployments during either regular installations (or Autopilot deployments).\nI’ll walk through the complete package structure, Intune configuration and real-world troubleshooting using IME logs and PowerShell transcripts. The before/after comparison clearly shows how much bandwidth my original DO policy was leaving unused and why this matters for both regular deployments and Autopilot scenarios.\nM365 Apps Package Root Folder Structure The root folder of the new M365 Apps Win32 package contains five items:\nTwo folders: Source (original installation files) Output (for the generated .intunewin file) Three PowerShell scripts: Install-M365Apps.ps1 Uninstall-M365Apps.ps1 M365AppsWin32DetectionScript.ps1 M365 Apps Source Folder Contents The Source folder contains only three files totaling approximately ~7 MB:\nM365Apps.xml - Office Deployment Tool configuration remove.xml - uninstallation configuration setup.exe - Office Deployment Tool executable Office Deployment Tool Version: 16.0.19628.20046\nDate published: 2026-01-15\nSource: https://www.microsoft.com/en-us/download/details.aspx?id=49117\nWhat each files contains: M365Apps.xml\n\u0026lt;Configuration\u0026gt; \u0026lt;Add OfficeClientEdition=\u0026#34;64\u0026#34; Channel=\u0026#34;Current\u0026#34;\u0026gt; \u0026lt;Product ID=\u0026#34;O365BusinessRetail\u0026#34;\u0026gt; \u0026lt;Language ID=\u0026#34;en-us\u0026#34; /\u0026gt; \u0026lt;ExcludeApp ID=\u0026#34;Groove\u0026#34; /\u0026gt; \u0026lt;ExcludeApp ID=\u0026#34;Lync\u0026#34; /\u0026gt; \u0026lt;ExcludeApp ID=\u0026#34;Bing\u0026#34; /\u0026gt; \u0026lt;/Product\u0026gt; \u0026lt;/Add\u0026gt; \u0026lt;Property Name=\u0026#34;SharedComputerLicensing\u0026#34; Value=\u0026#34;0\u0026#34; /\u0026gt; \u0026lt;Property Name=\u0026#34;FORCEAPPSHUTDOWN\u0026#34; Value=\u0026#34;TRUE\u0026#34; /\u0026gt; \u0026lt;Property Name=\u0026#34;DeviceBasedLicensing\u0026#34; Value=\u0026#34;0\u0026#34; /\u0026gt; \u0026lt;Property Name=\u0026#34;SCLCacheOverride\u0026#34; Value=\u0026#34;0\u0026#34; /\u0026gt; \u0026lt;Updates Enabled=\u0026#34;TRUE\u0026#34; /\u0026gt; \u0026lt;AppSettings\u0026gt; \u0026lt;User Key=\u0026#34;software\\microsoft\\office\\16.0\\excel\\options\u0026#34; Name=\u0026#34;defaultformat\u0026#34; Value=\u0026#34;51\u0026#34; Type=\u0026#34;REG_DWORD\u0026#34; App=\u0026#34;excel16\u0026#34; Id=\u0026#34;L_SaveExcelfilesas\u0026#34; /\u0026gt; \u0026lt;User Key=\u0026#34;software\\microsoft\\office\\16.0\\powerpoint\\options\u0026#34; Name=\u0026#34;defaultformat\u0026#34; Value=\u0026#34;27\u0026#34; Type=\u0026#34;REG_DWORD\u0026#34; App=\u0026#34;ppt16\u0026#34; Id=\u0026#34;L_SavePowerPointfilesas\u0026#34; /\u0026gt; \u0026lt;User Key=\u0026#34;software\\microsoft\\office\\16.0\\word\\options\u0026#34; Name=\u0026#34;defaultformat\u0026#34; Value=\u0026#34;\u0026#34; Type=\u0026#34;REG_SZ\u0026#34; App=\u0026#34;word16\u0026#34; Id=\u0026#34;L_SaveWordfilesas\u0026#34; /\u0026gt; \u0026lt;Setup Name=\u0026#34;Company\u0026#34; Value=\u0026#34;HalfOnCloud\u0026#34; /\u0026gt; \u0026lt;/AppSettings\u0026gt; \u0026lt;Display Level=\u0026#34;None\u0026#34; AcceptEULA=\u0026#34;TRUE\u0026#34; /\u0026gt; \u0026lt;Logging Level=\u0026#34;Standard\u0026#34; Path=\u0026#34;%WinDir%\\Logs\\Software\\M365AppsProPlus\\\u0026#34; /\u0026gt; \u0026lt;/Configuration\u0026gt; remove.xml\n\u0026lt;Configuration\u0026gt; \u0026lt;Display Level=\u0026#34;None\u0026#34; AcceptEULA=\u0026#34;True\u0026#34;/\u0026gt; \u0026lt;Property Name=\u0026#34;FORCEAPPSHUTDOWN\u0026#34; Value=\u0026#34;True\u0026#34;/\u0026gt; \u0026lt;Remove\u0026gt; \u0026lt;Product ID=\u0026#34;O365BusinessRetail\u0026#34;\u0026gt; \u0026lt;Language ID=\u0026#34;en-us\u0026#34;/\u0026gt; \u0026lt;/Product\u0026gt; \u0026lt;/Remove\u0026gt; \u0026lt;/Configuration\u0026gt; Install-M365Apps.ps1\n# Variables $PackageName = \u0026#34;M365Apps-Current\u0026#34; $LogPath = \u0026#34;$env:ProgramData\\Microsoft\\IntuneManagementExtension\\Logs\u0026#34; $SetupFile = \u0026#34;$PSScriptRoot\\setup.exe\u0026#34; $ConfigFile = \u0026#34;$PSScriptRoot\\M365Apps.xml\u0026#34; # Start logging Start-Transcript -Path \u0026#34;$LogPath\\$PackageName-install.log\u0026#34; -Force -Append try { Write-Host \u0026#34;Starting installation of $PackageName\u0026#34; Write-Host \u0026#34;Setup Path: $SetupFile\u0026#34; Write-Host \u0026#34;Config Path: $ConfigFile\u0026#34; Write-Host \u0026#34;Timestamp: $(Get-Date -Format \u0026#39;yyyy-MM-dd HH:mm:ss\u0026#39;)\u0026#34; # Verify files exist if (!(Test-Path $SetupFile)) { Write-Host \u0026#34;ERROR: setup.exe not found!\u0026#34; Stop-Transcript exit 1 } if (!(Test-Path $ConfigFile)) { Write-Host \u0026#34;ERROR: M365Apps.xml not found!\u0026#34; Stop-Transcript exit 1 } # Install $arguments = \u0026#34;/configure `\u0026#34;$ConfigFile`\u0026#34;\u0026#34; Write-Host \u0026#34;Running: $SetupFile $arguments\u0026#34; $process = Start-Process -FilePath $SetupFile -ArgumentList $arguments -Wait -PassThru Write-Host \u0026#34;Exit code: $($process.ExitCode)\u0026#34; Stop-Transcript exit $process.ExitCode } catch { Write-Host \u0026#34;ERROR: $($_.Exception.Message)\u0026#34; Stop-Transcript exit 1 } Uninstall-M365Apps.ps1\n# Variables $PackageName = \u0026#34;M365Apps-Current\u0026#34; $LogPath = \u0026#34;$env:ProgramData\\Microsoft\\IntuneManagementExtension\\Logs\u0026#34; $SetupFile = \u0026#34;$PSScriptRoot\\setup.exe\u0026#34; $RemoveFile = \u0026#34;$PSScriptRoot\\remove.xml\u0026#34; # Start logging Start-Transcript -Path \u0026#34;$LogPath\\$PackageName-uninstall.log\u0026#34; -Force -Append try { Write-Host \u0026#34;Starting uninstallation of $PackageName\u0026#34; Write-Host \u0026#34;Setup Path: $SetupFile\u0026#34; Write-Host \u0026#34;Remove Config Path: $RemoveFile\u0026#34; Write-Host \u0026#34;Timestamp: $(Get-Date -Format \u0026#39;yyyy-MM-dd HH:mm:ss\u0026#39;)\u0026#34; # Verify files exist if (!(Test-Path $SetupFile)) { Write-Host \u0026#34;ERROR: setup.exe not found!\u0026#34; Stop-Transcript exit 1 } if (!(Test-Path $RemoveFile)) { Write-Host \u0026#34;ERROR: remove.xml not found!\u0026#34; Stop-Transcript exit 1 } # Uninstall $arguments = \u0026#34;/configure `\u0026#34;$RemoveFile`\u0026#34;\u0026#34; Write-Host \u0026#34;Running: $SetupFile $arguments\u0026#34; $process = Start-Process -FilePath $SetupFile -ArgumentList $arguments -Wait -PassThru Write-Host \u0026#34;Exit code: $($process.ExitCode)\u0026#34; Stop-Transcript exit $process.ExitCode } catch { Write-Host \u0026#34;ERROR: $($_.Exception.Message)\u0026#34; Stop-Transcript exit 1 } M365AppsWin32DetectionScript.ps1\n# Detection Script for M365 Apps $LogPath = \u0026#34;$env:ProgramData\\Microsoft\\IntuneManagementExtension\\Logs\u0026#34; $LogFile = \u0026#34;$LogPath\\M365Apps-Detection.log\u0026#34; # Start logging \u0026#34;$(Get-Date -Format \u0026#39;yyyy-MM-dd HH:mm:ss\u0026#39;) - Starting M365 Apps detection\u0026#34; | Out-File -FilePath $LogFile -Force # Check for Microsoft 365 Apps in uninstall registry $M365Apps = Get-ChildItem -Path \u0026#34;HKLM:\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Uninstall\u0026#34; | Get-ItemProperty | Where-Object { $_.DisplayName -match \u0026#34;Microsoft 365\u0026#34; } if ($M365Apps) { \u0026#34;$(Get-Date -Format \u0026#39;yyyy-MM-dd HH:mm:ss\u0026#39;) - Detected: $($M365Apps.DisplayName)\u0026#34; | Out-File -FilePath $LogFile -Append Write-Output \u0026#34;Microsoft 365 Apps Detected\u0026#34; exit 0 } else { \u0026#34;$(Get-Date -Format \u0026#39;yyyy-MM-dd HH:mm:ss\u0026#39;) - Microsoft 365 Apps not detected\u0026#34; | Out-File -FilePath $LogFile -Append exit 1 } M365 Apps Win32 Application Program Settings The new Intune Win32 application called \u0026ldquo;GBL-WIN11-M365Apps-v2\u0026rdquo; is using an install command which calls the PS script: Install-M365Apps.ps1 and the uninstall command calls the other PS script: Uninstall-M365Apps.ps1. Installation time is set to 60 minutes to accommodate the CDN download and the app runs in System context:\nM365 Apps Custom Detection Script Configuration For the Detection rules I\u0026rsquo;m using my custom PowerShell script that logs directly to: \u0026ldquo;C:\\ProgramData\\Microsoft\\IntuneManagementExtension\\Logs\\M365Apps-Detection.log\u0026rdquo;.\nUsing a custom detection script instead of a basic file or registry check provides clear detection logic, troubleshooting visibility and confirmation that Office is fully installed and usable:\nCompany Portal Downloading M365 Apps The Company Portal displays the deployment progress of GBL-WIN11-M365Apps-v2:\nIntuneManagementExtension AppWorkload Log Analysis The log \u0026ldquo;AppWorkload.log\u0026rdquo; shows the detection script returning applicationDetected: False, followed by the execution handler launching the install. The highlighted line confirms the PowerShell installer is executed from the IMECache folder, which is expected behavior for Win32 apps:\nIMECache Folder with Extracted Win32 App Contents The \u0026ldquo;C:\\Windows\\IMECache\u0026rdquo; folder shows the extracted contents of the M365 Apps Win32 package with the unique app GUID folder name. The contents include the install script (renamed with a GUID prefix) along with the other three files addressed above: M365Apps.xml, remove.xml and setup.exe.\nNote: This is where Intune temporarily extracts Win32 app packages before execution and examining this location is valuable for troubleshooting deployment issues.\nM365 Apps Installation Transcript Log The output for the custom log \u0026ldquo;M365Apps-Current-install.log\u0026ldquo;is capturing the installation process, the highlighted line showing the setup.exe command being executed: setup.exe /configure \u0026ldquo;M365Apps.xml\u0026rdquo;.\nNote: This transcript logging provides valuable troubleshooting information for deployment issues.\nTask Manager Showing Throttled Network Speed At this point, Task Manager revealed the real issue. Despite a Gigabit network adapter, network throughput was capped at approximately 1.1 Mbps showing constant throttling spikes. At this speed downloading ~4 GB of Office content would take 25–38 hours which is obviously unacceptable for production or Autopilot deployments.\n(Optional) Monitoring Office Installation Progress After adjusting the Delivery Optimization settings, I\u0026rsquo;ve used the following monitoring PS script which showed Office folder growth from 2.05 GB to 4.18 GB in under 2 minutes, followed by confirmation that WINWORD.EXE was installed.\nThis clearly demonstrated that the bottleneck was not the installer or CDN but the local DO configuration:\nEstimated download impact M365 Office folders size ~4,200 MB (4.2 GB)\nBefore DO optimization:\n~1.1 Mbps (≈ 8 MB/min) → ~8.5 hours (theoretical minimum)\nAfter DO optimization:\n~27 Mbps (≈ 200 MB/min) → ~21 minutes\nwhile (!(Test-Path \u0026#34;C:\\Program Files\\Microsoft Office\\root\\Office16\\WINWORD.EXE\u0026#34;)) { $size = [math]::Round((Get-ChildItem \u0026#34;C:\\Program Files\\Microsoft Office\u0026#34; -Recurse -ErrorAction SilentlyContinue | Measure-Object -Property Length -Sum).Sum / 1GB, 2) Write-Host \u0026#34;$(Get-Date -Format \u0026#39;HH:mm:ss\u0026#39;) - Office folder: $size GB - Waiting for WINWORD.EXE...\u0026#34; Start-Sleep -Seconds 15 } Write-Host \u0026#34;WINWORD.EXE INSTALLED!\u0026#34; -ForegroundColor Green # Final verification $office = Get-ItemProperty -Path \u0026#34;HKLM:\\SOFTWARE\\Microsoft\\Office\\ClickToRun\\Configuration\u0026#34; Write-Host \u0026#34;Version: $($office.VersionToReport)\u0026#34; This dramatic improvement from the previous 1.1 Mbps throttled speed demonstrates the impact of proper DO configuration.\nOriginal Delivery Optimization Policy Settings The original policy GBL-WIN11-Delivery-Optimization-(ALL) revealed the issues:\nMax Background Bandwidth: 25% Max Foreground Bandwidth: 50% Combined with HTTP delay settings In a single-device environment with no peers these limits only reduced performance and provided no P2P benefit. More importantly these settings also apply during Autopilot and ESP, meaning they directly affect foreground installs like Microsoft 365 Apps.\nWhile reviewing different perspectives on Delivery Optimization behavior, two voices stood out as particularly aligned and practical: Johan Arwidmark (2Pint Software), approaching the topic from bandwidth optimization and peer-to-peer efficiency and Rudy Ooms (Patch My PC), drawing conclusions from real-world Autopilot failure analysis, each arriving at similar recommendations from very different angles.\nDespite different perspectives I\u0026rsquo;ve noticed that both converge on the same practical values:\nForeground delay: 60 seconds Background delay: 600 seconds The difference isn’t the numbers but how they were validated, Johan optimizes for scale while Rudy identified these values by troubleshooting what breaks Autopilot and ESP when foreground apps wait too long for peers that don’t exist.\nMicrosoft official documentation remains the baseline but it does not always surface the full behavioral impact of these settings especially during Autopilot, Community testing and failure analysis often fill that gap.\nThe key lesson is to avoid copying settings blindly, Delivery Optimization must be addressed on a per-tenant basis, aligned with network design, operational constraints and agreed with the relevant networking and endpoint stakeholders.\nHere are the adjusted settings that resolved the issue in my environment:\nThe contrast with the previous throttled state is dramatic, Task Manager now shows an improved speed of 27.1 Mbps with peaks reaching 54 Mbps, roughly 25 times faster than the original restrictive configuration. With Delivery Optimization no longer artificially constraining bandwidth, an installation that previously risked turning into a 25+ hour now completes in minutes:\nM365 Apps Installation Transcript Completed Successfully Finally the installation log confirms Exit code: 0 and Company Portal confirming the app has been deployment successfully, the entire Win32 app deployment workflow functioned correctly from CDN download through installation to detection:\nRegistry Verification of M365 Apps Installation Configuration In the following registry key you can find information about the Microsoft 365 Apps installation including the Click-to-Run configuration:\nHKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Office\\ClickToRun\\Configuration\nThis registry location is authoritative for validating how M365 Apps were installed and whether the deployment matches the Office Deployment Tool (ODT) XML configuration used during installation.\nThe ProductReleaseIds value shows O365BusinessRetail, confirming the expected product SKU.\nThe O365BusinessRetail.ExcludedApps value lists groove, lync and bing, validating that the XML exclusions for OneDrive for Business, Skype for Business, and Bing were correctly applied during installation.\nThe O365BusinessRetail.MediaType value is set to CDN, confirming this was an evergreen deployment sourcing content directly from Microsoft’s CDN rather than from local or offline media. The VersionToReport value (16.0.19530.20184) confirms the specific Monthly Enterprise Channel build that was installed at the time.\nIt’s worth noting that while the registry shows UpdatesEnabled set to True, the update behavior is not controlled here alone. In my environment update configuration is enforced by a separate Intune policy (GBL-WIN11-M365AppsUpdates-Current-(DEV)) which sets the update channel, enables automatic updates with zero deferral and prevents users from disabling updates:\nWindows Settings Delivery Optimization The Windows Settings page under Windows Update \u0026gt; Advanced options \u0026gt; Delivery Optimization confirms that the Delivery Optimization policy is applied at the OS level.\nThe Activity Monitor shows:\nFrom Microsoft: 100% (1.3 GB) From PCs on your local network: 0% This behavior is expected and correct in a single-device lab environment with no eligible peers available, Delivery Optimization falls back entirely to CDN downloads even though peer-to-peer is enabled and ready to be used when peers exist.\nNote: This screen validates source selection behavior not the bandwidth efficiency.\nPowerShell Delivery Optimization Status Verification The PowerShell command Get-DeliveryOptimizationPerfSnap provides a runtime snapshot of Delivery Optimization behavior and effective settings:\nKey values confirm correct operation:\nDownloadMode: Lan\nIndicates that peer-to-peer is enabled and scoped to the local network, even though peers are not currently available.\nNumberOfPeers: 0\nConfirms the expected single-device lab scenario.\nForegroundDownloadRatePct: 90\nBackgroundDownloadRatePct: 45\nThese values are particularly important since they demonstrate that Windows is dynamically calculating bandwidth usage rather than being constrained by static, policy-enforced percentage limits. This behavior only becomes possible after removing explicit foreground and background bandwidth caps from the Intune Delivery Optimization policy.\nFinal takeaway Delivery Optimization works best when it is allowed to adapt.\nHard limits should be the exception, not the default and settings must be evaluated per tenant, aligned with both official Microsoft guidance and real-world community experience.\n","date":"2026-01-23","permalink":"https://halfoncloud.com/posts/powershell-script-installer-for-win32-part2-m365-apps-and-delivery-optimization/","tags":["MSIntune","PowerShell","Win32"],"title":"M365 Apps Deployment with PowerShell Installer \u0026 Delivery Optimization Gotchas"},{"categories":["Cloud"],"contents":"The Policy Dashboard The Conditional Access policies described below represent a baseline starting point for any tenant security. They are not a definitive or complete security model, but a minimal foundation that every tenant should have in place in some form. Whether you adopt these policies directly, adjust their scope or implement a variation that fits your environment, the key point is to start somewhere rather than operate without core Conditional Access controls.\nIn my tenant, I currently have 8 Conditional Access policies in total:\n2 Microsoft-managed (default policies) 6 custom user-created policies The Microsoft-managed policies for blocking legacy authentication and requiring phishing-resistant MFA for administrators are currently set to Off. This is intentional, as I have implemented functionally equivalent policies with custom configurations tailored to my environment.\nMy custom policies follow a deliberate and explicit numbering convention (CA-001 through CA-006), making them easier to audit, discuss and troubleshoot, each policy targeting a specific security control:\nCA-001-Require-MFA-Admins CA-002-Block-Legacy-Auth CA-003-Require-MFA-All-Users CA-004-Block-Offline-Autopilot CA-005-Require-ToU-All-Users CA-006-Block-NonCompliant This structure helps keep Conditional Access readable, predictable and maintainable over time, especially as additional policies are introduced:\nNote: To keep things readable avoiding unnecessary repetition, I don’t re-show identical Conditional Access sections for every policy, common settings such as Users and groups and the usual Include / Exclude logic are explained in detail once and then reused across the other policies.\nFor each additional policy, I\u0026rsquo;ve focus only on what changes and why it matters. If a setting isn’t shown again, it follows the same pattern already introduced earlier unless I explicitly call out a difference.\nCA-001: Require MFA for Admins The first policy focuses on privileged identities, rather than targeting individual users, it is scoped to directory roles, with nine administrative roles selected. This ensures that Global Administrators, User Administrators, Exchange Administrators and other high-impact roles must complete MFA regardless of where the sign-in originates.\nThe critical configuration here is Select users and groups with Directory roles enabled. This approach is more resilient than assigning named accounts, as the policy automatically applies the moment a user is added to an administrative role and is removed just as cleanly when the role is revoked.\nThe Break-Glass Exclusion Every Conditional Access design needs an explicit emergency access path. I\u0026rsquo;ve exclude a dedicated \u0026ldquo;break-glass\u0026rdquo; account from all Conditional Access policies to guarantee tenant access in case of widespread authentication or policy misconfiguration.\nThis account uses a long, complex password stored offline and is never used for daily administration. The account name is intentionally blurred here, publishing break-glass account details publicly is a poor operational security practice.\nTarget Resources and the Lockout Warning CA-001 targets All resources (formerly “All cloud apps”), meaning every Microsoft 365 service requires MFA for administrative access. Because this is a broad and restrictive scope, Entra ID displays a yellow warning banner reminding you of the risk of self-lockout.\nThis warning is expected and appropriate. Any policy that applies to all resources should be deployed cautiously, ideally first in report-only mode or during a controlled change window.\nNote:: The informational banner referencing Global Secure Access can be ignored unless you are actively deploying Microsoft’s SASE capabilities.\nGrant Controls for Admin MFA In the Grant controls, Require multifactor authentication is selected. Entra ID also surfaces a recommendation for Authentication Strength, along with a reminder that MFA and Authentication Strength cannot be combined in the same policy.\nFor now, standard MFA meets the intended risk reduction. Phishing-resistant authentication strength is planned for a later iteration once the environment is ready to absorb the stricter controls.\nThe For multiple controls option becomes relevant when more than one requirement is selected. “Require one of the selected controls” applies OR logic, while “Require all” enforces AND logic:\nCA-002: Block Legacy Authentication This policy has a fundamentally different goal: deny access outright. Legacy authentication protocols such as IMAP, POP3 and older SMTP variants do not support MFA and remain a common attack surface.\nIn the Conditions panel, Client apps are configured with two inclusions and the Grant control is set to Block access. The selected client apps Exchange ActiveSync clients and Other clients cover legacy protocols while leaving modern authentication flows unaffected:\nBlock Access Grant Control Unlike CA-001, which grants access after conditions are met, CA-002 enforces a hard stop. Once Block access is selected, all other grant options are disabled. There is no MFA challenge and no fallback condition, authentication simply fails.\nThis is the intended behavior, Legacy authentication should not be constrained or partially allowed, it should be removed entirely:\nCA-003: Network-Aware MFA for All Users This policy extends MFA requirements to all users, not just administrators, while remaining aware of network context. The Network (formerly Locations) condition is configured as Any network or location, with one exclusion.\nIn practice MFA is required everywhere except a trusted home network. This balances usability with security by reducing friction in a controlled environment while maintaining strong authentication everywhere else.\nNote: Microsoft is gradually transitioning location-based conditions into the broader Network model as part of its Global Secure Access strategy.\nCreating Named Locations Named Locations define trusted networks for CA policies. The \u0026ldquo;New location (IP ranges)\u0026rdquo; panel shows creating \u0026quot; \u0026quot; with \u0026ldquo;Mark as trusted location\u0026rdquo; checked. The IP range field shows my subnet representing a single public IP address.\nNote: I\u0026rsquo;ve blurred the actual IP in the published version. Never expose your home or office public IPs.\nAfter creation, the Named Locations list shows my custom Named Location with Trusted: Yes and a Creation date. The status shows \u0026ldquo;Not configured in any policy yet\u0026rdquo; which will change once I assign it to CA-003\u0026rsquo;s exclusion list next:\nNamed Location Exclusions The exclusion relies on Named Locations, my home IP range is explicitly marked as trusted.\nWhen a user signs in from this location the policy still evaluates, but the MFA requirement is bypassed due to the exclusion. From any other network, MFA is enforced:\nLocation Conditions Overview The Conditions summary reflects a deliberately narrow scope. Network conditions are configured with Any network or location and 1 excluded, while Device platforms, Client apps, Filter for devices and Authentication flows remain not configured.\nThis is intentional, each policy is designed to do one thing well, CA-003 handles user MFA with network awareness, while device compliance and other signals are enforced elsewhere.\nSelecting the Excluded Network In the Select networks panel, both named locations are visible, the home network is explicitly selected under the Exclude tab using Selected networks and locations.\nIP ranges are blurred here for obvious reasons, publishing home or corporate IP addresses is unnecessary and unsafe:\nCA-003 Grant Controls This policy requires either MFA or acceptance of the Intune Device Management Privacy Notice. By setting Require one of the selected controls, the policy applies OR logic between the two conditions.\nThis configuration aligns well with Intune enrollment and sign-in flows, where users may need to acknowledge device management terms. Combined with MFA, it enforces both identity assurance and user consent without creating unnecessary sign-in failures.\nCA-004: Block Offline Autopilot Devices This policy addresses a very specific scenario: devices provisioned using offline Autopilot profiles. Since Autopilot is a Windows-only capability, the Device platforms condition is scoped exclusively to Windows.\nTwo conditions are configured in this policy and the Grant control is set to Block access. Offline Autopilot enables device provisioning without internet connectivity but the trade-off is that those devices may not receive the latest security policies or configurations during enrollment.\nDevice Filter for Offline Autopilot The core logic of this policy lives in the Filter for devices condition. The filter uses the enrollmentProfileName attribute with the Starts with operator and the value offline.\nIn rule syntax, this appears as: device.enrollmentProfileName -startsWith \u0026ldquo;offline\u0026rdquo;\nThis design relies on a simple naming convention. Any Autopilot deployment profile intended for offline use starts with the prefix offline. As a result, only devices enrolled through those profiles are targeted, standard online Autopilot devices are unaffected.\nCA-004 Grant Control Like CA-002, this policy uses Block access rather than a conditional grant. When a Windows device matches the offline Autopilot filter, access is denied outright, there is no MFA prompt and no compliance evaluation.\nThe intent is not to punish the device, but to force it back through a proper online Autopilot enrollment, where it can receive current policies, applications and security baselines.\nCreating Terms of Use Before CA-005 can enforce Terms of Use, the document itself must exist. In the New terms of use workflow, I\u0026rsquo;ve created and uploaded a PDF privacy notice titled Privacy_Notice_Intune_HalfOnCloud.pdf.\nTo keep the user experience simple in this lab tenant, I\u0026rsquo;ve disabled:\nRequire users to expand the terms of use Require users to consent on every device Note: In a production environment these options are often enabled to meet stricter compliance or audit requirements.\nTerms of Use Management The Terms of use blade shows the document Privacy Notice – Intune Device Management. In the details panel, all behavioral options are turned off: users don’t need to expand the document, consent isn’t required per device and consents do not expire.\nAt this stage acceptance counters show zero activity. This is expected before the policy is enforced.\nNote: This is the document referenced later by CA-005.\nCA-005: Require Terms of Use This policy ensures users acknowledge the Privacy Notice before accessing company resources. In the Grant controls, only Privacy Notice – Intune Device Management is selected.\nThere are no MFA or device compliance requirements in this policy. Its sole purpose is legal and informational acknowledgement. Because only one control is selected, the Require one of the selected controls setting has no practical impact here.\nThe User Experience When the policy is enforced, users are presented with a Terms of Use prompt. In this case, the Company Portal displays a dialog showing the organization name HalfOnCloud and the user’s identity.\nThe message clearly states that access to company resources requires acceptance of the terms. Users must choose Accept or Decline. Declining immediately blocks access.\nViewing the Terms Document Expanding the Privacy Notice displays the PDF inline, the document outlines:\nAn introduction explaining Intune device management. The types of data collected, such as device model, serial number, OS version, installed applications, compliance state, and location. How that data is used. Note: This level of transparency is particularly important for EU tenants and supports GDPR notification requirements.\nTerms of Use Audit Logs All Terms of Use interactions are recorded in the Audit logs. This provides a verifiable record of when users accepted or declined the document, which is essential for compliance and audits:\nAcceptance Tracking After enforcement the Terms of Use overview reflects real activity. The counters show Current Accepted: 1 and Current Declined: 0. These values update after the next device Sync as users interact with the prompt.\nIn larger environments this view becomes a quick health indicator during rollout. If users begin declining the terms, it’s immediately visible and can be investigated.\nCA-006-Block-NonCompliant Important note: In this tenant I only have a single user. I’m on a monthly subscription with one license so I reuse my own account for testing. My account is also a Global Administrator, which means I have to be especially careful with Conditional Access changes. This setup isn’t ideal, but it’s a common reality for lab tenants and personal learning environments and it influenced how this policy was designed and tested.\nThis policy ended up being one of the most instructive ones for me, CA-006 uses a device filter with two combined conditions:\nisCompliant not equal to True trustType equal to Microsoft Entra joined In rule syntax this translates to:\ndevice.isCompliant -ne True -and device.trustType -eq \u0026ldquo;AzureAD\u0026rdquo;\nThe intent is very specific: target only devices that are Entra joined and explicitly non-compliant.\nWhy Block Access Instead of Require Compliance Note: The Grant control is configured as Block access not Require device to be marked as compliant\nInitially, I built this policy using Require compliant device as the Grant control, within minutes, I locked myself out of the tenant.\nAt first I\u0026rsquo;ve excluded my own user from the policy (together with the break-glass account), because this tenant only has one user and I didn’t want to lock myself out. Later I\u0026rsquo;ve temporarily removed my own exclusion just to test the behavior. The policy is intentionally left in Report-only mode, in a single-user tenant where the administrator and user are the same person enforcing device compliance offers little practical benefit\nThe confusing part is how Require compliant device really works.\nWhen you use Require compliant device, Conditional Access doesn’t just look at the user, it also looks at the device trying to sign in. If that device is not enrolled or registered, it has no compliance status, Conditional Access treats “no status” the same as not compliant.\nThat means:\nAn unmanaged or unknown device is automatically considered non-compliant. Excluding the user does not help because the device check still happens. The result is very easy self-lockout especially in lab or single-user tenants. Using Block access together with a device filter works differently.\nThe device filter acts like a very strict gate, it only matches devices that are:\nEntra joined. And explicitly marked as non-compliant. If a device doesn’t meet those exact conditions (for example a home PC that isn’t Entra joined), it doesn’t match the filter at all. When a device doesn’t match the filter, the policy is simply ignored.\nThis approach lets me:\nBlock access only from known corporate devices that are non-compliant. Still manage the tenant from an unmanaged home PC. Avoid accidental lockouts while learning and testing. I confirmed this using the What If tool.\nWith my user excluded, CA-006 appeared under Policies that will not apply with the reason Users and groups. After temporarily removing my exclusion the same policy moved to Policies that will apply showing Block access as the result.\nThat told me exactly what would have happened if this policy had been enabled without careful exclusions: immediate lockout !\nAuthentication Strengths Custom Authentication Strength Configuration Authentication Strengths allow you to define exactly which authentication methods are acceptable for a Conditional Access policy. Instead of allowing any MFA method including easily phishable options such as SMS, you can restrict access to phishing-resistant methods only.\nTo explore this capability, I\u0026rsquo;ve created a custom authentication strength named SecInfo-Registration-Secure. The goal is to address a common chicken-and-egg problem: users need MFA to register MFA.\nThis custom strength includes:\nAll phishing-resistant methods (Windows Hello for Business, Passkeys, certificate-based authentication) Both Temporary Access Pass (TAP) variants TAP is the critical piece here, it allows users to authenticate securely during initial registration, before any permanent MFA method exists. Without TAP first-time enrollment flows can easily dead-end.\nAuthentication Strength Review Warnings The Review tab shows which authentication methods are currently registered for my account. The warnings indicate that I’m not yet registered for Passkeys (FIDO2) or certificate-based authentication. These warnings are informational only, they don’t prevent the authentication strength from being created.\nA reminder at the bottom reinforces an important rule: always verify that enforcing an authentication strength won’t lock you out. Since this strength is not applied to any Conditional Access policy yet, its safe to be created:\nAuthentication Strengths Overview After creation the Authentication strengths blade lists my custom SecInfo-Registration-Secure alongside the three built-in strengths. The details panel confirms that five authentication methods are allowed.\nAt this stage, the strength is defined but unused. The intended future use is a policy such as Require secure authentication for security info registration, ensuring that users can only register or modify MFA methods after authenticating with a strong, phishing-resistant method. This helps prevent attackers from adding their own MFA to a compromised account.\nWhy I Haven\u0026rsquo;t Enforced Authentication Strengths Yet In a single-user tenant where I am both the administrator and the only user, enforcing phishing-resistant authentication introduces a real lockout risk. My current CA-001 policy uses the generic Require MFA control, which allows Microsoft Authenticator push notifications, a method I have tested and rely on daily.\nEnforcing Phishing-resistant MFA would restrict authentication to:\nWindows Hello for Business FIDO2 security keys Certificate-based authentication While Windows Hello works on my virtual machines, I don’t (yet) have a FIDO2 hardware key, and certificate-based authentication would require PKI infrastructure that I haven’t deployed in this tenant.\nFor now the authentication strength exists as a prepared control. When the environment expands to multiple users, or once I introduce FIDO2 hardware, enforcement can be enabled with confidence knowing the configuration has already been designed and reviewed.\nWhat’s Coming Next This concludes the Conditional Access portion of the series. Up to this point the focus has been on establishing a minimal but coherent identity security baseline using Conditional Access designed to be understandable, auditable and safe to evolve.\nIn Part 6 I’ll shift the focus to Intune best practices. That section will cover how device management, compliance and configuration policies complement Conditional Access and where responsibilities should be deliberately separated between identity and device controls.\n","date":"2026-01-19","permalink":"https://halfoncloud.com/posts/m365-business-premium-part-5-intune-conditional-access-policies/","tags":["MSIntune","EntraID"],"title":"M365 Business Premium Part 5: Conditional Access Policies"},{"categories":["Cloud"],"contents":"The New Way I’ve been packaging Win32 apps for Intune for years using the classic approach: wrap everything into an .intunewin file, include the PowerShell install script and call it from the command line. It works but it has a cost, any small change in the script means a full repackage, re-upload and another round of content processing.\nRecently Microsoft recently introduced a quiet but significant change: PowerShell Script as a native installer type for Win32 apps.\nWith this model, the script is no longer embedded inside the encrypted payload, it lives as editable metadata in Intune similar to detection rules. That means no more rebuilding packages just to fix a typo or add a switch like /norestart.\nThis article walks through a real deployment of 7-Zip 25.01.msi using this new approach. It covers the working folder structure, the packaging process, the Intune configuration and the logs that confirm correct execution.\nSource Folder Structure Before packaging, the MSI installer lives in a dedicated Source folder, each application gets its own directory under my project, with separate Source and Output subfolders:\nSource:\nOutput:\nIntuneWinAppUtil Execution The Microsoft Win32 Content Prep Tool (IntuneWinAppUtil.exe) handles the packaging process, running it from command line shows the complete workflow: source folder validation, file type detection, encryption, SHA256 hash computation and final package generation:\nHere is the PS script \u0026ldquo;Install_7Zip_2501.ps1\u0026rdquo; that I\u0026rsquo;m using for this example:\n# Variables: $PackageName = \u0026#34;7-Zip-25.01-x64\u0026#34; $LogPath = \u0026#34;$env:ProgramData\\Microsoft\\IntuneManagementExtension\\Logs\u0026#34; $MsiFile = \u0026#34;$PSScriptRoot\\7z2501-x64.msi\u0026#34; # Create a custom log for troubleshooting: Start-Transcript -Path \u0026#34;$LogPath\\$PackageName-install.log\u0026#34; -Force -Append try { Write-Host \u0026#34;Starting installation of $PackageName\u0026#34; Write-Host \u0026#34;MSI Path: $MsiFile\u0026#34; Write-Host \u0026#34;Timestamp: $(Get-Date -Format \u0026#39;yyyy-MM-dd HH:mm:ss\u0026#39;)\u0026#34; # Verify if the MSI file exists: if (!(Test-Path $MsiFile)) { Write-Host \u0026#34;ERROR: MSI file not found!\u0026#34; Stop-Transcript exit 1 } # App installation: $arguments = \u0026#34;/i `\u0026#34;$MsiFile`\u0026#34; /qn /norestart\u0026#34; Write-Host \u0026#34;Running: msiexec.exe $arguments\u0026#34; $process = Start-Process -FilePath \u0026#34;msiexec.exe\u0026#34; -ArgumentList $arguments -Wait -PassThru Write-Host \u0026#34;Exit code: $($process.ExitCode)\u0026#34; Stop-Transcript exit $process.ExitCode } catch { Write-Host \u0026#34;ERROR: $($_.Exception.Message)\u0026#34; Stop-Transcript exit 1 } App Information Overview When creating a new app, selecting Windows app (Win32) from the dropdown enables the full Win32 app deployment workflow. From the Intune portal, select \u0026ldquo;Create\u0026rdquo; and from the App type choose \u0026ldquo;Windows app (Win32)\u0026rdquo;.\nAdd the newly created \u0026ldquo;7z2501-x64.intunewin\u0026rdquo; into the \u0026ldquo;Select app package file\u0026rdquo;:\nOnce the intunewim is added continue with the new application customizations.\nThe app name GBL-WIN11-7z2501-x64 follows my own standard pattern, specifying the App name, Description, Publisher, App version and of course the app logo:\nProgram Tab Configuration The Program tab is where the new PowerShell installation approach shines! Setting Installer type to PowerShell script and selecting the Install_7Zip_2501.ps1 script enables full control over the installation process.\nNote: As can be seen I\u0026rsquo;m not using the Install command type anymore with the classic \u0026quot;\n%SystemRoot%\\sysnative\\WindowsPowerShell\\v1.0\\powershell.exe -executionpolicy bypass -command .\\Install_7Zip_2501.ps1\u0026quot; instead I\u0026rsquo;m taking advantage of the new PowerShell script install type, by directly using my separate stand alone PS script:\nImportant settings: Enforce script signature check: No allows unsigned scripts (acceptable for internal/testing environments) and Run script as 32-bit process: No ensures 64-bit PowerShell execution.\nThe uninstall command uses the MSI product GUID with /x switch for clean removal. Notice the return codes section - 0 and 1707 indicate success, while 3010 and 1641 handle reboot scenarios.\nRequirements Configuration The Requirements tab defines where the app can install, I\u0026rsquo;m specifically choosing only \u0026ldquo;Install on x64 system\u0026rdquo; with a Minimum operating system of \u0026ldquo;Windows 11 v24H2\u0026rdquo;.\nFor a lightweight utility like 7-Zip, leaving disk space and memory requirements blank is fine, the MSI installer handles prerequisite checks internally but more complex applications may require custom requirement scripts:\nDetection Rules Detection rules tell Intune how to verify successful installation. Using File detection with path C:\\Program Files\\7-zip and file 7z.exe is reliable for 7-Zip. The String (version) method with operator Greater than or equal to and value 25.01.00.0 ensures the detection passes only when the correct version is installed.\nThis version-based detection is superior to simple file existence checks, it prevents false positives from older installations and enables proper upgrade detection for future versions.\nFinal step is to assign the application to a group, in this case I specifically add it as an \u0026ldquo;Available\u0026rdquo; type, since I want to manually install it from the \u0026ldquo;Company Portal\u0026rdquo;:\nAfter finishing creating the application and reviewing it once again, you\u0026rsquo;ll notice something interesting, the Install command shows a - (dash) and the Install script shows: Install_7Zip_2501.ps1 but if you edit the app again it will show the correct Installer type: PowerShell script .\nI believe this behavior confirms the script is metadata not being part of the command line.\nCompany Portal Verification Open the Company Portal select the app from the list and Install it.\nThe end-user view in Company Portal confirms successful deployment. As expected the app appears with my custom logo, naming convention and all the other information. The blue checkmark with Installed status indicates the detection rule passed successfully.\nDevice Install Status The App Overview dashboard provides a consolidated view of deployment health, the donut charts show Device status and User status with 1 Installed perfect success rate for my initial deployment:\nThe Device install status view in Intune provides per-device deployment tracking, the status shows Installed for my test device, with the detected app version 25.01.00.0 matching the detection rule configuration:\nInstallation Troubleshooting The Intune Management Extension log folder at: C:\\ProgramData\\Microsoft\\IntuneManagementExtension\\Logs\nis the primary location for advanced Intune app troubleshooting.\nThis folder contains all IME-related logs, in my case the file 7-Zip-25.01-x64-install.log is a custom transcript created by the PowerShell script using Start-Transcript.\nFor advanced application troubleshooting, two logs are especially important:\nAppWorkload.log which shows how Intune processes the app deployment. The custom install log 7-Zip-25.01-x64-install.log which captures exactly what the installation script executed and returned. Understanding and correlating these logs is essential when diagnosing Win32 app deployment issues in Intune.\n7-Zip-25.01-x64-install.log Reviewing 7-Zip-25.01-x64-install.log will reveal the following two entries:\nHost Application: C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe -NoProfile -ExecutionPolicy Bypass -File C:\\Windows\\IMECache\\6e0911dd-6755-4eb7-8a75-ba02e685232b_1\\ea57d2d6-fb24-45a9-a0d0-638eb33b93f4.ps1\nAlthough the script is named Install_7Zip_2501.ps1 in Intune because the Intune Management Extension executes it under a GUID-based name:\n[Win32App] lpExitCode 0\nWhich is the final confirmation that the installation completed successfully, an exit code of 0 means the installer returned success and Intune accepted the result. Combined with the custom transcript log this is the definitive confirmation that the Win32 app deployment ran as expected.\nImportant: The IME renames the script internally, this is why searching the logs for the keyword Install_7Zip_2501.ps1 returns nothing, since the IME only tracks the GUID-based filename.\nAppWorkload.log The following entries from AppWorkload.log show the complete execution flow for my Win32 app using a PowerShell script installer:\n1. Policy Received Intune confirms that a Win32 app assignment was received for the user and session, this is the moment the device becomes aware that work needs to be done:\n[Win32App] Got 1 Win32App(s) for user e297c863-88ff-465c-a24c-8c124a3b35d3 in session 1\n2. App Details \u0026amp; Script Reference Intune loads the full app definition: detection rules, install and uninstall commands, requirements, return codes and the associated PowerShell script.\nAt this stage you can already see the script referenced by its internal GUID and not by the friendly name shown in the Intune portal:\nGet policies = [{\u0026ldquo;Id\u0026rdquo;:\u0026ldquo;6e0911dd-6755-4eb7-8a75-ba02e685232b\u0026rdquo;,\u0026ldquo;Name\u0026rdquo;:\u0026ldquo;GBL-WIN11-7z2501-x64\u0026rdquo;,\u0026ldquo;Version\u0026rdquo;:1,\u0026ldquo;Intent\u0026rdquo;:1,\u0026ldquo;TargetType\u0026rdquo;:1,\u0026ldquo;AppApplicabilityStateDueToAssginmentFilters\u0026rdquo;:null,\u0026ldquo;AssignmentFilterIds\u0026rdquo;:null,\u0026ldquo;DetectionRule\u0026rdquo;:\u0026quot;[{\u0026quot;DetectionType\u0026quot;:2,\u0026quot;DetectionText\u0026quot;:\u0026quot;{\\\u0026quot;Path\\\u0026quot;:\\\u0026quot;C:\\\\\\\\Program Files\\\\\\\\7-zip\\\u0026quot;,\\\u0026quot;FileOrFolderName\\\u0026quot;:\\\u0026quot;7z.exe\\\u0026quot;,\\\u0026quot;Check32BitOn64System\\\u0026quot;:false,\\\u0026quot;DetectionType\\\u0026quot;:4,\\\u0026quot;Operator\\\u0026quot;:5,\\\u0026quot;DetectionValue\\\u0026quot;:\\\u0026quot;25.01.00.0\\\u0026quot;}\u0026quot;}]\u0026quot;,\u0026ldquo;InstallCommandLine\u0026rdquo;:\u0026ldquo;msiexec /i \u0026quot;7z2501-x64.msi\u0026quot; /qn\u0026rdquo;,\u0026ldquo;UninstallCommandLine\u0026rdquo;:\u0026ldquo;msiexec /x \u0026quot;{23170F69-40C1-2702-2501-000001000000}\u0026quot; /qn\u0026rdquo;,\u0026ldquo;RequirementRules\u0026rdquo;:\u0026quot;{\u0026quot;RequiredOSArchitecture\u0026quot;:32,\u0026quot;MinimumFreeDiskSpaceInMB\u0026quot;:null,\u0026quot;MinimumWindows10BuildNumer\u0026quot;:\u0026quot;10.0.26100\u0026quot;,\u0026quot;MinimumMemoryInMB\u0026quot;:null,\u0026quot;MinimumNumberOfProcessors\u0026quot;:null,\u0026quot;MinimumCpuSpeed\u0026quot;:null,\u0026quot;RunAs32Bit\u0026quot;:false}\u0026quot;,\u0026ldquo;ExtendedRequirementRules\u0026rdquo;:\u0026quot;[]\u0026quot;,\u0026ldquo;InstallEx\u0026rdquo;:\u0026quot;{\u0026quot;RunAs\u0026quot;:1,\u0026quot;RequiresLogon\u0026quot;:true,\u0026quot;InstallProgramVisibility\u0026quot;:3,\u0026quot;MaxRetries\u0026quot;:3,\u0026quot;RetryIntervalInMinutes\u0026quot;:5,\u0026quot;MaxRunTimeInMinutes\u0026quot;:60,\u0026quot;DeviceRestartBehavior\u0026quot;:1}\u0026quot;,\u0026ldquo;ReturnCodes\u0026rdquo;:\u0026quot;[{\u0026quot;ReturnCode\u0026quot;:0,\u0026quot;Type\u0026quot;:1},{\u0026quot;ReturnCode\u0026quot;:1707,\u0026quot;Type\u0026quot;:1},{\u0026quot;ReturnCode\u0026quot;:3010,\u0026quot;Type\u0026quot;:2},{\u0026quot;ReturnCode\u0026quot;:1641,\u0026quot;Type\u0026quot;:3},{\u0026quot;ReturnCode\u0026quot;:1618,\u0026quot;Type\u0026quot;:4}]\u0026quot;,\u0026ldquo;AvailableAppEnforcement\u0026rdquo;:1,\u0026ldquo;SetUpFilePath\u0026rdquo;:\u0026ldquo;7z2501-x64.msi\u0026rdquo;,\u0026ldquo;ToastState\u0026rdquo;:0,\u0026ldquo;Targeted\u0026rdquo;:1,\u0026ldquo;FlatDependencies\u0026rdquo;:null,\u0026ldquo;MetadataVersion\u0026rdquo;:4,\u0026ldquo;RelationVersion\u0026rdquo;:0,\u0026ldquo;RebootEx\u0026rdquo;:{\u0026ldquo;GracePeriod\u0026rdquo;:-1,\u0026ldquo;Countdown\u0026rdquo;:-1,\u0026ldquo;Snooze\u0026rdquo;:-1},\u0026ldquo;InstallBehavior\u0026rdquo;:0,\u0026ldquo;StartDeadlineEx\u0026rdquo;:{\u0026ldquo;TimeFormat\u0026rdquo;:\u0026quot;\u0026quot;,\u0026ldquo;StartTime\u0026rdquo;:\u0026quot;/Date(-62135596800000)/\u0026quot;,\u0026ldquo;Deadline\u0026rdquo;:\u0026quot;/Date(-62135596800000)/\u0026quot;},\u0026ldquo;RemoveUserData\u0026rdquo;:false,\u0026ldquo;DOPriority\u0026rdquo;:1,\u0026ldquo;newFlatDependencies\u0026rdquo;:true,\u0026ldquo;AssignmentFilterIdToEvalStateMap\u0026rdquo;:null,\u0026ldquo;ContentCacheDuration\u0026rdquo;:null,\u0026ldquo;ESPConfiguration\u0026rdquo;:null,\u0026ldquo;ReevaluationInterval\u0026rdquo;:480,\u0026ldquo;SupportState\u0026rdquo;:null,\u0026ldquo;InstallContext\u0026rdquo;:1,\u0026ldquo;InstallerData\u0026rdquo;:null,\u0026ldquo;AvailableAppRequestType\u0026rdquo;:0,\u0026ldquo;ContentMode\u0026rdquo;:1,\u0026ldquo;Scripts\u0026rdquo;:\u0026quot;[{\u0026quot;Id\u0026quot;:\u0026quot;ea57d2d6-fb24-45a9-a0d0-638eb33b93f4\u0026quot;,\u0026quot;Type\u0026quot;:1,\u0026quot;Data\u0026quot;:null,\u0026quot;EnforceSignatureCheck\u0026quot;:false}]\u0026quot;}]\n3. Status: Installing The device reports back its enforcement status error code of 0 which indicates a clean execution path with no failures reported by the installer:\n[StatusService] Returning status to user with id: e297c863-88ff-465c-a24c-8c124a3b35d3 for V3-managed app with id: 6e0911dd-6755-4eb7-8a75-ba02e685232b and install context: System. Applicability: Applicable, Status: Installed, ErrorCode: 0\n4. Script Downloaded The Intune Management Extension downloads the PowerShell script from Microsoft’s CDN. This confirms the script is treated as separate content, not embedded inside the app payload:\n[Win32App] ExternalCDN mode, content raw URL is https://swdsw02-mscdn.manage.microsoft.com/85ae9e0a-4b2b-4097-918d-3108be0d0efd/1ed98657-e1ec-4e51-a6f4-d2aa6f2b8ef6/ea57d2d6-fb24-45a9-a0d0-638eb33b93f4.ps1.gz.bin\n5. Script Decrypted \u0026amp; Extracted The downloaded script is decrypted and written to the IME cache under a GUID-based filename, this is the file that will actually be executed:\n[Win32App] Decompressed: to C:\\Windows\\IMECache\\6e0911dd-6755-4eb7-8a75-ba02e685232b_1/ea57d2d6-fb24-45a9-a0d0-638eb33b93f4.ps1\n6. Script Executed Finally, the IME launches PowerShell and executes the script from the cache location using a controlled command line with execution policy bypassed:\n[Win32App] Installer script command line: \u0026ldquo;C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe\u0026rdquo; -NoProfile -ExecutionPolicy Bypass -File \u0026ldquo;C:\\Windows\\IMECache\\6e0911dd-6755-4eb7-8a75-ba02e685232b_1\\ea57d2d6-fb24-45a9-a0d0-638eb33b93f4.ps1\u0026rdquo;\nFinal Validation via Registry State As a last troubleshooting step you can validate the app state directly from the registry too.\nIntune stores per-user and per-app enforcement results under the Intune Management Extension hive:\nComputer\\HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\IntuneManagementExtension\\Win32Apps\\e297c863-88ff-465c-a24c-8c124a3b35d3\\6e0911dd-6755-4eb7-8a75-ba02e685232b_1\\ComplianceStateMessage\nThe ComplianceStateMessage value contains a JSON object that summarizes how Intune evaluated the deployment:\nComplianceStateMessage: {\u0026ldquo;Applicability\u0026rdquo;:0,\u0026ldquo;ComplianceState\u0026rdquo;:1,\u0026ldquo;DesiredState\u0026rdquo;:2,\u0026ldquo;ErrorCode\u0026rdquo;:null,\u0026ldquo;TargetingMethod\u0026rdquo;:0,\u0026ldquo;InstallContext\u0026rdquo;:2,\u0026ldquo;TargetType\u0026rdquo;:1,\u0026ldquo;ProductVersion\u0026rdquo;:null,\u0026ldquo;AssignmentFilterIds\u0026rdquo;:null}\nIn my case:\nApplicability 0 means the app was applicable to the device. ComplianceState 1 means the app is compliant. DesiredState 2 means the app is expected to be present. ErrorCode being null confirms no errors were reported. This combination confirms a successful required deployment that is installed and compliant.\nUnderstanding the State Values App deployment Type (Intent): Values Description 1 Available 3 Required 4 Uninstall Compliance State: Values Description 0 Unknown 1 Compliant 2 Not compliant 3 Conflict (Not applicable for app deployment) 4 Error Desired State: Values Description 0 None 1 NotPresent 2 Present 3 Unknown 4 Available ","date":"2026-01-15","permalink":"https://halfoncloud.com/posts/powershell-script-for-intune-win32-apps/","tags":["MSIntune","PowerShell","Win32"],"title":"PowerShell script installer for Win32 apps Guide"},{"categories":["Cloud"],"contents":"Background and Intent Declarative Device Management (DDM) represents a fundamental architectural shift in how Microsoft Intune manages devices. This article brings those pieces together, it combines verified information with hands-on testing performed on a Windows 11 25H2 virtual machine, along with practical PowerShell checks you can use to validate DDM behavior on real devices.\nThe focus is on Windows (MMP-C / WinDC), while also highlighting where the Windows implementation differs from other platforms.\nShort Summary If you only need the essentials:\nTraditional management (OMA-DM)\nIntune continuously pushes settings to the device on a schedule, the device applies them, waits and receives the same instructions again at the next sync.\nDeclarative management (DDM)\nIntune declares the desired end state once, the device understands that state, monitors itself and corrects any drift automatically.\nWhat you need to do\nNothing, the transition is handled by Microsoft and is transparent to administrators.\nUnderstanding the Current State: OMA-DM Before understanding DDM, we need to understand what it replaces.\nWhat is OMA-DM? OMA-DM (Open Mobile Alliance Device Management) is a protocol originally designed for mobile phones that Microsoft adopted for Windows 10/11 management. It uses SyncML (XML-based) for communication between the Intune service (DM Server) and the device (DM Client).\nThe OMA-DM Command Set Command Function Get Retrieve value from a node in the Management Tree Add Create new node or configuration Replace Modify existing value Delete Remove node or configuration Exec Execute predefined function on device Copy Replicate subtree structure OMA-DM Workflow Model Server queries state, sends commands and verifies result, this loop repeats constantly for every policy. The traditional model follows a repetitive cycle every 8 hours.\nProblems with OMA-DM Chatty network traffic, every policy requires full GET-SET-GET cycle Slow policy application, hundreds of policies = hundreds of cycles Settings can drift between check-ins No offline enforcement capability If one step fails the chain breaks How DDM Changes This DDM (Declarative Device Management) works on a fundamentally different model:\nThe Declarative Model Instead of repeatedly telling the device what to do, DDM tells the device once what it should look like, the device then maintains that state autonomously.\nAspect OMA-DM DDM/MMP-C Protocol Type Imperative, transactional Declarative, state-based Communication Model Push-Pull Pull-only Communication Medium SyncML (XML) MOF document Trigger Server-initiated (WNS) or 8h client 4h client-initiated State Awareness Stateless State-aware, maintains desired state Remediation Manual (new command needed) Automatic (self-healing) Offline Enforcement No Yes Self-Healing: The Killer Feature With DDM, if a user or malware changes a setting, WinDC service detects drift (within seconds), auto-corrects from local cached desired state, works even when device is offline and no cloud check-in required.\nWindows DDM Architecture Key Components MMP-C (Microsoft Management Platform - Cloud) A new management plane designed for speed, reliability, and scale. It adds a parallel channel optimized for declarative workloads alongside traditional OMA-DM.\nWinDC (Windows Declared Configuration) The Windows service that receives, processes and enforces declarative configurations.\nService Name: dcsvc (Declared Configuration Service)\nWinDC Client Stack Components Component Role WinDC Agent Entry point for MMP-C payloads, pulls desired state and parses MOF documents PolicyManager Central orchestrator evaluates current vs desired state and determines changes CSPs Apply settings when invoked by PolicyManager State Repository Stores current + desired state locally enables drift detection Reporting Engine Sends compliance/status data back to Intune Dual Enrollment Architecture Windows 11 devices maintain two parallel enrollments:\nEnrollment Type ProviderID Channel Purpose Type 6 MS DM Server OMA-DM Legacy policies, broad CSP coverage Type 26 Microsoft Device Management MMP-C/WinDC Declarative workloads Note: This dual enrollment is automatic for all Intune-enrolled Windows devices.\nVerifying DDM on Windows Devices The following commands have been tested and verified on a Windows 11 Enterprise 25H2 (Build 26200.7462):\n1. MDM Services Check the three key services involved in MDM/DDM:\nGet-Service -Name \u0026#34;dmwappushservice\u0026#34;, \u0026#34;DmEnrollmentSvc\u0026#34;, \u0026#34;dcsvc\u0026#34; -ErrorAction SilentlyContinue | Select-Object Name, DisplayName, Status, StartType | Format-Table -AutoSize Another quick health check is to look at the core services used by MDM and Declared Configuration.\nThere are three services that matter:\ndmwappushservice should be running and set to Automatic, it handles push notifications that trigger device syncs. DmEnrollmentSvc is only used during enrollment, on an already enrolled device it is normally Stopped and set to Manual. dcsvc is the Declared Configuration service, it runs only when DDM work is needed, so Stopped with Manual start is expected most of the time. Note: Seeing the last two services stopped does not indicate a problem, this is normal behavior on a healthy enrolled device.\n2. Enrollment Information View all enrollments with provider information:\nGet-ItemProperty \u0026#34;HKLM:\\SOFTWARE\\Microsoft\\Enrollments\\*\u0026#34; -ErrorAction SilentlyContinue | Where-Object { $_.ProviderID } | Select-Object PSChildName, ProviderID, EnrollmentType, UPN | Format-Table -AutoSize Key Enrollment Types to Look For:\nEnrollmentType ProviderID Purpose 6 MS DM Server Traditional Intune MDM (OMA-DM) 26 Microsoft Device Management DDM enrollment (MMP-C) 12 WMI_Bridge_SCCM_Server SCCM co-management (if present) 30 Deploy Authority Autopilot/provisioning 31 Cloud Authority Azure AD/cloud trust 28 Local Authority Local device authority You can also confirm DDM support by reviewing the device’s enrollment records. This shows how the device is managed and which management channels are active.\nOn a properly enrolled Intune device you should see multiple enrollment entries, the important ones are:\nEnrollment type 6 represents classic Intune MDM using OMA-DM. Enrollment type 26 represents modern DDM enrollment used by Declared Configuration. Seeing both entries together is expected and indicates that the device supports both management models. Other enrollment types may appear depending on Autopilot, co-management or local authority and their presence is normal.\nNote: If type 26 is missing, Declared Configuration is not active on that device even if other MDM components appear healthy.\n3. DeclaredConfiguration CSP Registration Verify the DDM CSP is registered:\nGet-ChildItem \u0026#34;HKLM:\\SOFTWARE\\Microsoft\\Provisioning\\CSPs\u0026#34; -Recurse -ErrorAction SilentlyContinue | Where-Object { $_.Name -like \u0026#34;*DeclaredConfiguration*\u0026#34; } | Get-ItemProperty | Select-Object PSPath, csp_version DeclaredConfiguration is a modern MDM CSP that isn’t always visible in the registry. Even if HKLM:\\SOFTWARE\\Microsoft\\Provisioning\\CSPs shows nothing, the CSP can still be fully supported and functional.\nThe paths like .\\Device\\Vendor\\MSFT\\DeclaredConfiguration and .\\User\\Vendor\\MSFT\\DeclaredConfiguration are logical CSP URIs, not guaranteed registry keys. On newer Windows builds many CSPs are exposed dynamically by the MDM engine and never written to disk.\nNote: Registry presence is not a reliable way to validate DeclaredConfiguration support, the only real proof is successful policy processing on a supported Windows build.\n4. DDM Scheduled Tasks Check the DDM scheduled tasks and their run history:\nGet-ScheduledTask | Where-Object { $_.TaskName -like \u0026#34;*Declared*\u0026#34; } | ForEach-Object { $task = $_ $info = $_ | Get-ScheduledTaskInfo [PSCustomObject]@{ TaskName = $task.TaskName State = $task.State LastRunTime = $info.LastRunTime NextRunTime = $info.NextRunTime LastResult = \u0026#39;0x{0:X}\u0026#39; -f $info.LastTaskResult } } | Format-Table -AutoSize You can also validate DeclaredConfiguration by checking its scheduled tasks and their run history. These tasks are created by the DDM engine and are responsible for enforcing and re-applying settings over time.\nNormally you should see two tasks, both tasks should exist and be in a Ready state:\nA refresh task that periodically checks for configuration drift and re-applies settings. A watchdog task that enforces configuration less frequently and ensures long-term compliance. When reviewing run results:\n0x0 means the task ran successfully. 0x8000FFFF usually means the DDM engine is present but not actively receiving policies yet, which is common before any DeclaredConfiguration payload is assigned. What DDM Currently Handles As of January 2026 DDM is used for some specific workloads:\nFeature Delivery Method Endpoint Privilege Management (EPM) DDM/MMP-C Advanced Device Inventory DDM/MMP-C MDA Attach V2 DDM/MMP-C Most configuration policies OMA-DM (migrating gradually) Win32 apps IME (unchanged) Scripts IME (unchanged) What DDM (MMP-C) Currently Handles\nEndpoint Privilege Management (EPM) is delivered through the modern channel (MMP-C/WinDC), not traditional OMA-DM SyncML delivery. EPM uses the declarative pipeline for policy enforcement. Advanced Device Inventory (Properties Catalog) leverages MMP-C with richer telemetry delivered via the declarative document model. MDA Attach V2 (Device Management Attach) does not have broad authoritative documentation explicitly tying it to “only DDM”. There is no clear Microsoft doc stating MDA Attach V2 only runs over MMP-C at this time. Most configuration policies today are still delivered via OMA-DM and Policy CSPs, Microsoft is gradually expanding declarative management coverage. Win32 app deployment and PowerShell script execution (IME) remain outside DDM/MMP-C, they use the Intune Management Extension. Note: Microsoft is gradually migrating more policy types to DDM, the transition is automatic and transparent to administrators.\nChannel Distribution on Windows Current approximate distribution of Intune management channels:\nChannel Percentage Examples OMA-DM ~80% Most configuration policies, compliance Intune Management Extension (IME) ~15% Win32 apps, PowerShell scripts, remediations DDM (MMP-C/WinDC) ~5% EPM, Device Inventory Important: These are not official telemetry figures from Microsoft, the precise percentage split (~80/15/5) is not documented by Microsoft and should be presented as an informed industry estimate rather than a firm metric! General reality:\nOMA-DM remains dominant for most traditional configuration policies in production today. MMP-C/Declared Configuration is progressively rolling out and handling an increasing set of workloads (starting with EPM and advanced inventory). IME continues to be the delivery path for Win32 apps and script-based tasks. ","date":"2026-01-14","permalink":"https://halfoncloud.com/posts/microsoft-intune-declarative-device-management-ddm/","tags":["MSIntune","DDM","MMP-C","WinDC"],"title":"Microsoft Intune Declarative Device Management (DDM) Guide"},{"categories":["Cloud"],"contents":"Why Naming Conventions Matter Before diving into \u0026ldquo;Conditional Access\u0026rdquo; policies and Intune configurations, I need to quickly explain the naming convention I use throughout my tenant. This might seem boring but getting this right early saves you a lot of trouble later.\nIf you’re new to Intune chances are your first policies will probably look similar to these ones:\nBitlocker Policy Win10 - Security Settings GBL - W10 - Something - PRD test policy delete later Yes they might get the job done quick but they lack to communicate purpose, scope or lifecycle, adding more only increases your technical debt.\nAfter some research I\u0026rsquo;ve adopted a structured naming convention that scales from 10 to 10000 devices, so here is how it looks in my tenant\nNote: Feel free to use this as a baseline and adjust the logic to align with your own tenant requirements \u0026amp; unique infrastructure needs!\nPosition Field Options Purpose 1 Join Type A = Azure AD, H = Hybrid Determines Autopilot profile 3-4 Country/Site RO, BE, DE, FR, US, etc. Location-specific policies 6 User Type U = User, A = Admin Determines local admin rights 8 Ring D = Dev, C = Canary, P = Production Update/deployment ring 10 Device Type L = Laptop, D = Desktop, S = Shared, K = Kiosk Device category Examples A-RO-U-P-L = Azure AD, Romania, User, Production, Laptop A-RO-A-C-D = Azure AD, Romania, Admin, Canary, Desktop H-RO-U-P-L = Hybrid, Romania, User, Production, Laptop A-RO-U-D-L = Azure AD, Romania, User, Development, Laptop Naming Convention Overview Core Principles Consistency: Same pattern across all object types Scalability: Works for 10 or 10,000 devices Clarity: Immediate understanding without clicking No spaces: Use hyphens for readability Abbreviations: Standardized and documented Key Prefixes Prefix Meaning Usage GBL Global Tenant-wide policies (all countries/sites) RO Romania Country-specific policies BE Belgium Country-specific policies DE Germany Country-specific policies GRP Group All Entra ID groups Platform Codes Code Platform WIN11 Windows 11 (and Windows 10) iOS iOS/iPadOS AND Android macOS macOS Ring Codes Code Ring Purpose (DEV) Development IT testing, Windows Insider, early adopters (CAN) Canary Pilot users, one per department (PRD) Production All other users, stable releases (ALL) All Rings Applies to everyone regardless of ring I\u0026rsquo;ve named my applications to follow this pattern, instead of using generic names like \u0026ldquo;Company Portal\u0026rdquo; or \u0026ldquo;Microsoft Teams\u0026rdquo;, each app now clearly identifies its scope and platform:\nGroups Groups follow a simpler pattern: GRP-[Type]-[Purpose]\nNotice the mix of Dynamic and Assigned membership types, Dynamic groups automatically populate based on device attributes, no manual management required.\nThe GRP-Devices-Development-Hardware and GRP-Devices-Development-VM groups separate physical test machines from virtual machines which is useful when certain policies behave differently, for example in VMware or Hyper-V environments:\nDynamic Group Rules Here\u0026rsquo;s where GroupTags become powerful, each Autopilot device gets a GroupTag during enrollment that encodes its characteristics.\nThe rule (device.devicePhysicalIds -any (_ -contains \u0026quot;[OrderId]:A-RO-U-P-\u0026quot;)) automatically captures all devices with a GroupTag starting with A-RO-U-P- (Azure AD joined, Romania, User, Production).\nGroupTag structure: [JoinType]-[Country]-[UserType]-[Ring]-[DeviceType]: this eliminates manual group assignments entirely, devices land in the correct groups automatically based on how they were enrolled:\nIntune naming convention value This is where the naming convention really proves its value.\nThe naming convention for my Compliance policy makes it obvious that this targets Windows 11 devices in production:\nAs for my Configuration profiles, with 24 policies, imagine trying to find the right one without consistent naming, so now I can immediately identify:\nWhat each policy configures (BitLocker, Defender, EdgeUpdates) Which ring it targets (DEV, CAN, PRD, ALL) The policy type (Settings catalog, ADMX, Endpoint security) I\u0026rsquo;ll cover these policies in detail in future articles, but for now this demonstrates how the naming convention scales:\nWhat\u0026rsquo;s Next With naming conventions established, the next article covers in detail the \u0026ldquo;Conditional Access\u0026rdquo; policies and the actual security controls protecting the tenant.\n","date":"2025-01-11","permalink":"https://halfoncloud.com/posts/m365-business-premium-part-4-intune-naming-conventions-and-standards/","tags":["MSIntune","M365","EntraID"],"title":"M365 Business Premium Part 4: Naming Conventions and Standards"},{"categories":["Cloud"],"contents":"Security Before Enrollment Users should have MFA configured before they enroll devices, Conditional Access policies need to be in place before onboarding begins too.\nGet this right and you have minor interruptions during onboarding, get it wrong and you\u0026rsquo;ll be fielding angry phone calls. This matches what I experienced in the past, having CA policies and authentication methods configured before Autopilot enrollment made the process smooth.\nThe Real Threat Landscape Microsoft blocks an average of ~7,000 password attacks per second, Cyberattacks strike at an unprecedented scale, with Microsoft recording approximately ~600 million blocked threat attempts every 24 hours. This volume represents an increase in hostile actions, creating a threat environment where malicious packets slam into networks nearly every second.\nSource: \u0026ldquo;Microsoft Digital Defense Report 2025\u0026rdquo; https://www.microsoft.com/en-us/corporate-responsibility/dmc/en-us/corporate-responsibility/cybersecurity/microsoft-digital-defense-report-2025/\n80-90% of successful ransomware compromises originate through unmanaged devices. This is exactly why device compliance and Conditional Access matter, blocking unmanaged devices cuts off a major attack vector.\nThe good news: most successful cyberattacks could be stopped with basic security hygiene.\nThe 99% Rule Basic security hygiene still protects against 99% of attacks. The five fundamentals are:\nEnable MFA Apply Zero Trust principles Use XDR and antimalware Keep systems up to date Protect data What Are You Protecting? Focus on what matters to the organization: sensitive information, device security, encryption and malware protection.\nFew years ago I stumble across this quote worth remembering: \u0026ldquo;Try not to make it a dictatorship\u0026rdquo;!\nSecurity that\u0026rsquo;s too restrictive gets bypassed, the goal is protection without killing productivity.\nEntra Admin Center Overview The Entra admin center gives you a quick snapshot of your tenant. Here you can see my tenant HalfOnCloud with the primary domain devworkplace.cloud and a Entra ID P1 licensing.\nTenant Properties The Properties tab shows the tenant configuration, data is stored in EU Model Clause compliant datacenters, which matters for GDPR.\nNote: Security Defaults is blocked because Conditional Access policies are already in use in my tenant, so that\u0026rsquo;s an expected behavior.\nIdentity Secure Score The Recommendations tab shows the Identity Secure Score at the moment 50.76% which refreshes every ~24 hours.\nProbably you\u0026rsquo;ll see a couple of recommendations broken down by priority, the high-priority items include MFA for admins, blocking legacy authentication and ensuring all users can complete MFA:\nIdentity Secure Score - Status View This expanded view shows which recommendations are completed and when.\nSeveral items show \u0026ldquo;Completed\u0026rdquo; status: consent controls, multiple global admins, password expiration settings and least privileged roles.\nIdentity Secure Score - P2 Requirements Scrolling down reveals items that require higher licensing. \u0026ldquo;Protect all users with a sign-in risk policy\u0026rdquo; and \u0026ldquo;Protect all users with a user risk policy\u0026rdquo; both need Entra ID P2, same with Defender for Identity deployment.\nNote: These will be address in the future with the addition of the E5 Security add-on activation.\nNamed Locations Named locations help reduce false positives in security reports and enable location-based Conditional Access policies.\nIn my tenant I\u0026rsquo;ve configured RO-Home-HalfOnCloud as a trusted IP ranges location using my own IP public address, which in this example it\u0026rsquo;s linked to one of my existing Conditional Access policies \u0026ldquo;CA-003-Require-MFA-All-Users\u0026rdquo;:\nNamed Location Details Opening the location shows the configuration, the name follows my naming convention (Country-Context-Tenant).\nNote: The \u0026ldquo;Naming Convention\u0026rdquo; section will be addressed in a future article.\n\u0026ldquo;Mark as trusted location\u0026rdquo; is enabled with my home IP range configured, only mark locations as trusted if you genuinely control that network:\nAuthentication Methods The Authentication methods Policies blade shows all available methods:\nIn my tenant, at least for the time being, only Microsoft Authenticator, SMS, Temporary Access Pass, Software OATH tokens, Voice call and Email OTP are enabled for all users.\nPasskey (FIDO2), Hardware OATH tokens, Certificate-based authentication and QR code are disabled.\nNote: In a hardened environment, you\u0026rsquo;d disable SMS and Voice call since they\u0026rsquo;re phishable methods, exploit human psychology through deception (social engineering) via email, phone (vishing), SMS (smishing) or fake websites.\nMicrosoft Authenticator - Enable and Target The Microsoft Authenticator settings show Enable and Target configuration.\nIt\u0026rsquo;s enabled for All users with Optional registration, authentication mode is set to \u0026ldquo;Any\u0026rdquo; which allows both push notifications and passwordless sign-in:\nMicrosoft Authenticator - Configure The Configure tab has the important security features.\n\u0026ldquo;Require number matching for push notifications\u0026rdquo; is Enabled, this prevents MFA fatigue attacks by requiring users to type a number shown on screen.\n\u0026ldquo;Show application name\u0026rdquo; and \u0026ldquo;Show geographic location\u0026rdquo; in notifications help users identify suspicious sign-in attempts:\nTemporary Access Pass Temporary Access Pass (TAP) is enabled for All users with Optional registration.\nTAP is a time-limited passcode for bootstrapping new accounts or account recovery. It\u0026rsquo;s essential for Autopilot scenarios where users need to complete Windows Hello setup before they have any other MFA method registered.\nNote: Only administrators can issue TAP codes.\nTemporary Access Pass - Configure The Configure tab shows the TAP settings I\u0026rsquo;m using. Minimum lifetime is 1 hour, maximum is 23 hours, and default is 8 hours.\nThe important setting here is \u0026ldquo;One-time\u0026rdquo; set to No. One-time TAP codes break Intune enrollment because the code expires after first use and Autopilot needs multiple authentications during setup:\nTemporary Access Pass - Edit Settings This is how the edit panel for TAP configuration looks, you can set lifetime in Minutes, Hours or Days.\nI\u0026rsquo;ve configured 1 hour minimum, 23 hours maximum and 8 hours default, Length is 8 characters. \u0026ldquo;Require one-time use\u0026rdquo; is set to No for the Autopilot compatibility reason mentioned above:\nPassword Protection Password protection helps prevent weak and predictable passwords, Smart lockout is configured with 10 failed attempts before lockout and 60 seconds lockout duration.\nI\u0026rsquo;ve enabled a custom banned password list with organization-specific terms, for example: halfoncloud, devworkplace, intune, bucharest, romania, Password, Welcome etc.. These are words attackers would likely try first.\nNote: Password protection for Windows Server Active Directory is disabled since this is a cloud-only environment.\nAuthentication Strengths Authentication strengths let you define which MFA methods are acceptable for different scenarios. You can use built-in strengths or create custom ones.\nI have one custom strength called \u0026ldquo;SecInfo-Registration-Secure\u0026rdquo;, plus the three built-in options: Multifactor authentication, Passwordless MFA and Phishing-resistant MFA.:\nCustom Authentication Strength This shows my custom \u0026ldquo;SecInfo-Registration-Secure\u0026rdquo; authentication strength. It solves the chicken-and-egg problem where users need MFA to register their MFA methods.\nThe allowed methods are Windows Hello for Business, Passkeys (FIDO2), Certificate-based Authentication, and Temporary Access Pass (both one-time and multi-use). This lets new users authenticate with a TAP code to set up their permanent MFA method.\nNote: The Phishing-resistant custom MFA is linked to a Microsoft-managed policy, which will be addressed in another article.\nPassword Reset - Properties Self-service password reset is enabled for All users.\nThe blue banner is important: \u0026ldquo;Admins are always enabled for SSPR and require two authentication methods to reset their password\u0026rdquo;.\nThis page links to Authentication methods, Registration, Notifications and other SSPR settings:\nPassword Reset - Authentication Methods Users need 1 method to reset their password, also Security questions are available as an option.\nFor my tenant I\u0026rsquo;ve configured 5 questions required to register and 4 questions required to reset. The banner reminds us that admins always need 2 methods regardless of this setting:\nPassword Reset - Registration Users are required to register when signing in, this ensures everyone has SSPR methods configured before they actually need them.\nRe-confirmation is set to 180 days, so users verify their authentication info every 6 months.\nPassword Reset - Notifications Both notification options are enabled. Users get notified when their password is reset and all admins get notified when any admin resets their password.\nThe admin notification is a security feature, it helps detect if someone has compromised an admin account and is resetting passwords:\nPassword Reset - Administrator Policy This read-only page shows the administrator-specific SSPR policy. Admins always have SSPR enabled and always require 2 methods to reset.\nAvailable methods for admins include Email, Mobile phone (SMS), Mobile phone (voice), Office phone, Mobile app code and Mobile app notification.\nNote: Security questions are not available for admins as they\u0026rsquo;re weak authentication, admins typically use stronger methods.\nUser Settings User settings control what regular users can do in the tenant, hence I\u0026rsquo;ve disabled several self-service options.\nUsers cannot register applications or create security groups, Non-admin users are restricted from creating tenants, Guest user access is set to the most restrictive option, Access to the Entra admin center is restricted and LinkedIn account connections are disabled:\nExternal Collaboration Settings This page controls guest user behavior. Guest user access restrictions are set to the most restrictive option, guests can only see their own directory objects.\nFor guest invites, only users with specific admin roles can invite guests. Self-service sign up via user flows is disabled, External users can remove themselves from the organization. Collaboration restrictions allow invitations to any domain for now:\nGroups - General Settings Group settings control self-service group management, Owners can manage group membership requests in My Groups.\nUsers cannot create security groups or Microsoft 365 groups via Azure portals, API, or PowerShell.\nNote: This prevents shadow IT and keeps group management centralized with admins.\nEnterprise Applications The Enterprise applications blade shows applications using your tenant as an identity provider, currently in my tenant there\u0026rsquo;s only one: \u0026ldquo;Microsoft Graph Command Line Tools\u0026rdquo;\nNote: This was created on November 26, 2025 when I\u0026rsquo;ve first connected with the Microsoft Graph PowerShell module. As you add more integrations and consent to apps, they\u0026rsquo;ll appear here.\nUser Consent Settings User consent for applications is set to \u0026ldquo;Do not allow user consent\u0026rdquo;, this means an administrator must approve all apps that request access to organizational data.\nNote: This is more restrictive than the recommended \u0026ldquo;Allow user consent for apps from verified publishers\u0026rdquo; but prevents users from accidentally granting permissions to malicious apps:\nAdmin Consent Settings The admin consent workflow is enabled. When users try to access an app they can\u0026rsquo;t consent to, they can request admin approval.\nOne user is configured as a reviewer, Email notifications and expiration reminders are enabled.\nNote: Consent requests expire after 30 days if not acted upon.\nAdmin Consent Request Reviewers This shows the reviewer selection for admin consent requests, here I\u0026rsquo;ve selected my own user as the reviewer.\nNote: Only users with Global Administrator, Application Administrator or Cloud Application Administrator roles can actually grant admin consent. Other reviewers can review, block or deny requests:\nAdmin Consent Requests Queue This is where pending consent requests appear, currently there are no pending requests.\nWhen users request access to apps they can\u0026rsquo;t consent to themselves, the requests show up here. Reviewers can approve (grant consent), block (disable the app) or deny (ignore the request) from this queue:\nWhat\u0026rsquo;s Next In the next part, I\u0026rsquo;ll cover Conditional Access policies in detail, the actual policies I\u0026rsquo;ve implemented, how they work together and the lessons learned from testing them.\nI\u0026rsquo;ll also walk through the Microsoft Intune prerequisites you need before enrolling your first device.\n","date":"2025-01-10","permalink":"https://halfoncloud.com/posts/m365-business-premium-part-3-entraid-security-best-practices/","tags":["MSIntune","M365","EntraID","Security"],"title":"M365 Business Premium Part 3: Entra ID Security Best Practices"},{"categories":["Cloud"],"contents":"First Look at the Tenant After completing the purchase and the initial MFA setup, you land in the Microsoft 365 admin center. First thing I did here was to check my Admin account under Users \u0026gt; Active users.\nEverything looks correct: Global Administrator role assigned, MFA configured, and the default HalfOnCloud.onmicrosoft.com domain attached to my account.\nOrganization Settings Next stop is Settings \u0026gt; Org settings. This is where you configure tenant-wide options.\nThere are three tabs here: Services, Security \u0026amp; privacy and Organization profile.\nI started with Organization profile to set the basics.\nOrganization Information Under Organization information, you set your technical contact. This is the email address that receives service notifications from Microsoft.\nImportant to set this to someone who actually monitors emails!\nThe sold-to address is pulled from your billing info, so that\u0026rsquo;s already filled in from the purchase (I had to remove mine due to security concerns)\nRelease Preferences This one matters if you want early access to new features. Microsoft offers three options:\nStandard release - Features roll out when Microsoft considers them ready for everyone Targeted release for everyone - Your whole tenant gets features early Targeted release for select users - Only specific users get early features I went with targeted release for select users and added my admin account. This way I can test new features before they hit the rest of the organization. In a production environment, you\u0026rsquo;d add your IT team here.\nData Location Worth checking where Microsoft stores your data. Since I\u0026rsquo;m in Europe, my tenant data sits in European Union/EFTA datacenters for Exchange, Teams \u0026amp; SharePoint.\nNote the \u0026ldquo;Advanced Data Residency\u0026rdquo; section is a paid add-on for stricter data residency controls.\nNot available in all regions and not necessary for most small businesses!\nSecurity and Privacy Settings Switching to the Security \u0026amp; privacy tab.\nThis is where you find password policies, session timeouts, and other security-related tenant settings.\nPassword Expiration Policy Microsoft now recommends setting passwords to never expire which might sound counterintuitive, but the reasoning is solid: forced password changes lead to users picking weaker passwords or just incrementing a number at the end.\nCombined with MFA (which I\u0026rsquo;ve already set up), non-expiring passwords are actually more secure than the old \u0026ldquo;change every 90 days\u0026rdquo; approach.\nIdle Session Timeout I enabled idle session timeout and set it to 12 hours which signs off users out of Microsoft 365 web apps after a period of inactivity.\nThe balance here is security versus convenience, 12 hours means users won\u0026rsquo;t get logged out during a normal workday, but an unattended machine overnight will require re-authentication.\nAdjust this based on your environment, high-security environments might want 1-4 hours, but for a small business 12 hours is reasonable.\nSelf-Service Password Reset SSPR lets users reset their own passwords without calling IT.\nThis is configured in the Entra ID portal, the link takes you directly there.\nNote: I\u0026rsquo;ll cover SSPR setup in a later post when we configure Entra ID settings.\nDomains A quick look at the Domains section, right now I only have the default HalfOnCloud.onmicrosoft.com domain, which Microsoft creates automatically.\nIn a real deployment, you\u0026rsquo;d add your company\u0026rsquo;s custom domain here, this involves adding DNS records to verify ownership.\nAdding a Custom Domain Time to add a real domain, for my tenant I\u0026rsquo;ve acquired a separate new domain called \u0026ldquo;devworkplace.cloud\u0026rdquo;\nUsing the default onmicrosoft.com address works too but it looks unprofessional for an email so I\u0026rsquo;m adding devworkplace.cloud as my custom domain.\nAdd a custom domain you already own and enter your domain name (without www or http)\nDomain Verification Options Microsoft needs to verify you actually own this domain, the recommended method is adding a TXT record to your DNS.\nThere are other options if your registrar doesn\u0026rsquo;t support TXT records, but TXT is the cleanest approach.\nThe TXT Record Details Microsoft gives you the exact values to add. In my case:\nTXT name: @ (or leave blank depending on your registrar) TXT value: MS=ms83647650 TTL: 3600 Copy these values exactly and please note that the MS= code is unique to your tenant!\nAdding the TXT Record at Your Host Provider Now switch to your domain registrar, find the DNS zone editor and add a new TXT record with the values Microsoft provided above.\nSelect your custom domain and Edit the DNS zone:\nHere\u0026rsquo;s what it looks like in domain registrar DNS management:\nType is TXT, name is @, value is the MS= string from Microsoft and TTL is 3600\nDomain Verified - Connection Options Once Microsoft verifies the TXT record, you move to the connection phase. This is where you decide how to set up DNS for Microsoft services.\nI chose \u0026ldquo;Add your own DNS records\u0026rdquo; because I want full control over my DNS configuration.\nThe other option lets Microsoft manage everything, but that means pointing your nameservers to Microsoft which I don\u0026rsquo;t want for a domain that also hosts a website.\nRequired DNS Records for Exchange Here\u0026rsquo;s where it gets detailed, Microsoft lists all the DNS records needed for email to work properly.\nFor Exchange Online, you need the following three records:\nMX record: Routes incoming email to Microsoft CNAME record: autodiscover for email client configuration TXT record: SPF record to prevent email spoofing Adding the MX Record Back in the domain registrar, add an MX record pointing to Microsoft\u0026rsquo;s mail servers.\nThe value is devworkplace-cloud.mail.protection.outlook.com with priority 0 and TTL 3600:\nAdding the Autodiscover CNAME The autodiscover CNAME helps email clients like Outlook automatically find the correct server settings. Name is \u0026ldquo;autodiscover\u0026rdquo;, target is \u0026ldquo;autodiscover.outlook.com\u0026rdquo; and TTL 3600:\nAdding the SPF Record SPF tells receiving mail servers that Microsoft is authorized to send email on behalf of your domain.\nThis is critical for email deliverability, without it your emails might land in spam folders!\nThe value is: \u0026ldquo;v=spf1 include:spf.protection.outlook.com -all\u0026rdquo; and TTL 3600:\nAdvanced Options - Intune and DKIM If you\u0026rsquo;re planning to use Intune for device management (which we are), check \u0026ldquo;Intune and Mobile Device Management for Microsoft 365\u0026rdquo;.\nThis adds two more CNAME records.\nI\u0026rsquo;ve also enabled DKIM (DomainKeys Identified Mail) which adds email signing for better deliverability and security.\nDKIM requires two additional CNAME records.\nIntune CNAME Records For Intune device enrollment to work with your custom domain, add these two CNAME records:\nenterpriseregistration → enterpriseregistration.windows.net enterpriseenrollment → enterpriseenrollment-s.manage.microsoft.com These allow devices to automatically discover your Intune tenant during enrollment.\nDKIM CNAME Records DKIM records are longer and look messy, but they\u0026rsquo;re important. You need two selector records that point to Microsoft\u0026rsquo;s DKIM signing infrastructure.\nThe names are:\nselector1-devworkplace-cloud._domainkey.HalfOnCloud.n-v1.dkim.mail.microsoft\nselector2-devworkplace-cloud._domainkey.HalfOnCloud.n-v1.dkim.mail.microsoft\nNote: The values are unique to your tenant!\nDomain Setup Complete After adding all the DNS records and giving them time to propagate (usually a few minutes, sometimes up to an hour), Microsoft verifies everything and marks the domain as complete.\nFinal Domain Configuration Back in the Domains list, you now see your custom domain alongside the original onmicrosoft.com domain.\nI\u0026rsquo;ve set devworkplace.cloud as the default, which means new users will automatically get email addresses @devworkplace.cloud instead of @HalfOnCloud.onmicrosoft.com.\nBoth domains show as Healthy, which means all DNS records are correctly configured!\nWith the custom domain configured, the tenant is now properly set up for professional use.\nUsers can have email addresses like RaduBogdan@devworkplace.cloud instead of the long onmicrosoft.com addresses.\n","date":"2025-01-09","permalink":"https://halfoncloud.com/posts/m365-business-premium-part-2-configuring-new-tenant/","tags":["MSIntune","M365","Licensing"],"title":"M365 Business Premium Part 2: Configuring the new tenant"},{"categories":["Cloud"],"contents":"Choosing the Right Plan Microsoft offers three main business tiers: Basic, Standard, and Premium. For this blog and my testing environment, I went with \u0026ldquo;Business Premium\u0026rdquo; because it\u0026rsquo;s the only one that includes Intune and Entra ID P1. If you need device management and Conditional Access, the other two won\u0026rsquo;t cut it.\nThe pricing shows $22/user/month for annual billing. I started with monthly to test things out first.\nReal World Pricing in Europe Microsoft publishes prices in USD, but if you\u0026rsquo;re in Europe you pay in local currency plus VAT, the difference is significant.\nI\u0026rsquo;m based in Romania, so here\u0026rsquo;s what the actual costs look like in my region:\nBusiness Premium runs about 29 EUR per user per month with VAT included. That\u0026rsquo;s what I pay for this blog\u0026rsquo;s test tenant. It aligns with typical EU pricing where VAT gets added on top of the base rate.\nE3 is listed at €37.70 per user per month before VAT on Microsoft\u0026rsquo;s Romanian pricing page. Once VAT is applied, you\u0026rsquo;re looking at roughly 45 to 50 EUR per month per user. That\u0026rsquo;s about 1.5 times what Business Premium costs.\nE5 is listed at €59.70 per user per month before VAT. With VAT included, expect around 70 to 75 EUR per user per month. That\u0026rsquo;s roughly 2.5 times the Business Premium price.\nFrom a pure cost perspective: Business Premium at around 29 EUR is competitive and practical for small teams. E3 at 45 to 50 EUR is a meaningful jump that only makes sense if you genuinely need the enterprise management and recovery features. E5 at 70 to 75 EUR is a significant investment that\u0026rsquo;s typically only practical when advanced security automation or compliance tools become necessary.\nA note about \u0026ldquo;Microsoft Teams\u0026rdquo; in the EU: Microsoft previously sold Enterprise plans (E3/E5) without Teams in the EEA due to competition regulations. As of November 2025, customers worldwide can again purchase suites with Teams included. Business plans like Business Premium were not affected and have always included Teams. If you\u0026rsquo;re buying Enterprise plans without Teams, expect to pay about €8 less per user, with Teams available as a separate standalone.\nhttps://www.microsoft.com/en-us/microsoft-365/blog/2025/09/12/evolving-our-productivity-offerings-to-resolve-european-competition-concerns-about-teams/\nStarting the Purchase After clicking \u0026ldquo;Buy now\u0026rdquo; on Business Premium, you land on the subscription setup page. Here you pick how many users, subscription length, and billing frequency.\nI chose 1 user and monthly billing. Yes, monthly costs more per month, but I wanted flexibility while setting everything up. You can always switch to annual later once you\u0026rsquo;re committed.\nCreating Your Admin Account This is where you create your first Global Administrator account. The username you pick here will be your primary admin login, and the domain defaults to yourcompany.onmicrosoft.com.\nIn my case: RaduBogdan@HalfOnCloud.onmicrosoft.com\nStore these credentials somewhere safe. This is your \u0026ldquo;break glass\u0026rdquo; account for when things go wrong. Password manager, secure notes, whatever you use. Just don\u0026rsquo;t lose it.\nPayment Details Standard payment form. Credit card, billing address, the usual. Microsoft accepts Visa, Mastercard, and Amex.\nNote that it says \u0026ldquo;You won\u0026rsquo;t be charged until you buy something\u0026rdquo; which confused me at first. They mean the trial period if you selected one, otherwise you get charged immediately after completing the order.\nOrder Review Final confirmation before purchase. Check the price, quantity, payment method, and billing address. The total here showed €29.91 including tax for monthly billing in my region.\nThe fine print mentions you can cancel within 7 days for a prorated refund. After that, no refunds. Also worth noting: Global, Billing, and Reader admin roles will automatically get access to the billing account.\nOrder Confirmed Done. Order is placed and Microsoft immediately asks you to set up MFA. This is not optional anymore, Microsoft enforces it for all new admin accounts.\nThe \u0026ldquo;Action required\u0026rdquo; box tells you to set up Microsoft Authenticator. You can use other authenticator apps, but Microsoft pushes their own.\nSetting Up MFA Microsoft walks you through the Authenticator setup. Download the app if you don\u0026rsquo;t have it, then follow the prompts.\nThe process is straightforward: open the app, add a work account, scan the QR code (not shown here), and approve the test notification.\nMFA Complete Once the authenticator is linked, you\u0026rsquo;re done with the initial security setup. This becomes your default sign-in method going forward.\nWhat\u0026rsquo;s Next At this point you have an active M365 Business Premium subscription and a secured admin account. The next steps would be accessing the admin center, adding a custom domain, and starting to configure the tenant.\nI\u0026rsquo;ll cover those in the next post.\n","date":"2025-01-08","permalink":"https://halfoncloud.com/posts/m365-business-premium-purchase-part-1/","tags":["MSIntune","M365","Licensing"],"title":"M365 Business Premium Part 1: Purchase and Tenant Setup"},{"categories":["Cloud"],"contents":"The Question Everyone Asks When you start looking at Microsoft 365 subscriptions, the licensing matrix feels designed to confuse you. Business Premium, E3, E5, add-ons, standalone plans. Microsoft doesn\u0026rsquo;t make this easy, does it?\nFor a small business with 10 to 20 users, the question is straightforward: do you actually need E3 or E5, or is Business Premium enough?\nAfter working with these plans and testing them in real environments, I can give you a direct answer. For most small businesses, Business Premium is not just enough. It\u0026rsquo;s the right choice.\nWhat Business Premium Actually Gives You Business Premium is not a stripped-down version of the enterprise plans. It\u0026rsquo;s a complete package built specifically for small and medium businesses, with a cap at 300 users.\nIn a single license you get the full Microsoft 365 productivity suite including Exchange Online, Teams, OneDrive, and SharePoint. You get Intune Plan 1 for device management and app deployment. You get Entra ID Premium P1 which means Conditional Access and proper MFA enforcement. You get Defender for Business for endpoint protection with EDR capabilities. And you get Defender for Office 365 Plan 1 for email security.\nThat\u0026rsquo;s not a starter pack. That\u0026rsquo;s a complete security and management platform. The kind of setup that would have required multiple products and significant budget just a few years ago now comes bundled in one SKU.\nIncludes Office apps, email, Teams, OneDrive, SharePoint, etc. Intune Plan 1 basic device management and compliance policies. Entra ID Premium P1 identity and access control (MFA, Conditional Access). Information Protection \u0026amp; Defender for Business endpoint protection and basic threat defense. Focused on SMB security \u0026amp; management with a ~300 users cap. The Security Question This is where people get nervous. They assume Business Premium must have gaps because it costs less than the enterprise plans.\nHere\u0026rsquo;s the reality: Business Premium protects against the threats that actually hit small businesses. Phishing attempts get blocked by MFA and Conditional Access. Malware and ransomware get caught by Defender for Business. Unmanaged devices get blocked by Intune compliance policies. Unauthorized access gets stopped before it starts.\nThe tools are designed to work without a dedicated security team watching dashboards all day. You just need to configure them properly, set your policies and they do their job.\nWhat matters more than the license tier is whether you actually use what you have. An E5 subscription with default settings is less secure than a properly configured Business Premium tenant. I\u0026rsquo;ve seen it happen.\nAs for subscription comparison, I\u0026rsquo;ve used this great site: https://m365maps.com/matrix.htm#000001000001001000000\nWhere Business Premium Stops Business Premium is optimized for control and baseline security. It doesn\u0026rsquo;t try to be everything.\nYou won\u0026rsquo;t get Intune Plan 2 features like Advanced Analytics or Remote Help. There\u0026rsquo;s no Endpoint Privilege Management for removing local admin rights at scale. No Cloud PKI for certificate automation. No Windows Enterprise features like Autopatch or Quick Machine Recovery. And no Security Copilot for AI-assisted threat hunting.\nThese aren\u0026rsquo;t accidental omissions. They\u0026rsquo;re enterprise features designed for environments with hundreds or thousands of devices, dedicated IT teams, and complex compliance requirements. At 10 to 20 users, you probably don\u0026rsquo;t need them yet.\nHow E3 Changed Recently Microsoft quietly upgraded what E3 includes. It\u0026rsquo;s no longer just Office plus compliance tools.\nE3 now includes Intune Plan 2 with Remote Help and Advanced Analytics. It includes Windows Enterprise E3 with Autopatch readiness and better recovery options. The gap between Business Premium and E3 has widened on the management and recovery side.\nE3 makes sense when device count grows, when recovery time becomes critical, and when you need deeper visibility into what\u0026rsquo;s happening across your fleet. It\u0026rsquo;s the step up when scale starts to matter.\nBut here\u0026rsquo;s what catches people off guard: E3 doesn\u0026rsquo;t automatically include the security features many assume it has. Defender for Business is actually a Business Premium thing. With E3, you often need additional security add-ons to match what Business Premium includes out of the box.\nWhat E3 includes:\nAll Office apps, email, Teams, OneDrive, SharePoint and enterprise storage. Intune Plan 1 (same basic Intune as Business Premium). Entra ID Premium P1 same foundational identity as Business Premium. Enterprise features such as larger mailboxes, Windows Enterprise rights, and broader compliance controls. When E5 Actually Makes Sense E5 is not about getting more features. It\u0026rsquo;s about reducing risk in environments where risk is already high.\nYou move to E5 when you\u0026rsquo;re dealing with privileged access sprawl across your organization. When you need certificate lifecycle management at scale. When your security team needs AI-assisted investigation tools. When compliance and audit requirements demand advanced retention and forensic capabilities.\nIf those problems don\u0026rsquo;t sound familiar, E5 is probably overkill. It\u0026rsquo;s powerful, but most of that power sits unused in small business environments.\nWhat E5 includes:\nAll E3 capabilities plus multiple advanced security and compliance tools. Entra ID Premium P2 (advanced identity protection and governance). More advanced Defender services, Cloud App Security, and tools like Insider Risk Management. Power BI Pro, Teams Phone system, and expanded analytics. The Practical Decision For a small business starting fresh today, Business Premium makes the most sense. It delivers modern identity security, proper device management, and solid endpoint protection without unnecessary complexity. You can actually manage it without hiring dedicated security staff.\nYou should consider moving to E3 when your user count pushes past the 300 limit, when enterprise recovery features become important, or when you need the analytics capabilities that come with Intune Plan 2.\nYou should consider E5 when security operations become a full-time job, when compliance requirements demand advanced tooling, or when you\u0026rsquo;re actively dealing with the kind of threats that need investigation capabilities beyond what standard tools provide.\nUntil you hit those points, Business Premium is not a compromise. In my opinion, it\u0026rsquo;s the optimized choice.\nWhy I Started Here For this blog, I deliberately chose Business Premium as my testing ground. Not because it was cheaper, but because it reflects what most real environments actually run.\nEnterprise features are impressive on paper, but they don\u0026rsquo;t teach you how Microsoft 365 management actually works day to day. Business Premium does. The skills and patterns you build here transfer directly to larger environments later.\nThink of it this way: Business Premium teaches you how modern Microsoft cloud management works. E3 shows you how it scales. E5 shows you how it\u0026rsquo;s defended when things go seriously wrong.\nThis progression matches how most IT careers actually develop. Start with the fundamentals, build real experience, then move up when the problems demand it.\n","date":"2025-01-07","permalink":"https://halfoncloud.com/posts/m365-business-premium-purchase-introduction/","tags":["MSIntune","M365","Licensing","EntraID"],"title":"Microsoft 365 Business Premium vs E3 vs E5"},{"categories":["General"],"contents":"Who I Am I\u0026rsquo;m Radu, an IT professional working mostly with Microsoft technologies. My days are spent somewhere between on-prem infrastructure and cloud services, which is exactly where the name \u0026ldquo;HalfOnCloud\u0026rdquo; comes from. Not fully in the cloud, not stuck in the past but somewhere in between, like most real environments.\nMy main areas are Microsoft SCCM/ConfigMgr, Intune, Azure, Entra ID and Microsoft 365. I also work with VMware for virtualization and PowerShell for pretty much everything else. If it can be automated I\u0026rsquo;ll definetely try to.\nWhat This Blog Is This isn\u0026rsquo;t a polished knowledge base or a collection of perfect tutorials. It\u0026rsquo;s more like my technical journal, a place where I document what I learn, what breaks and what actually works in production.\nYou\u0026rsquo;ll find step-by-step guides based on things I\u0026rsquo;ve actually implemented, PowerShell scripts I use in real environments, troubleshooting notes from problems that took way too long to solve and occasional opinions on tools and approaches that I\u0026rsquo;ve tested myself.\nSome posts will be detailed walkthroughs, others might be short notes so I don\u0026rsquo;t forget how I fixed something. My goal here is practical and reproducible, not theoretical.\nWhy I Started Writing Honestly? Because I kept solving the same problems twice. I\u0026rsquo;d fix something, move on, then six months later face the same issue and have to figure it out again. Writing it down forces me to understand it properly and gives me something to reference later.\nIf other people find it useful, that\u0026rsquo;s a bonus. But this blog exists first for future me, and second for anyone else working with these technologies who might be stuck on the same problems.\nThe Journey I don\u0026rsquo;t have all the answers. I\u0026rsquo;m learning as I go, just like everyone else in IT. Some of what I write today might be outdated or improved tomorrow which is totally fine. This blog is a snapshot of where I am in my technical journey, not a claim to expertise.\nIf you spot something wrong or know a better way, I\u0026rsquo;d genuinely like to hear it. The best solutions usually come from the community, not from one person figuring everything out alone.\nThank you for stopping by.\n","date":"2025-01-07","permalink":"https://halfoncloud.com/posts/welcome-to-halfoncloud/","tags":["About"],"title":"Welcome to HalfOnCloud"},{"categories":null,"contents":"Hi, I\u0026rsquo;m Radu IT professional specializing in Microsoft technologies: SCCM, Intune, Azure, EntraID, and M365. I also work with VMware for virtualization.\nThis blog is where I share tutorials, automation scripts, and insights from my daily work.\n","date":"2025-01-01","permalink":"https://halfoncloud.com/about/","tags":null,"title":"About"}]